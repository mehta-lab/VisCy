# Codebase Structure

**Analysis Date:** 2026-02-07

## Directory Layout

```
VisCy/
├── .github/               # GitHub workflows and issue templates
├── .planning/             # GSD planning documents (this file's parent)
│   └── codebase/          # Generated codebase analysis documents
├── packages/              # Workspace members (uv workspace)
│   └── viscy-transforms/  # Image transforms package
│       ├── src/
│       │   └── viscy_transforms/   # Transform implementations
│       ├── tests/                   # Pytest test suite
│       ├── docs/
│       │   └── examples/           # Example notebooks
│       └── pyproject.toml           # Package config + dependencies
├── src/                   # Umbrella viscy package (minimal)
│   └── viscy/
│       └── __init__.py    # Version metadata only
├── scripts/               # Utility scripts directory (currently empty)
├── pyproject.toml         # Workspace root configuration
├── uv.lock                # Locked dependencies (uv)
├── CITATION.cff           # Citation metadata (Zenodo)
├── LICENSE                # BSD-3-Clause license
├── README.md              # Main project documentation
└── CONTRIBUTING.md        # Development guidelines
```

## Directory Purposes

**packages/:**
- Purpose: Root directory for uv workspace members
- Contains: Independent packages that can be versioned and published separately
- Key files: Each package has own `pyproject.toml` with version tags (e.g., `viscy-transforms-`)

**packages/viscy-transforms/src/viscy_transforms/:**
- Purpose: Main implementation directory for image transforms library
- Contains: 22+ transform modules, type definitions, utilities
- Key files:
  - `__init__.py`: Public API exports (all 40+ classes/functions)
  - `_typing.py`: Type definitions (Sample, NormMeta, HCSStackIndex, etc.)
  - Individual transform files: `_crop.py`, `_flip.py`, `_normalize.py`, etc.

**packages/viscy-transforms/tests/:**
- Purpose: Pytest test suite for viscy-transforms package
- Contains: Unit tests for all major transforms, fixtures, conftest
- Pattern: One test file per major transform class (e.g., `test_flip.py`, `test_crop.py`)
- Key files:
  - `conftest.py`: Pytest fixtures (device, seed)
  - `test_*.py`: Parametrized tests for each transform

**packages/viscy-transforms/docs/examples/:**
- Purpose: Jupyter notebooks demonstrating transform usage
- Contains: Example notebooks for learning and benchmarking
- Key files: `batched_transforms.ipynb` (GPU performance comparison)

**src/viscy/:**
- Purpose: Umbrella package that ties subpackages together
- Contains: Minimal code (only version metadata)
- Used by: Package imports like `from viscy import __version__`

**.planning/codebase/:**
- Purpose: Generated documentation for codebase analysis
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md
- Generated by: GSD mapper agent, consumed by planner/executor

## Key File Locations

**Entry Points:**
- `packages/viscy-transforms/pyproject.toml`: Package metadata, dependencies, test config
- `packages/viscy-transforms/src/viscy_transforms/__init__.py`: Public API (40+ exports)
- `src/viscy/__init__.py`: Umbrella package version only
- `pyproject.toml`: Workspace root config, member declaration, Ruff linting rules

**Configuration:**
- `pyproject.toml`: Build system, dependencies, dev groups, Ruff linting config
- `packages/viscy-transforms/pyproject.toml`: viscy-transforms specific config
- `.pre-commit-config.yaml`: Git pre-commit hooks (linting, formatting)
- `uv.lock`: Locked dependency versions

**Core Transform Logic:**
- `packages/viscy-transforms/src/viscy_transforms/_crop.py`: Batched spatial cropping
- `packages/viscy-transforms/src/viscy_transforms/_flip.py`: Batched random flips
- `packages/viscy-transforms/src/viscy_transforms/_normalize.py`: Normalization with precomputed stats
- `packages/viscy-transforms/src/viscy_transforms/_percentile_scale.py`: GPU percentile-based scaling
- `packages/viscy-transforms/src/viscy_transforms/_noise.py`: Batched Gaussian noise on GPU
- `packages/viscy-transforms/src/viscy_transforms/_scale_intensity.py`: Intensity scaling
- `packages/viscy-transforms/src/viscy_transforms/_affine.py`: Affine transforms (Kornia)
- `packages/viscy-transforms/src/viscy_transforms/_zoom.py`: Batched zoom/resize
- `packages/viscy-transforms/src/viscy_transforms/_elastic.py`: 3D elastic deformations
- `packages/viscy-transforms/src/viscy_transforms/_stack_channels.py`: Multi-channel composition

**Type Definitions:**
- `packages/viscy-transforms/src/viscy_transforms/_typing.py`: TypedDict definitions for Sample, NormMeta, ChannelMap, HCSStackIndex

**MONAI Integration:**
- `packages/viscy-transforms/src/viscy_transforms/_monai_wrappers.py`: Re-exported MONAI transforms with explicit signatures
- `packages/viscy-transforms/src/viscy_transforms/_decollate.py`: Custom decollate utility

**Testing:**
- `packages/viscy-transforms/tests/conftest.py`: Pytest fixtures (device, seed)
- `packages/viscy-transforms/tests/test_*.py`: Unit tests (flip, crop, noise, contrast, zoom, etc.)

**Documentation:**
- `README.md`: Project overview, installation, links to Cytoland and DynaCLR
- `CONTRIBUTING.md`: Development setup, guidelines, pre-commit setup
- `packages/viscy-transforms/README.md`: Package-specific install and usage
- `packages/viscy-transforms/docs/examples/batched_transforms.ipynb`: Benchmark notebook

## Naming Conventions

**Files:**
- Transform files: `_<transform_name>.py` (leading underscore for private implementation)
  - Example: `_crop.py`, `_flip.py`, `_normalize.py`
- Test files: `test_<transform_name>.py` (one per transform or feature group)
  - Example: `test_flip.py`, `test_crop.py`, `test_transforms.py`
- Module exports are re-imported in `__init__.py` without underscore

**Functions/Classes:**
- Transform classes: `PascalCase` for both tensor and dictionary variants
  - Tensor variant: `BatchedRandFlip` (operates on Tensor)
  - Dictionary variant: `BatchedRandFlipd` (operates on dict, suffix `d` per MONAI convention)
- Internal/private: Leading underscore (e.g., `_match_image()`, `_normalize()`)
- Parent classes: Match MONAI conventions (RandomizableTransform, MapTransform)

**Variables/Parameters:**
- Transform parameters: `snake_case` (e.g., `roi_size`, `random_center`, `spatial_axes`)
- Type hints: PascalCase for classes, `|` for unions (Python 3.10+)
- Dict keys: snake_case (e.g., `"norm_meta"`, `"source"`, `"target"`)

**Types:**
- TypedDict classes: `PascalCase` with "Meta", "Stats", "Map" suffixes
  - Example: `NormMeta`, `LevelNormStats`, `ChannelMap`, `HCSStackIndex`
- Generic type var: `T` (single letter, imported from typing)

## Where to Add New Code

**New Transform Class:**
1. Create file: `packages/viscy-transforms/src/viscy_transforms/_<transform_name>.py`
2. Implement both tensor and dictionary versions:
   - Tensor version inherits from `Transform` or `RandomizableTransform`
   - Dictionary version inherits from `MapTransform`, calls tensor version internally
3. Pattern to follow:
   - Copy structure from `_flip.py` (paired batch-aware classes)
   - If wrapping MONAI: use pattern from `_monai_wrappers.py`
   - Add docstrings with Parameters/Returns sections (Numpy style per `pyproject.toml`)
4. Export in: `packages/viscy-transforms/src/viscy_transforms/__init__.py`
5. Add tests: `packages/viscy-transforms/tests/test_<transform_name>.py`
6. Run: `pytest packages/viscy-transforms/tests/test_<transform_name>.py`

**New Type Definition:**
1. Add to: `packages/viscy-transforms/src/viscy_transforms/_typing.py`
2. Use TypedDict if structure is fixed, dict if flexible
3. Export in `__all__` at top of file
4. Re-export if needed in main `__init__.py`

**New Utility Function:**
1. Add to existing file if closely related to a transform
2. Otherwise create: `packages/viscy-transforms/src/viscy_transforms/_utils.py`
3. Prefix with underscore if internal only
4. Export in `__init__.py` if public API

**New Documentation:**
1. Notebooks go in: `packages/viscy-transforms/docs/examples/`
2. README updates: `packages/viscy-transforms/README.md` (package-specific) or main `README.md`
3. Code comments: Follow Numpy docstring style (configured in Ruff)

**New Test:**
1. File: `packages/viscy-transforms/tests/test_<module>.py`
2. Fixtures from `conftest.py` (device, seed)
3. Use pytest parametrize for testing multiple configurations
4. Run full suite: `pytest packages/viscy-transforms/tests/` or `pytest` from root

## Special Directories

**uv.lock:**
- Purpose: Frozen dependency versions across workspace
- Generated: By `uv lock` command
- Committed: Yes, for reproducible builds
- Edit: Never manually; run `uv lock` to update

**__pycache__/:**
- Purpose: Python bytecode cache
- Generated: Automatically by Python
- Committed: No (in .gitignore)
- Edit: Never; delete with `find . -type d -name __pycache__ -exec rm -r {} +`

**.git/:**
- Purpose: Git version control history
- Generated: `git init` or `git clone`
- Committed: N/A (contains git objects)
- Edit: Use git commands only

**pyc/egg-info/:**
- Purpose: Build artifacts
- Generated: By `pip install -e .` or build tools
- Committed: No (in .gitignore)
- Edit: Never; clean with `rm -rf *.egg-info`

---

*Structure analysis: 2026-02-07*
