---
phase: 09-ci-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/test.yml
autonomous: true

must_haves:
  truths:
    - "Push to main or PR triggers viscy-data base test jobs (3 OS x 3 Python)"
    - "Push to main or PR triggers viscy-data extras test job (1 OS x 1 Python)"
    - "alls-green check job aggregates viscy-data results alongside viscy-transforms results"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "CI test workflow with viscy-transforms and viscy-data jobs"
      contains: "test-data"
  key_links:
    - from: "check job needs"
      to: "test-data, test-data-extras"
      via: "needs: [test, test-data, test-data-extras]"
      pattern: "needs:.*test-data"
---

<objective>
Extend the existing GitHub Actions test workflow with viscy-data CI jobs.

Purpose: Ensure every push/PR automatically tests viscy-data across platforms and Python versions, with tiered coverage (base deps broad, full extras narrow).
Output: Updated `.github/workflows/test.yml` with three new jobs and updated alls-green aggregation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/test.yml
@packages/viscy-data/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add viscy-data base and extras test jobs to test.yml</name>
  <files>.github/workflows/test.yml</files>
  <action>
Edit `.github/workflows/test.yml` to add two new jobs after the existing `test` job and before the existing `check` job:

**Job 1: `test-data`** (base dependency tests, 3x3 matrix)
Follow the exact same pattern as the existing `test` job but for viscy-data:
- `name: Test Data (Python ${{ matrix.python-version }}, ${{ matrix.os }})`
- Same `strategy` block: `fail-fast: true`, matrix of 3 OS (ubuntu-latest, macos-latest, windows-latest) x 3 Python (3.11, 3.12, 3.13)
- Same steps: checkout, setup-uv (same caching pattern with cache-suffix), install deps, run tests
- Install command: `uv sync --frozen --all-extras --dev` with `working-directory: packages/viscy-data`
- Test command: `uv run --frozen pytest --cov=viscy_data --cov-report=term-missing` with `working-directory: packages/viscy-data`

**Job 2: `test-data-extras`** (full extras verification, narrow matrix)
- `name: Test Data Extras (Python 3.13, ubuntu-latest)`
- `runs-on: ubuntu-latest` (no matrix, single runner)
- Same steps as test-data but:
  - Python version hardcoded to `3.13`
  - Install command: `uv sync --frozen --all-extras --dev` with `working-directory: packages/viscy-data`
  - Test command: `uv run --frozen pytest --cov=viscy_data --cov-report=term-missing -m "not slow"` with `working-directory: packages/viscy-data`
  - Note: Since the base test-data already uses `--all-extras`, the extras job differentiates by running on a single OS/Python combo. This validates the full extras matrix without 9x cost. The `-m "not slow"` marker is a convention placeholder; if no tests are marked slow, all tests run (which is fine).

Actually, on review: the existing `test` job for viscy-transforms uses `--all-extras` too. The pattern here is:
- `test-data` = broad matrix (3x3) with all extras and dev deps — validates cross-platform, cross-Python compatibility
- `test-data-extras` = narrow matrix (1x1) with all extras — this can be used later when extras-specific tests are added with markers

Simplification: Since viscy-data `--all-extras` includes triplet, livecell, mmap, keep both jobs using `--all-extras`. The differentiation is matrix breadth (3x3 vs 1x1). For the extras job, just run the full test suite on a single combo. This is the same as transforms but gives a separate signal.

REVISED simpler approach: Only add the `test-data` job (3x3 matrix, same as transforms). Then add `test-data-extras` as a single-combo job (ubuntu-latest, Python 3.13) that installs with `--all-extras` and runs all tests. Both use `uv sync --frozen --all-extras --dev`. The extras job exists as a distinct CI signal and can later diverge (e.g., extras-only test markers).

**Update `check` job:**
- Change `needs: [test]` to `needs: [test, test-data, test-data-extras]`
- Rename from "All tests pass" to "All tests pass" (keep the same name, just update needs)

The final file structure should be:
```yaml
jobs:
  test:          # existing viscy-transforms job (unchanged)
  test-data:     # NEW: viscy-data 3x3 matrix
  test-data-extras:  # NEW: viscy-data 1x1 extras
  check:         # existing alls-green (updated needs)
```
  </action>
  <verify>
Run `python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"` to validate YAML syntax.

Verify with grep:
- `grep -c 'test-data' .github/workflows/test.yml` returns at least 3 (job name, needs reference, etc.)
- `grep 'needs:' .github/workflows/test.yml` shows `[test, test-data, test-data-extras]`
- `grep 'packages/viscy-data' .github/workflows/test.yml` returns at least 4 lines (2 per job x 2 jobs)
  </verify>
  <done>
test.yml contains:
1. `test-data` job with 3x3 matrix (3 OS x 3 Python) running viscy-data tests
2. `test-data-extras` job with single combo (ubuntu-latest, Python 3.13) running viscy-data tests with all extras
3. `check` job needs list includes both new jobs: `needs: [test, test-data, test-data-extras]`
4. YAML is valid and parseable
  </done>
</task>

</tasks>

<verification>
1. YAML valid: `python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"`
2. Job count: file contains exactly 4 jobs (test, test-data, test-data-extras, check)
3. Matrix correct: test-data has 3x3 matrix matching test job pattern
4. Extras job: test-data-extras uses ubuntu-latest + Python 3.13
5. Aggregation: check job needs includes all three test jobs
6. Working directories: test-data and test-data-extras both use `packages/viscy-data`
</verification>

<success_criteria>
- `.github/workflows/test.yml` has 4 jobs: test, test-data, test-data-extras, check
- test-data job runs 9 matrix combinations (3 OS x 3 Python)
- test-data-extras job runs 1 combination (ubuntu-latest, Python 3.13)
- check job aggregates all three test jobs via alls-green
- YAML parses without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-integration/09-01-SUMMARY.md`
</output>
