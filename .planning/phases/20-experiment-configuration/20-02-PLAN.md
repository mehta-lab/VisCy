---
phase: 20-experiment-configuration
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - applications/dynaclr/pyproject.toml
  - applications/dynaclr/src/dynaclr/__init__.py
  - applications/dynaclr/examples/configs/experiments.yml
autonomous: true

must_haves:
  truths:
    - "ExperimentConfig and ExperimentRegistry are importable from top-level dynaclr package"
    - "iohub and pyyaml are explicit dependencies in dynaclr pyproject.toml"
    - "An example experiments.yml file demonstrates the expected YAML structure for multi-experiment config"
    - "Full test suite passes including import from dynaclr top-level"
  artifacts:
    - path: "applications/dynaclr/pyproject.toml"
      provides: "Updated dependencies with iohub and pyyaml"
      contains: "iohub"
    - path: "applications/dynaclr/src/dynaclr/__init__.py"
      provides: "Top-level re-exports of ExperimentConfig and ExperimentRegistry"
      contains: "ExperimentConfig"
    - path: "applications/dynaclr/examples/configs/experiments.yml"
      provides: "Example YAML configuration for multi-experiment setup"
      min_lines: 20
  key_links:
    - from: "applications/dynaclr/src/dynaclr/__init__.py"
      to: "applications/dynaclr/src/dynaclr/experiment.py"
      via: "from dynaclr.experiment import ExperimentConfig, ExperimentRegistry"
      pattern: "from dynaclr\\.experiment import"
    - from: "applications/dynaclr/pyproject.toml"
      to: "iohub"
      via: "explicit dependency declaration"
      pattern: "iohub"
---

<objective>
Wire ExperimentConfig and ExperimentRegistry into the dynaclr package's public API, add explicit dependencies, and provide an example YAML configuration.

Purpose: Make the experiment configuration module discoverable via standard imports and provide a reference YAML file that users (and Phase 25 integration tests) can follow.

Output: Updated pyproject.toml, __init__.py, and example experiments.yml.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-experiment-configuration/20-CONTEXT.md
@.planning/phases/20-experiment-configuration/20-01-SUMMARY.md
@applications/dynaclr/pyproject.toml
@applications/dynaclr/src/dynaclr/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explicit dependencies and update public API</name>
  <files>
    applications/dynaclr/pyproject.toml
    applications/dynaclr/src/dynaclr/__init__.py
  </files>
  <action>
    1. In `applications/dynaclr/pyproject.toml`, add `"iohub>=0.3a2"` and `"pyyaml"` to the `dependencies` list. These are currently transitive via viscy-utils, but dynaclr.experiment directly imports from both, so they must be declared explicitly.

    2. In `applications/dynaclr/src/dynaclr/__init__.py`, add imports:
       ```python
       from dynaclr.experiment import ExperimentConfig, ExperimentRegistry
       ```
       Add both to the `__all__` list.

    3. Run `uv sync` to update the lockfile with the new explicit dependencies.
  </action>
  <verify>
    `uv run --package dynaclr python -c "from dynaclr import ExperimentConfig, ExperimentRegistry; print('OK')"` prints OK.
    `uv run --package dynaclr pytest applications/dynaclr/tests/ -v` -- all tests pass (existing + experiment tests from Plan 01).
  </verify>
  <done>ExperimentConfig and ExperimentRegistry importable from `dynaclr` top-level. All tests pass. pyproject.toml has explicit iohub and pyyaml deps.</done>
</task>

<task type="auto">
  <name>Task 2: Create example experiments YAML configuration</name>
  <files>
    applications/dynaclr/examples/configs/experiments.yml
  </files>
  <action>
    Create `applications/dynaclr/examples/configs/experiments.yml` with a realistic multi-experiment configuration demonstrating:

    - Two experiments with different organelle markers but same number of source channels
    - Positional alignment: both use Phase + one fluorescence channel, but the fluorescence channel has different names
    - condition_wells with infected/uninfected conditions and multiple replicate wells
    - Different interval_minutes between experiments (30 vs 15) to show heterogeneous time sampling
    - start_hpi values showing experiments starting at different HPI
    - Comments explaining each section and the positional alignment concept

    Example structure:
    ```yaml
    # Multi-experiment DynaCLR configuration
    # Source channels are positionally aligned:
    #   position 0 = phase channel (Phase3D in both)
    #   position 1 = fluorescence channel (GFP in exp_a, RFP in exp_b)
    experiments:
      - name: "2025_07_22_SEC61"
        data_path: "/hpc/projects/.../experiment_a.zarr"
        tracks_path: "/hpc/projects/.../experiment_a/tracks"
        channel_names: ["Phase3D", "GFP", "Mito"]
        source_channel: ["Phase3D", "GFP"]
        condition_wells:
          uninfected: ["A/1", "A/2", "A/3"]
          infected: ["B/1", "B/2", "B/3"]
        interval_minutes: 30.0
        start_hpi: 3.0
        organelle: "endoplasmic_reticulum"
        date: "2025-07-22"
        moi: 1.0

      - name: "2025_08_15_TOMM20"
        data_path: "/hpc/projects/.../experiment_b.zarr"
        tracks_path: "/hpc/projects/.../experiment_b/tracks"
        channel_names: ["Phase3D", "RFP", "StressGranules"]
        source_channel: ["Phase3D", "RFP"]
        condition_wells:
          uninfected: ["A/1", "A/2"]
          infected: ["B/1", "B/2"]
          mock: ["C/1"]
        interval_minutes: 15.0
        start_hpi: 2.0
        organelle: "mitochondria"
        date: "2025-08-15"
        moi: 0.5
    ```

    Use realistic experiment names, paths, and channel names from the reference context doc. Include a comment header explaining the file is loaded via `ExperimentRegistry.from_yaml("experiments.yml")` or referenced by `experiments_file` in the DataModule config.
  </action>
  <verify>
    File exists and is valid YAML: `uv run --package dynaclr python -c "import yaml; data = yaml.safe_load(open('applications/dynaclr/examples/configs/experiments.yml')); assert 'experiments' in data; assert len(data['experiments']) == 2; print('Valid YAML with', len(data['experiments']), 'experiments')"`
  </verify>
  <done>Example experiments.yml exists with 2 experiments demonstrating positional channel alignment, different interval_minutes, multiple conditions, and comments explaining the structure.</done>
</task>

</tasks>

<verification>
1. `uv run --package dynaclr python -c "from dynaclr import ExperimentConfig, ExperimentRegistry; print(ExperimentConfig.__dataclass_fields__.keys())"` -- shows all field names
2. `uv run --package dynaclr pytest applications/dynaclr/tests/ -v` -- all tests pass (engine + experiment)
3. `python -c "import yaml; yaml.safe_load(open('applications/dynaclr/examples/configs/experiments.yml'))"` -- valid YAML
4. `grep -q 'iohub' applications/dynaclr/pyproject.toml && echo 'iohub found'` -- dependency present
</verification>

<success_criteria>
1. `from dynaclr import ExperimentConfig, ExperimentRegistry` works
2. pyproject.toml declares iohub and pyyaml as explicit dependencies
3. Example YAML demonstrates multi-experiment config with positional channel alignment
4. Full test suite passes (all existing tests + experiment tests)
</success_criteria>

<output>
After completion, create `.planning/phases/20-experiment-configuration/20-02-SUMMARY.md`
</output>
