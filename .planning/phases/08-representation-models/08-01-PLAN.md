---
phase: 08-representation-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-models/src/viscy_models/contrastive/__init__.py
  - packages/viscy-models/src/viscy_models/contrastive/encoder.py
  - packages/viscy-models/src/viscy_models/contrastive/resnet3d.py
  - packages/viscy-models/tests/test_contrastive/__init__.py
  - packages/viscy-models/tests/test_contrastive/test_encoder.py
  - packages/viscy-models/tests/test_contrastive/test_resnet3d.py
autonomous: true

must_haves:
  truths:
    - "from viscy_models.contrastive import ContrastiveEncoder works"
    - "from viscy_models.contrastive import ResNet3dEncoder works"
    - "ContrastiveEncoder with convnext_tiny backbone produces (embedding, projection) tuple with correct shapes"
    - "ContrastiveEncoder with resnet50 backbone produces (embedding, projection) tuple (bug fixed)"
    - "ResNet3dEncoder with resnet18 backbone produces (embedding, projection) tuple with correct shapes"
    - "Forward-pass tests pass for both contrastive models"
  artifacts:
    - path: "packages/viscy-models/src/viscy_models/contrastive/encoder.py"
      provides: "projection_mlp function and ContrastiveEncoder class"
      contains: "class ContrastiveEncoder"
    - path: "packages/viscy-models/src/viscy_models/contrastive/resnet3d.py"
      provides: "ResNet3dEncoder class"
      contains: "class ResNet3dEncoder"
    - path: "packages/viscy-models/src/viscy_models/contrastive/__init__.py"
      provides: "Public re-exports for contrastive subpackage"
      contains: "ContrastiveEncoder"
    - path: "packages/viscy-models/tests/test_contrastive/test_encoder.py"
      provides: "Forward-pass tests for ContrastiveEncoder"
      contains: "test_contrastive_encoder"
    - path: "packages/viscy-models/tests/test_contrastive/test_resnet3d.py"
      provides: "Forward-pass tests for ResNet3dEncoder"
      contains: "test_resnet3d_encoder"
  key_links:
    - from: "contrastive/encoder.py"
      to: "_components/stems.py"
      via: "import StemDepthtoChannels"
      pattern: "from viscy_models._components.stems import StemDepthtoChannels"
    - from: "contrastive/resnet3d.py"
      to: "contrastive/encoder.py"
      via: "import projection_mlp"
      pattern: "from viscy_models.contrastive.encoder import projection_mlp"
    - from: "contrastive/__init__.py"
      to: "contrastive/encoder.py"
      via: "re-export ContrastiveEncoder"
      pattern: "from viscy_models.contrastive.encoder import ContrastiveEncoder"
    - from: "contrastive/__init__.py"
      to: "contrastive/resnet3d.py"
      via: "re-export ResNet3dEncoder"
      pattern: "from viscy_models.contrastive.resnet3d import ResNet3dEncoder"
---

<objective>
Migrate ContrastiveEncoder and ResNet3dEncoder to viscy-models with forward-pass tests.

Purpose: Satisfies CONT-01, CONT-02, CONT-03 requirements. Both contrastive models become importable from `viscy_models.contrastive` with comprehensive forward-pass tests.

Output: Two model files, one shared utility (projection_mlp), updated __init__.py, and test files with forward-pass verification.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-representation-models/08-RESEARCH.md
@packages/viscy-models/src/viscy_models/_components/stems.py
@packages/viscy-models/tests/conftest.py
@packages/viscy-models/tests/test_unet/test_unext2.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ContrastiveEncoder and ResNet3dEncoder to contrastive module</name>
  <files>
    packages/viscy-models/src/viscy_models/contrastive/encoder.py
    packages/viscy-models/src/viscy_models/contrastive/resnet3d.py
    packages/viscy-models/src/viscy_models/contrastive/__init__.py
  </files>
  <action>
Retrieve the original source code from pre-monorepo commit:
```
git show fe7a5da^:viscy/representation/contrastive.py
```

**encoder.py** -- Create `contrastive/encoder.py` containing:

1. `projection_mlp(in_dims, hidden_dims, out_dims) -> nn.Module` function: Copy verbatim from original. Returns `nn.Sequential(Linear, BatchNorm1d, ReLU, Linear, BatchNorm1d)`.

2. `ContrastiveEncoder(nn.Module)` class: Copy from original with these specific changes:
   - Import: `from viscy_models._components.stems import StemDepthtoChannels` (replaces `from viscy.unet.networks.unext2 import StemDepthtoChannels`)
   - Change `pretrained=True` to `pretrained=False` in `timm.create_model()` call (pure nn.Module semantics, consistent with UNeXt2 pattern). Add `pretrained` as constructor parameter with default `False`.
   - Fix ResNet50 backbone bug: Replace `encoder.head.fc.in_features` with `encoder.num_features` (timm uniform API). Keep the backbone-specific classifier reset as-is (`encoder.head.fc = nn.Identity()` for convnext, `encoder.fc = nn.Identity()` for resnet).
   - Preserve all attribute names exactly: `self.stem`, `self.encoder`, `self.projection` (state dict compatibility).
   - Preserve full NumPy-style docstring from original.
   - Preserve `forward()` return type: `tuple[Tensor, Tensor]` (embedding, projections).
   - Add `pretrained` parameter to constructor signature: `pretrained: bool = False`.

**resnet3d.py** -- Create `contrastive/resnet3d.py` containing:

1. `ResNet3dEncoder(nn.Module)` class: Copy from original with these changes:
   - Import: `from viscy_models.contrastive.encoder import projection_mlp` (sibling import)
   - Change `pretrained=True` to `pretrained=False` in `ResNetFeatures()` call. Add `pretrained` as constructor parameter with default `False`.
   - Preserve all attribute names exactly: `self.encoder`, `self.projection` (state dict compatibility).
   - Preserve full NumPy-style docstring from original.
   - Preserve `forward()` return type: `tuple[Tensor, Tensor]` (embedding, projections).

**__init__.py** -- Update `contrastive/__init__.py`:

```python
"""Contrastive learning architectures."""

from viscy_models.contrastive.encoder import ContrastiveEncoder
from viscy_models.contrastive.resnet3d import ResNet3dEncoder

__all__ = ["ContrastiveEncoder", "ResNet3dEncoder"]
```

Ensure ruff D-series docstring compliance on all files (single-line summary ending with period, blank line before description).
  </action>
  <verify>
Run: `cd /Users/eduardo.hirata/Documents/repos/VisCy && uv run --package viscy-models python -c "from viscy_models.contrastive import ContrastiveEncoder, ResNet3dEncoder; print('OK')"` succeeds.
Run: `cd /Users/eduardo.hirata/Documents/repos/VisCy && uv run --package viscy-models python -c "from viscy_models.contrastive.encoder import projection_mlp; print('OK')"` succeeds.
  </verify>
  <done>
ContrastiveEncoder and ResNet3dEncoder are importable from `viscy_models.contrastive`. projection_mlp is importable from `viscy_models.contrastive.encoder`. All state dict attribute names preserved. pretrained defaults to False. ResNet50 backbone bug fixed using `encoder.num_features`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create forward-pass tests for contrastive models</name>
  <files>
    packages/viscy-models/tests/test_contrastive/__init__.py
    packages/viscy-models/tests/test_contrastive/test_encoder.py
    packages/viscy-models/tests/test_contrastive/test_resnet3d.py
  </files>
  <action>
Create `tests/test_contrastive/__init__.py` as empty file.

**test_encoder.py** -- Forward-pass tests for ContrastiveEncoder:

1. `test_contrastive_encoder_convnext_tiny(device)`: ConvNeXt-tiny backbone, 2 channels in, 15 Z-slices, embedding_dim=768, projection_dim=128. Input: `(2, 2, 15, 64, 64)`. Assert embedding shape `(2, 768)`, projection shape `(2, 128)`. Use `model.eval()` + `torch.no_grad()`. Batch size >= 2 for BatchNorm1d.

2. `test_contrastive_encoder_resnet50(device)`: ResNet50 backbone (exercises the bug fix). 1 channel in, 15 Z-slices, embedding_dim=2048, projection_dim=128. Input: `(2, 1, 15, 64, 64)`. Assert embedding shape `(2, 2048)`, projection shape `(2, 128)`. Use `model.eval()` + `torch.no_grad()`. Batch size >= 2.

3. `test_contrastive_encoder_custom_stem(device)`: ConvNeXt-tiny with custom stem_kernel_size=(3,2,2), stem_stride=(3,2,2), in_stack_depth=9, 1ch in, embedding_dim=768, projection_dim=64. Input: `(2, 1, 9, 64, 64)`. Assert embedding shape `(2, 768)`, projection shape `(2, 64)`.

All tests: Import from `viscy_models.contrastive import ContrastiveEncoder`. Use `pretrained=False` (the default). Follow the test_unext2.py pattern (fixture `device`, torch.no_grad context, shape assertions).

**test_resnet3d.py** -- Forward-pass tests for ResNet3dEncoder:

1. `test_resnet3d_encoder_resnet18(device)`: resnet18 backbone, 1ch in, embedding_dim=512 (matches resnet18 output), projection_dim=128. Input: `(2, 1, 16, 16, 16)`. Assert embedding shape `(2, 512)`, projection shape `(2, 128)`.

2. `test_resnet3d_encoder_resnet10(device)`: resnet10 backbone, 2ch in, embedding_dim=512 (matches resnet10 output), projection_dim=64. Input: `(2, 2, 16, 16, 16)`. Assert embedding shape `(2, 512)`, projection shape `(2, 64)`.

All tests: Import from `viscy_models.contrastive import ResNet3dEncoder`. Use `model.eval()` + `torch.no_grad()`. Batch size >= 2.
  </action>
  <verify>
Run: `cd /Users/eduardo.hirata/Documents/repos/VisCy && uv run --package viscy-models pytest packages/viscy-models/tests/test_contrastive/ -v` -- all tests pass.
  </verify>
  <done>
5 forward-pass tests pass: 3 for ContrastiveEncoder (convnext_tiny, resnet50, custom stem) and 2 for ResNet3dEncoder (resnet18, resnet10). Tests verify embedding and projection output shapes with representative input configurations.
  </done>
</task>

</tasks>

<verification>
1. `uv run --package viscy-models python -c "from viscy_models.contrastive import ContrastiveEncoder, ResNet3dEncoder"` succeeds
2. `uv run --package viscy-models pytest packages/viscy-models/tests/test_contrastive/ -v` -- all 5 tests pass
3. State dict keys verified: ContrastiveEncoder has stem, encoder, projection; ResNet3dEncoder has encoder, projection
</verification>

<success_criteria>
- ContrastiveEncoder importable from `viscy_models.contrastive` with convnext_tiny and resnet50 backbone support
- ResNet3dEncoder importable from `viscy_models.contrastive` with MONAI ResNetFeatures backends
- ResNet50 backbone bug fixed (uses `encoder.num_features` instead of `encoder.head.fc.in_features`)
- 5 forward-pass tests pass covering both models with multiple configurations
- All attribute names preserved for state dict compatibility (stem, encoder, projection)
- pretrained defaults to False for pure nn.Module semantics
</success_criteria>

<output>
After completion, create `.planning/phases/08-representation-models/08-01-SUMMARY.md`
</output>
