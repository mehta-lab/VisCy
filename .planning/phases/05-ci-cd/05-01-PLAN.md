---
phase: 05-ci-cd
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/test.yml
  - .github/workflows/lint.yml
autonomous: true

must_haves:
  truths:
    - "Push to main triggers test workflow for viscy-transforms"
    - "Tests run against Python 3.11, 3.12, 3.13 on Ubuntu, macOS, Windows"
    - "uvx prek linting passes in CI"
    - "PR cannot merge unless all checks pass"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "Test matrix workflow with alls-green status check"
      contains: "re-actors/alls-green"
    - path: ".github/workflows/lint.yml"
      provides: "Lint workflow with prek and ruff format check"
      contains: "uvx prek"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "packages/viscy-transforms"
      via: "working-directory"
      pattern: "working-directory.*packages/viscy-transforms"
    - from: ".github/workflows/test.yml"
      to: "alls-green check job"
      via: "needs dependency"
      pattern: "needs.*test"
---

<objective>
Create GitHub Actions CI workflows for the viscy-transforms monorepo package.

Purpose: Enable automated testing and linting on every push and PR to ensure code quality and catch regressions early.

Output:
- `.github/workflows/test.yml` - Test matrix across Python 3.11/3.12/3.13 x Ubuntu/macOS/Windows with alls-green aggregation
- `.github/workflows/lint.yml` - Pre-commit hooks via uvx prek with ruff format check
</objective>

<execution_context>
@/Users/sricharan.varra/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sricharan.varra/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ci-cd/05-CONTEXT.md
@.planning/phases/05-ci-cd/05-RESEARCH.md
@packages/viscy-transforms/pyproject.toml
@.pre-commit-config.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test workflow with matrix and alls-green</name>
  <files>.github/workflows/test.yml</files>
  <action>
Create `.github/workflows/test.yml` with:

1. **Triggers:**
   - Push to main branch
   - Pull requests targeting main branch

2. **Concurrency:**
   - Group by workflow + ref
   - cancel-in-progress ONLY for PRs (not main): `${{ startsWith(github.ref, 'refs/pull/') }}`

3. **Test job:**
   - Matrix: os [ubuntu-latest, macos-latest, windows-latest] x python-version ["3.11", "3.12", "3.13"]
   - fail-fast: true
   - Steps:
     a. actions/checkout@v5
     b. astral-sh/setup-uv@v7 with:
        - python-version from matrix
        - enable-cache: true
        - cache-suffix: ${{ matrix.os }}-${{ matrix.python-version }}
     c. uv sync --frozen --all-extras --dev (working-directory: packages/viscy-transforms)
     d. uv run --frozen pytest --cov=viscy_transforms --cov-report=term-missing (working-directory: packages/viscy-transforms)

4. **Check job (alls-green pattern):**
   - name: "All tests pass"
   - if: always() (CRITICAL - must run even when upstream fails)
   - needs: [test]
   - runs-on: ubuntu-latest
   - Single step: re-actors/alls-green@release/v1 with jobs: ${{ toJSON(needs) }}

**Important:**
- Quote Python versions to prevent YAML float parsing: ["3.11", "3.12", "3.13"]
- Use working-directory on pytest step, not default job working-directory (sync needs root for uv.lock)
  </action>
  <verify>
Validate YAML syntax:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"
```
Check for required patterns:
- grep "re-actors/alls-green" .github/workflows/test.yml
- grep "if: always()" .github/workflows/test.yml
- grep "3.11" .github/workflows/test.yml
  </verify>
  <done>test.yml exists with 9-job matrix (3 OS x 3 Python) + alls-green check job, triggers on push/PR to main</done>
</task>

<task type="auto">
  <name>Task 2: Create lint workflow with prek and ruff format check</name>
  <files>.github/workflows/lint.yml</files>
  <action>
Create `.github/workflows/lint.yml` with:

1. **Triggers:**
   - Push to main branch
   - Pull requests targeting main branch

2. **Concurrency:**
   - Group by workflow + ref
   - cancel-in-progress ONLY for PRs: `${{ startsWith(github.ref, 'refs/pull/') }}`

3. **Lint job:**
   - runs-on: ubuntu-latest
   - Steps:
     a. actions/checkout@v5
     b. astral-sh/setup-uv@v7 with:
        - python-version: "3.13" (highest supported)
        - enable-cache: true
     c. Run prek hooks: `uvx prek run --all-files`
     d. Check formatting: `uvx ruff format --check .`

**Notes:**
- prek runs hooks from .pre-commit-config.yaml (ruff-check, ruff-format, ty)
- Separate ruff format --check ensures explicit formatting verification
- Single Python version (3.13) is sufficient for linting
  </action>
  <verify>
Validate YAML syntax:
```bash
python -c "import yaml; yaml.safe_load(open('.github/workflows/lint.yml'))"
```
Check for required patterns:
- grep "uvx prek" .github/workflows/lint.yml
- grep "ruff format --check" .github/workflows/lint.yml
  </verify>
  <done>lint.yml exists with prek and ruff format checks, triggers on push/PR to main</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **YAML validity:**
```bash
python -c "import yaml; [yaml.safe_load(open(f'.github/workflows/{f}')) for f in ['test.yml', 'lint.yml']]"
```

2. **File structure:**
```bash
ls -la .github/workflows/
# Should show: test.yml, lint.yml
```

3. **Key patterns present:**
```bash
grep -l "re-actors/alls-green" .github/workflows/*.yml
grep -l "uvx prek" .github/workflows/*.yml
grep -l "if: always()" .github/workflows/*.yml
```

4. **Matrix coverage:**
```bash
grep -A2 "python-version:" .github/workflows/test.yml
# Should show: ["3.11", "3.12", "3.13"]
```
</verification>

<success_criteria>
- [ ] `.github/workflows/test.yml` exists with valid YAML
- [ ] `.github/workflows/lint.yml` exists with valid YAML
- [ ] Test workflow has 9-job matrix (3 OS x 3 Python)
- [ ] Test workflow has alls-green check job with `if: always()`
- [ ] Lint workflow runs `uvx prek run --all-files`
- [ ] Lint workflow runs `ruff format --check .`
- [ ] Both workflows trigger on push to main and PRs to main
- [ ] Both workflows have concurrency control (cancel-in-progress for PRs only)
</success_criteria>

<output>
After completion, create `.planning/phases/05-ci-cd/05-01-SUMMARY.md`
</output>
