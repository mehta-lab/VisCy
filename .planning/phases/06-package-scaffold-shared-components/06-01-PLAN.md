---
phase: 06-package-scaffold-shared-components
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-models/pyproject.toml
  - packages/viscy-models/README.md
  - packages/viscy-models/src/viscy_models/__init__.py
  - packages/viscy-models/src/viscy_models/py.typed
  - packages/viscy-models/src/viscy_models/components/__init__.py
  - packages/viscy-models/src/viscy_models/unet/__init__.py
  - packages/viscy-models/src/viscy_models/unet/_layers/__init__.py
  - packages/viscy-models/src/viscy_models/contrastive/__init__.py
  - packages/viscy-models/src/viscy_models/vae/__init__.py
  - packages/viscy-models/tests/__init__.py
  - packages/viscy-models/tests/conftest.py
  - packages/viscy-models/tests/test_components/__init__.py
  - packages/viscy-models/tests/test_unet/__init__.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "uv sync --package viscy-models succeeds without errors"
    - "python -c 'import viscy_models' runs without import errors"
    - "viscy-models appears in uv pip list output"
  artifacts:
    - path: "packages/viscy-models/pyproject.toml"
      provides: "Package build configuration"
      contains: "name = \"viscy-models\""
    - path: "packages/viscy-models/src/viscy_models/__init__.py"
      provides: "Package entry point"
      contains: "__version__"
    - path: "packages/viscy-models/src/viscy_models/py.typed"
      provides: "PEP 561 type marker"
    - path: "packages/viscy-models/src/viscy_models/components/__init__.py"
      provides: "Shared components subpackage"
    - path: "packages/viscy-models/src/viscy_models/unet/__init__.py"
      provides: "UNet model subpackage"
    - path: "packages/viscy-models/src/viscy_models/unet/_layers/__init__.py"
      provides: "UNet layers subpackage"
    - path: "packages/viscy-models/src/viscy_models/contrastive/__init__.py"
      provides: "Contrastive model subpackage"
    - path: "packages/viscy-models/src/viscy_models/vae/__init__.py"
      provides: "VAE model subpackage"
    - path: "pyproject.toml"
      provides: "Updated workspace root with viscy-models"
      contains: "viscy-models"
  key_links:
    - from: "pyproject.toml"
      to: "packages/viscy-models/pyproject.toml"
      via: "uv workspace member auto-discovery"
      pattern: "members.*packages"
    - from: "pyproject.toml"
      to: "packages/viscy-models"
      via: "workspace source"
      pattern: "viscy-models.*workspace.*true"
---

<objective>
Create the viscy-models package scaffold within the existing uv workspace and verify it installs correctly.

Purpose: Establish the directory structure and build configuration so that subsequent plans (02, 03) can populate the package with actual module code. This mirrors the viscy-transforms scaffold from v1.0.
Output: An installable (but mostly empty) viscy-models package registered in the workspace.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-package-scaffold-shared-components/06-RESEARCH.md
@packages/viscy-transforms/pyproject.toml
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create viscy-models package directory structure and build config</name>
  <files>
    packages/viscy-models/pyproject.toml
    packages/viscy-models/README.md
    packages/viscy-models/src/viscy_models/__init__.py
    packages/viscy-models/src/viscy_models/py.typed
    packages/viscy-models/src/viscy_models/components/__init__.py
    packages/viscy-models/src/viscy_models/unet/__init__.py
    packages/viscy-models/src/viscy_models/unet/_layers/__init__.py
    packages/viscy-models/src/viscy_models/contrastive/__init__.py
    packages/viscy-models/src/viscy_models/vae/__init__.py
    packages/viscy-models/tests/__init__.py
    packages/viscy-models/tests/conftest.py
    packages/viscy-models/tests/test_components/__init__.py
    packages/viscy-models/tests/test_unet/__init__.py
  </files>
  <action>
Create the full directory tree for viscy-models following the exact same pattern as viscy-transforms.

1. **pyproject.toml**: Copy structure from `packages/viscy-transforms/pyproject.toml` and adapt:
   - name: "viscy-models"
   - description: "Neural network architectures for virtual staining microscopy"
   - keywords: ["deep learning", "microscopy", "neural networks", "pytorch", "virtual staining"]
   - dependencies: ["monai>=1.5.2", "numpy>=2.4.1", "timm>=1.0.15", "torch>=2.10"]
   - No optional-dependencies section (viscy-models has no notebook extras)
   - dependency-groups: same test group (pytest>=9.0.2, pytest-cov>=7), dev includes test
   - wheel packages: ["src/viscy_models"]
   - uv-dynamic-versioning pattern-prefix: "viscy-models-"
   - classifiers: same as viscy-transforms

2. **README.md**: Brief package description (3-5 lines). Mention it provides neural network architectures for VisCy. Note it is part of the VisCy workspace.

3. **src/viscy_models/__init__.py**: Minimal init with version from importlib.metadata. Docstring describing the package. Empty __all__ list (will be populated in Phase 10). Pattern:
   ```python
   """VisCy Models - Neural network architectures for virtual staining microscopy."""
   from importlib.metadata import version
   __version__ = version("viscy-models")
   __all__: list[str] = []
   ```

4. **py.typed**: Empty file (PEP 561 marker).

5. **Subpackage __init__.py files**: Create empty `__init__.py` for:
   - `components/__init__.py` -- docstring: "Shared architectural components."
   - `unet/__init__.py` -- docstring: "UNet family architectures."
   - `unet/_layers/__init__.py` -- docstring: "Shared layer implementations for UNet models."
   - `contrastive/__init__.py` -- docstring: "Contrastive learning architectures."
   - `vae/__init__.py` -- docstring: "Variational autoencoder architectures."

6. **Test scaffolding**:
   - `tests/__init__.py`: empty
   - `tests/conftest.py`: import pytest, add a `device` fixture that returns "cuda" if available else "cpu" (using `torch.cuda.is_available()`)
   - `tests/test_components/__init__.py`: empty
   - `tests/test_unet/__init__.py`: empty
  </action>
  <verify>
All files exist: `find packages/viscy-models -type f | sort` lists all expected files.
`python -c "import tomllib; tomllib.load(open('packages/viscy-models/pyproject.toml', 'rb'))"` parses without error.
  </verify>
  <done>All 13+ files created. pyproject.toml is valid TOML matching the viscy-transforms pattern with viscy-models specifics.</done>
</task>

<task type="auto">
  <name>Task 2: Register viscy-models in workspace and verify installation</name>
  <files>
    pyproject.toml
  </files>
  <action>
Update the root pyproject.toml to include viscy-models:

1. **Add viscy-models to project.dependencies**: Change `dependencies = ["viscy-transforms"]` to `dependencies = ["viscy-transforms", "viscy-models"]`.

2. **Add workspace source**: In `[tool.uv.sources]`, add `viscy-models = { workspace = true }` alongside the existing `viscy-transforms = { workspace = true }`.

3. **No changes needed to**: `[tool.uv.workspace]` (already has `members = ["packages/*"]` which auto-discovers), `[tool.ruff]` (already has `src = ["packages/*/src"]`), `[tool.pytest]` (already has `testpaths = ["packages/*/tests", "tests"]`).

4. **Run lockfile update**: `uv lock` to resolve the new workspace member and its dependencies (timm will be added to lockfile).

5. **Install the package**: `uv sync --package viscy-models` to verify installation succeeds.

6. **Verify import**: `uv run --package viscy-models python -c "import viscy_models; print(viscy_models.__version__)"` should print a version string.

7. **Verify test runner**: `uv run --package viscy-models pytest packages/viscy-models/tests/ --co -q` should show "no tests ran" (collected 0 items) without errors.

Note: `uv lock` may take a moment since timm is a new workspace dependency. This is expected (see Pitfall 4 in research).
  </action>
  <verify>
`uv sync --package viscy-models` exits with code 0.
`uv run --package viscy-models python -c "import viscy_models; print(viscy_models.__version__)"` prints a version.
`uv run --package viscy-models pytest packages/viscy-models/tests/ --co -q` shows no errors.
  </verify>
  <done>viscy-models is installable in the workspace. `import viscy_models` works. The test runner discovers the test directory without errors.</done>
</task>

</tasks>

<verification>
1. `uv sync --package viscy-models` succeeds
2. `uv run --package viscy-models python -c "import viscy_models"` succeeds
3. Directory structure matches research recommendation (all subpackages present)
4. pyproject.toml follows viscy-transforms pattern exactly
5. Root pyproject.toml has viscy-models in dependencies and sources
</verification>

<success_criteria>
- MPKG-01: packages/viscy-models/src/viscy_models/ directory exists with src layout and __init__.py
- MPKG-02: pyproject.toml has hatchling, uv-dynamic-versioning, torch/timm/monai/numpy deps
- MPKG-03: uv sync --package viscy-models succeeds without errors
- Package is importable and version is accessible
</success_criteria>

<output>
After completion, create `.planning/phases/06-package-scaffold-shared-components/06-01-SUMMARY.md`
</output>
