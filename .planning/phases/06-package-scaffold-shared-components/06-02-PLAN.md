---
phase: 06-package-scaffold-shared-components
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/viscy-models/src/viscy_models/components/stems.py
  - packages/viscy-models/src/viscy_models/components/heads.py
  - packages/viscy-models/src/viscy_models/components/blocks.py
  - packages/viscy-models/src/viscy_models/components/__init__.py
  - packages/viscy-models/tests/test_components/test_stems.py
  - packages/viscy-models/tests/test_components/test_heads.py
  - packages/viscy-models/tests/test_components/test_blocks.py
autonomous: true

must_haves:
  truths:
    - "from viscy_models.components.stems import UNeXt2Stem, StemDepthtoChannels works"
    - "from viscy_models.components.heads import PixelToVoxelHead, UnsqueezeHead, PixelToVoxelShuffleHead works"
    - "from viscy_models.components.blocks import UNeXt2UpStage, UNeXt2Decoder, icnr_init, _get_convnext_stage works"
    - "components/ has ZERO imports from unet/, vae/, or contrastive/"
    - "All stem, head, and block classes produce correct output shapes"
    - "All component tests pass"
  artifacts:
    - path: "packages/viscy-models/src/viscy_models/components/stems.py"
      provides: "UNeXt2Stem and StemDepthtoChannels nn.Modules"
      exports: ["UNeXt2Stem", "StemDepthtoChannels"]
    - path: "packages/viscy-models/src/viscy_models/components/heads.py"
      provides: "PixelToVoxelHead, UnsqueezeHead, PixelToVoxelShuffleHead nn.Modules"
      exports: ["PixelToVoxelHead", "UnsqueezeHead", "PixelToVoxelShuffleHead"]
    - path: "packages/viscy-models/src/viscy_models/components/blocks.py"
      provides: "UNeXt2UpStage, UNeXt2Decoder, icnr_init, _get_convnext_stage"
      exports: ["UNeXt2UpStage", "UNeXt2Decoder", "icnr_init", "_get_convnext_stage"]
    - path: "packages/viscy-models/src/viscy_models/components/__init__.py"
      provides: "Public re-exports of all shared components"
    - path: "packages/viscy-models/tests/test_components/test_stems.py"
      provides: "Tests for UNeXt2Stem and StemDepthtoChannels"
    - path: "packages/viscy-models/tests/test_components/test_heads.py"
      provides: "Tests for PixelToVoxelHead, UnsqueezeHead, PixelToVoxelShuffleHead"
    - path: "packages/viscy-models/tests/test_components/test_blocks.py"
      provides: "Tests for UNeXt2UpStage, UNeXt2Decoder"
  key_links:
    - from: "packages/viscy-models/src/viscy_models/components/blocks.py"
      to: "timm.models.convnext.ConvNeXtStage"
      via: "import in _get_convnext_stage"
      pattern: "timm\\.models\\.convnext\\.ConvNeXtStage"
    - from: "packages/viscy-models/src/viscy_models/components/heads.py"
      to: "monai.networks.blocks.UpSample"
      via: "import for PixelToVoxelHead/PixelToVoxelShuffleHead"
      pattern: "from monai\\.networks\\.blocks import.*UpSample"
    - from: "packages/viscy-models/src/viscy_models/components/blocks.py"
      to: "packages/viscy-models/src/viscy_models/components/stems.py"
      via: "NO import -- blocks must not import from stems"
      pattern: "MUST NOT MATCH: from viscy_models.components.stems"
---

<objective>
Extract shared architectural components from the v0.3.3 monolithic codebase into `viscy_models.components/` (stems.py, heads.py, blocks.py).

Purpose: These components are used by multiple model families (UNeXt2, FCMAE, ContrastiveEncoder, VaeEncoder/Decoder). Extracting them first lets Phases 7-9 import from a stable shared location.
Output: Three populated component modules with full test coverage.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-package-scaffold-shared-components/06-RESEARCH.md
@.planning/phases/06-package-scaffold-shared-components/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared components into components/ module</name>
  <files>
    packages/viscy-models/src/viscy_models/components/stems.py
    packages/viscy-models/src/viscy_models/components/heads.py
    packages/viscy-models/src/viscy_models/components/blocks.py
    packages/viscy-models/src/viscy_models/components/__init__.py
  </files>
  <action>
Extract shared nn.Module classes from v0.3.3 source into the components/ subpackage. Source code is available via `git show v0.3.3:viscy/unet/networks/unext2.py` and `git show v0.3.3:viscy/unet/networks/fcmae.py`. Copy code VERBATIM -- only change import paths. Class names, method names, parameter names, and module attribute names (self.conv, self.upsample, etc.) MUST remain identical for state dict key compatibility.

**components/ must have ZERO imports from unet/, vae/, or contrastive/.** Only import from: torch, timm, monai, numpy.

**stems.py** -- Extract from v0.3.3 `viscy/unet/networks/unext2.py`:
- `UNeXt2Stem` class (lines ~72-90): Stem with 3D Conv that projects Z into channels. Used by UNeXt2, FCMAE.
- `StemDepthtoChannels` class (lines ~93-132): Stem with configurable kernel/stride. Used by ContrastiveEncoder, VaeEncoder.
- Imports needed: `from torch import Tensor, nn`
- Include `__all__ = ["UNeXt2Stem", "StemDepthtoChannels"]`

**heads.py** -- Extract from v0.3.3 `viscy/unet/networks/unext2.py` and `fcmae.py`:
- `PixelToVoxelHead` class (from unext2.py, lines ~187-222): 2D-to-3D head with pixel shuffle. Used by UNeXt2, FCMAE, VaeDecoder.
  - This class uses `icnr_init` internally -- import it from `viscy_models.components.blocks` (intra-components import is allowed since blocks.py has no model imports).
- `UnsqueezeHead` class (from unext2.py, lines ~225-233): Simple unsqueeze 2D->3D.
- `PixelToVoxelShuffleHead` class (from fcmae.py, lines ~369-395): Simpler pixelshuffle head without conv. Used by FCMAE.
- Imports needed: `from torch import Tensor, nn`, `from monai.networks.blocks import Convolution, UpSample`, `from monai.networks.utils import normal_init`, `from viscy_models.components.blocks import icnr_init`
- Include `__all__ = ["PixelToVoxelHead", "UnsqueezeHead", "PixelToVoxelShuffleHead"]`

**blocks.py** -- Extract from v0.3.3 `viscy/unet/networks/unext2.py`:
- `icnr_init` function (lines ~11-42): ICNR initialization for pixel shuffle layers. Used by stems, heads, and blocks.
- `_get_convnext_stage` function (lines ~45-63): Creates a configured ConvNeXtStage from timm. Used by UNeXt2UpStage.
- `UNeXt2UpStage` class (lines ~135-184): Single decoder stage with upsample + skip connection + conv. Used by UNeXt2Decoder.
- `UNeXt2Decoder` class (lines ~235-265): Full decoder composed of UNeXt2UpStage instances. Used by UNeXt2, FCMAE.
- Imports needed: `from typing import Callable, Literal, Sequence`, `import timm`, `import torch`, `from monai.networks.blocks import Convolution, ResidualUnit, UpSample`, `from monai.networks.blocks.dynunet_block import get_conv_layer`, `from torch import Tensor, nn`
- Include `__all__ = ["icnr_init", "UNeXt2UpStage", "UNeXt2Decoder"]`
- Note: `_get_convnext_stage` is private (prefixed with underscore) but still needs to be importable by model files in later phases. Include it in the module but NOT in `__all__`.

**components/__init__.py** -- Update to re-export all public components:
```python
"""Shared architectural components used across model families."""
from viscy_models.components.blocks import UNeXt2Decoder, UNeXt2UpStage, icnr_init
from viscy_models.components.heads import (
    PixelToVoxelHead,
    PixelToVoxelShuffleHead,
    UnsqueezeHead,
)
from viscy_models.components.stems import StemDepthtoChannels, UNeXt2Stem

__all__ = [
    "UNeXt2Stem",
    "StemDepthtoChannels",
    "PixelToVoxelHead",
    "UnsqueezeHead",
    "PixelToVoxelShuffleHead",
    "icnr_init",
    "UNeXt2UpStage",
    "UNeXt2Decoder",
]
```

CRITICAL CHECKS after extraction:
- grep the created files to confirm NO imports from `viscy_models.unet`, `viscy_models.vae`, or `viscy_models.contrastive`
- Confirm all class/method/attribute names are IDENTICAL to v0.3.3 source (state dict compatibility)
- Run ruff format on all created files: `uv run ruff format packages/viscy-models/src/viscy_models/components/`
- Run ruff check: `uv run ruff check packages/viscy-models/src/viscy_models/components/ --fix`
  </action>
  <verify>
`uv run --package viscy-models python -c "from viscy_models.components.stems import UNeXt2Stem, StemDepthtoChannels; print('stems OK')"` succeeds.
`uv run --package viscy-models python -c "from viscy_models.components.heads import PixelToVoxelHead, UnsqueezeHead, PixelToVoxelShuffleHead; print('heads OK')"` succeeds.
`uv run --package viscy-models python -c "from viscy_models.components.blocks import UNeXt2UpStage, UNeXt2Decoder, icnr_init; print('blocks OK')"` succeeds.
`grep -r "from viscy_models.unet\|from viscy_models.vae\|from viscy_models.contrastive" packages/viscy-models/src/viscy_models/components/` returns no matches.
  </verify>
  <done>All 8 shared components (2 stems, 3 heads, 2 blocks + 2 functions) are importable from components/. Zero imports from model subpackages. Class and attribute names match v0.3.3 source exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for all extracted components</name>
  <files>
    packages/viscy-models/tests/test_components/test_stems.py
    packages/viscy-models/tests/test_components/test_heads.py
    packages/viscy-models/tests/test_components/test_blocks.py
  </files>
  <action>
Write forward-pass tests for every extracted component. Tests verify correct output shapes and basic functionality. All tests run on CPU. Use the `device` fixture from conftest.py.

**test_stems.py**:
- `test_unext2_stem_output_shape`: Create `UNeXt2Stem(in_channels=1, out_channels=96, kernel_size=(5,4,4), in_stack_depth=5)`. Input: `torch.randn(1, 1, 5, 256, 256)`. Assert output shape is `(1, 96, 64, 64)` -- the stem projects Z (depth=5, kernel_depth=5 -> d=1) and the ratio is 5//5=1, so out_channels//ratio = 96, then reshape produces (B, 96*1, 64, 64).
  Wait -- check the math: kernel_size=(5,4,4) with stride=(5,4,4). Input (1,1,5,256,256). Conv3d output: D=(5-5)/5+1=1, H=(256-4)/4+1=64, W=(256-4)/4+1=64. Channels: out_channels//ratio = 96//1 = 96. Reshape: (1, 96*1, 64, 64) = (1, 96, 64, 64). Correct.
- `test_stem_depth_to_channels_output_shape`: Create `StemDepthtoChannels(in_channels=1, in_stack_depth=15, in_channels_encoder=96, stem_kernel_size=(5,4,4), stem_stride=(5,4,4))`. Input: `torch.randn(1, 1, 15, 256, 256)`. stem3d_out_depth = (15-5)//5+1 = 3, stem3d_out_channels = 96//3 = 32. Conv3d output: (1, 32, 3, 64, 64). Reshape: (1, 96, 64, 64). Assert output shape is `(1, 96, 64, 64)`.
- `test_stem_depth_to_channels_mismatch`: Assert that `StemDepthtoChannels(in_channels=1, in_stack_depth=10, in_channels_encoder=96, stem_kernel_size=(5,4,4), stem_stride=(5,4,4))` raises `ValueError` (because 96 is not divisible by stem3d_out_depth=2... actually (10-5)//5+1=2, 96//2=48, 48*2=96, mismatch=0. Use in_stack_depth=12 instead: (12-5)//5+1=2, same. Try in_stack_depth=7: (7-5)//5+1=1, 96//1=96, 96*1=96, OK. Try in_channels_encoder=97 with in_stack_depth=15: 97//3=32, 32*3=96, mismatch=1. Use `StemDepthtoChannels(in_channels=1, in_stack_depth=15, in_channels_encoder=97)` to trigger ValueError).

**test_heads.py**:
- `test_pixel_to_voxel_head_output_shape`: Create a PixelToVoxelHead with representative params. Input shape must be 2D (B,C,H,W). The head is complex -- use params similar to UNeXt2's usage: `PixelToVoxelHead(in_channels=96, out_channels=2, out_stack_depth=5, expansion_ratio=4, pool=False)`. Input: `torch.randn(1, 96, 64, 64)`. Expected output: (1, 2, 5, 256, 256) -- the head upsamples 2x via pixelshuffle (64->128 in upsample), then 3D conv reduces depth from 7 to some value, then pixelshuffle 2x again. This is complex -- compute carefully or just verify output has 5 dims (B, out_channels, out_stack_depth, H', W') and channels match out_channels. Use a simpler assertion: `assert output.shape[0] == 1 and output.shape[1] == 2 and output.shape[2] == 5`.
- `test_unsqueeze_head`: Create `UnsqueezeHead()`. Input: `torch.randn(2, 16, 32, 32)`. Assert output shape is `(2, 16, 1, 32, 32)`.
- `test_pixel_to_voxel_shuffle_head_output_shape`: Create `PixelToVoxelShuffleHead(in_channels=768, out_channels=2, out_stack_depth=5, xy_scaling=4, pool=False)`. Input: `torch.randn(1, 768, 16, 16)`. Upsample: pixelshuffle 4x from (1, 768, 16, 16) -> (1, 5*2, 64, 64) = (1, 10, 64, 64). Reshape: (1, 2, 5, 64, 64). Assert output shape is `(1, 2, 5, 64, 64)`.

**test_blocks.py**:
- `test_icnr_init`: Create a `nn.Conv2d(16, 64, 3, padding=1)`. Call `icnr_init(conv, upsample_factor=2, upsample_dims=2)`. Assert conv.weight is not all zeros and has expected shape.
- `test_get_convnext_stage`: Call `_get_convnext_stage(in_channels=96, out_channels=96, depth=2)`. Assert result is an `nn.Module`. Create input `torch.randn(1, 96, 32, 32)` and verify forward pass produces same spatial dims.
- `test_unext2_up_stage_pixelshuffle`: Create `UNeXt2UpStage(in_channels=192, skip_channels=96, out_channels=96, scale_factor=2, mode="pixelshuffle", conv_blocks=2, norm_name="instance", upsample_pre_conv=None)`. Input: `torch.randn(1, 192, 16, 16)` (low-res), skip: `torch.randn(1, 96, 32, 32)` (high-res). Verify output shape is `(1, 96, 32, 32)`.
- `test_unext2_decoder`: Create `UNeXt2Decoder(num_channels=[384, 192, 96], norm_name="instance", mode="pixelshuffle", conv_blocks=2, strides=[2, 2], upsample_pre_conv=None)`. Input features: `[torch.randn(1, 384, 8, 8), torch.randn(1, 192, 16, 16), torch.randn(1, 96, 32, 32)]`. The decoder processes high-to-low resolution. Verify output shape spatial dims are 32x32 and channels are 96. Note: features list has reversed order (largest channels first), and the last element is used as skip. Verify output is `(1, 96, 32, 32)`.

Run all tests with: `uv run --package viscy-models pytest packages/viscy-models/tests/test_components/ -v`
  </action>
  <verify>
`uv run --package viscy-models pytest packages/viscy-models/tests/test_components/ -v` passes all tests.
At least 8 tests total across the 3 test files.
  </verify>
  <done>All components have forward-pass tests verifying correct output shapes. Test suite runs cleanly with no failures.</done>
</task>

</tasks>

<verification>
1. All 8 shared components importable from `viscy_models.components`
2. Zero imports from model subpackages in components/ code
3. Class names, attribute names match v0.3.3 source exactly
4. All component tests pass
5. ruff format/check clean on all new files
</verification>

<success_criteria>
- MPKG-04: viscy_models.components subpackage contains stems.py, heads.py, and blocks.py with extracted shared code
- All component classes produce correct output shapes in tests
- No circular import potential (zero model subpackage imports in components)
- State dict key compatibility preserved (attribute names identical to source)
</success_criteria>

<output>
After completion, create `.planning/phases/06-package-scaffold-shared-components/06-02-SUMMARY.md`
</output>
