---
phase: 07-code-migration
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/viscy-data/src/viscy_data/mmap_cache.py
  - packages/viscy-data/src/viscy_data/ctmc_v1.py
  - packages/viscy-data/src/viscy_data/livecell.py
  - packages/viscy-data/src/viscy_data/combined.py
autonomous: true

must_haves:
  truths:
    - "from viscy_data.mmap_cache import MmappedDataset, MmappedDataModule succeeds"
    - "from viscy_data.ctmc_v1 import CTMCv1DataModule succeeds"
    - "from viscy_data.livecell import LiveCellDataset, LiveCellTestDataset, LiveCellDataModule succeeds"
    - "from viscy_data.combined import CombinedDataModule, CombineMode, ConcatDataModule, BatchedConcatDataModule, CachedConcatDataModule, BatchedConcatDataset succeeds"
    - "tensordict is lazily imported in mmap_cache.py with clear error message"
    - "pycocotools, tifffile, and torchvision are lazily imported in livecell.py with clear error messages"
    - "combined.py is copied as-is (NOT split into combined.py + concat.py per REF-02 deferral)"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/mmap_cache.py"
      provides: "MmappedDataset, MmappedDataModule"
      contains: "tensordict"
    - path: "packages/viscy-data/src/viscy_data/ctmc_v1.py"
      provides: "CTMCv1DataModule"
    - path: "packages/viscy-data/src/viscy_data/livecell.py"
      provides: "LiveCellDataset, LiveCellTestDataset, LiveCellDataModule"
      contains: "pycocotools"
    - path: "packages/viscy-data/src/viscy_data/combined.py"
      provides: "CombinedDataModule, CombineMode, ConcatDataModule, BatchedConcatDataModule, CachedConcatDataModule, BatchedConcatDataset"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/mmap_cache.py"
      to: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      via: "MmappedDataModule inherits GPUTransformDataModule"
      pattern: "from viscy_data.gpu_aug import GPUTransformDataModule"
    - from: "packages/viscy-data/src/viscy_data/livecell.py"
      to: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      via: "LiveCellDataModule inherits GPUTransformDataModule"
      pattern: "from viscy_data.gpu_aug import GPUTransformDataModule"
    - from: "packages/viscy-data/src/viscy_data/ctmc_v1.py"
      to: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      via: "CTMCv1DataModule inherits GPUTransformDataModule"
      pattern: "from viscy_data.gpu_aug import"
    - from: "packages/viscy-data/src/viscy_data/combined.py"
      to: "packages/viscy-data/src/viscy_data/_utils.py"
      via: "import _collate_samples"
      pattern: "from viscy_data._utils import _collate_samples"
---

<objective>
Migrate mmap_cache.py, ctmc_v1.py, livecell.py, and combined.py into the viscy-data package with lazy optional dependency imports.

Purpose: These modules depend on gpu_aug.py (from Plan 01) and have optional dependencies (tensordict, pycocotools/tifffile/torchvision). combined.py is the composition module. All require lazy import patterns for optional deps.
Output: 4 new Python modules with lazy imports for optional deps and updated internal import paths.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-migration/07-01-SUMMARY.md
@packages/viscy-data/src/viscy_data/_typing.py
@packages/viscy-data/src/viscy_data/_utils.py
@packages/viscy-data/src/viscy_data/gpu_aug.py
@packages/viscy-data/src/viscy_data/distributed.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate mmap_cache.py and ctmc_v1.py</name>
  <files>
    packages/viscy-data/src/viscy_data/mmap_cache.py
    packages/viscy-data/src/viscy_data/ctmc_v1.py
  </files>
  <action>
**mmap_cache.py** (~265 lines):
Copy from `git show main:viscy/data/mmap_cache.py` and apply:

1. Import rewiring:
   - `from viscy.data.gpu_aug import GPUTransformDataModule` → `from viscy_data.gpu_aug import GPUTransformDataModule`
   - `from viscy.data.hcs import _ensure_channel_list, _read_norm_meta` → `from viscy_data._utils import _ensure_channel_list, _read_norm_meta`
   - `from viscy.data.select import SelectWell` → `from viscy_data.select import SelectWell`
   - `from viscy.data.typing import DictTransform, NormMeta` → `from viscy_data._typing import DictTransform, NormMeta`

2. Lazy import for tensordict:
   Replace `from tensordict.memmap import MemoryMappedTensor` with:
   ```python
   try:
       from tensordict.memmap import MemoryMappedTensor
   except ImportError:
       MemoryMappedTensor = None
   ```
   Add check at the start of `MmappedDataset.__init__`:
   ```python
   if MemoryMappedTensor is None:
       raise ImportError(
           "tensordict is required for MmappedDataset. "
           "Install with: pip install 'viscy-data[mmap]'"
       )
   ```

No other changes.

**ctmc_v1.py** (~113 lines):
Copy from `git show main:viscy/data/ctmc_v1.py` and apply:

1. `from viscy.data.gpu_aug import CachedOmeZarrDataset, GPUTransformDataModule` → `from viscy_data.gpu_aug import CachedOmeZarrDataset, GPUTransformDataModule`

No optional dependencies in ctmc_v1.py (uses iohub, monai, torch — all required). No lazy imports needed. No other changes.
  </action>
  <verify>
Run `python -c "from viscy_data.mmap_cache import MmappedDataset, MmappedDataModule; print('mmap_cache OK')"`.
Run `python -c "from viscy_data.ctmc_v1 import CTMCv1DataModule; print('ctmc_v1 OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/mmap_cache.py packages/viscy-data/src/viscy_data/ctmc_v1.py`.
Grep for `viscy\.data\.\|viscy\.transforms` in both files — must find zero matches.
Grep for `MemoryMappedTensor is None` in mmap_cache.py — must find match.
  </verify>
  <done>
mmap_cache.py and ctmc_v1.py importable. tensordict lazily imported with error message. All imports use viscy_data. prefix. Ruff passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate livecell.py with lazy pycocotools/tifffile/torchvision imports</name>
  <files>packages/viscy-data/src/viscy_data/livecell.py</files>
  <action>
Copy from `git show main:viscy/data/livecell.py` (~226 lines) and apply:

1. Import rewiring:
   - `from viscy.data.gpu_aug import GPUTransformDataModule` → `from viscy_data.gpu_aug import GPUTransformDataModule`
   - `from viscy.data.typing import Sample` → `from viscy_data._typing import Sample`

2. Lazy imports for 3 optional dependencies:
   Replace top-level imports:
   ```python
   from pycocotools.coco import COCO
   from tifffile import imread
   from torchvision.ops import box_convert
   ```
   With:
   ```python
   try:
       from pycocotools.coco import COCO
   except ImportError:
       COCO = None

   try:
       from tifffile import imread
   except ImportError:
       imread = None

   try:
       from torchvision.ops import box_convert
   except ImportError:
       box_convert = None
   ```

   Add check at the start of `LiveCellDataset.__init__`:
   ```python
   if COCO is None or imread is None or box_convert is None:
       missing = []
       if COCO is None:
           missing.append("pycocotools")
       if imread is None:
           missing.append("tifffile")
       if box_convert is None:
           missing.append("torchvision")
       raise ImportError(
           f"{', '.join(missing)} required for LiveCellDataset. "
           "Install with: pip install 'viscy-data[livecell]'"
       )
   ```

   Also add the same check at the start of `LiveCellTestDataset.__init__` (it also uses COCO and imread).

No other changes.
  </action>
  <verify>
Run `python -c "from viscy_data.livecell import LiveCellDataset, LiveCellTestDataset, LiveCellDataModule; print('livecell OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/livecell.py`.
Grep for `viscy\.data\.\|viscy\.transforms` in livecell.py — must find zero matches.
Grep for `COCO is None` in livecell.py — must find matches.
  </verify>
  <done>
livecell.py importable with 3 public classes. pycocotools, tifffile, torchvision lazily imported with clear error messages. All imports use viscy_data. prefix. Ruff passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate combined.py as-is (no split per REF-02 deferral)</name>
  <files>packages/viscy-data/src/viscy_data/combined.py</files>
  <action>
Copy from `git show main:viscy/data/combined.py` (~338 lines) and apply import changes only:

1. `from viscy.data.distributed import ShardedDistributedSampler` → `from viscy_data.distributed import ShardedDistributedSampler`
2. `from viscy.data.hcs import _collate_samples` → `from viscy_data._utils import _collate_samples`

**IMPORTANT:** Do NOT split combined.py into combined.py + concat.py. Per scope constraints, REF-02 is a future requirement. Copy the entire file as-is, changing only the 2 imports above.

This module has no optional dependencies (uses torch, lightning, monai — all required). No lazy imports needed.

The file contains 6 public classes: CombineMode (enum), CombinedDataModule, BatchedConcatDataset, ConcatDataModule, BatchedConcatDataModule, CachedConcatDataModule. All must be preserved.
  </action>
  <verify>
Run `python -c "from viscy_data.combined import CombinedDataModule, CombineMode, ConcatDataModule, BatchedConcatDataModule, CachedConcatDataModule, BatchedConcatDataset; print('combined OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/combined.py`.
Grep for `viscy\.data\.\|viscy\.transforms` in combined.py — must find zero matches.
  </verify>
  <done>
combined.py importable with all 6 public classes. Only import paths changed, no structural refactoring. Ruff passes.
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. All 4 modules importable: `python -c "from viscy_data.mmap_cache import MmappedDataModule; from viscy_data.ctmc_v1 import CTMCv1DataModule; from viscy_data.livecell import LiveCellDataModule; from viscy_data.combined import CombinedDataModule; print('All OK')"`
2. No viscy.data or viscy.transforms references: `grep -r 'viscy\.data\.\|viscy\.transforms' packages/viscy-data/src/viscy_data/mmap_cache.py packages/viscy-data/src/viscy_data/ctmc_v1.py packages/viscy-data/src/viscy_data/livecell.py packages/viscy-data/src/viscy_data/combined.py` returns nothing
3. `uvx ruff check packages/viscy-data/src/viscy_data/` passes
</verification>

<success_criteria>
4 modules exist with correct imports, lazy optional dep loading for tensordict/pycocotools/tifffile/torchvision, and no stale viscy references. combined.py preserved as-is (not split). Ruff passes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-migration/07-03-SUMMARY.md`
</output>
