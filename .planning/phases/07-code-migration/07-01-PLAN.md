---
phase: 07-code-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-data/src/viscy_data/select.py
  - packages/viscy-data/src/viscy_data/distributed.py
  - packages/viscy-data/src/viscy_data/segmentation.py
  - packages/viscy-data/src/viscy_data/hcs.py
  - packages/viscy-data/src/viscy_data/gpu_aug.py
autonomous: true

must_haves:
  truths:
    - "from viscy_data.select import SelectWell, _filter_wells, _filter_fovs succeeds"
    - "from viscy_data.distributed import ShardedDistributedSampler succeeds"
    - "from viscy_data.segmentation import SegmentationDataset, SegmentationDataModule succeeds"
    - "from viscy_data.hcs import HCSDataModule, SlidingWindowDataset, MaskTestDataset succeeds"
    - "from viscy_data.gpu_aug import GPUTransformDataModule, CachedOmeZarrDataset, CachedOmeZarrDataModule succeeds"
    - "No import uses viscy.data. prefix — all internal imports use viscy_data. absolute prefix"
    - "hcs.py does NOT define _ensure_channel_list, _read_norm_meta, _collate_samples, _search_int_in_str — imports them from viscy_data._utils"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/select.py"
      provides: "SelectWell mixin, _filter_wells, _filter_fovs"
    - path: "packages/viscy-data/src/viscy_data/distributed.py"
      provides: "ShardedDistributedSampler"
    - path: "packages/viscy-data/src/viscy_data/hcs.py"
      provides: "HCSDataModule, SlidingWindowDataset, MaskTestDataset"
      contains: "from viscy_data._utils import"
    - path: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      provides: "GPUTransformDataModule, CachedOmeZarrDataset, CachedOmeZarrDataModule"
    - path: "packages/viscy-data/src/viscy_data/segmentation.py"
      provides: "SegmentationDataset, SegmentationDataModule"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/hcs.py"
      to: "packages/viscy-data/src/viscy_data/_utils.py"
      via: "import shared utilities"
      pattern: "from viscy_data._utils import"
    - from: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      to: "packages/viscy-data/src/viscy_data/distributed.py"
      via: "import ShardedDistributedSampler"
      pattern: "from viscy_data.distributed import"
    - from: "packages/viscy-data/src/viscy_data/gpu_aug.py"
      to: "packages/viscy-data/src/viscy_data/select.py"
      via: "SelectWell mixin inheritance"
      pattern: "from viscy_data.select import SelectWell"
---

<objective>
Migrate the 5 core/standalone data modules (select.py, distributed.py, segmentation.py, hcs.py, gpu_aug.py) into the viscy-data package with updated import paths.

Purpose: These are the foundation modules that all specialized modules depend on. They must exist before Wave 2 can begin.
Output: 5 new Python modules in packages/viscy-data/src/viscy_data/ with all internal imports using absolute viscy_data. prefix.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-package-scaffolding-and-foundation/06-01-SUMMARY.md
@.planning/phases/06-package-scaffolding-and-foundation/06-02-SUMMARY.md
@packages/viscy-data/src/viscy_data/__init__.py
@packages/viscy-data/src/viscy_data/_typing.py
@packages/viscy-data/src/viscy_data/_utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate select.py, distributed.py, and segmentation.py (standalone modules)</name>
  <files>
    packages/viscy-data/src/viscy_data/select.py
    packages/viscy-data/src/viscy_data/distributed.py
    packages/viscy-data/src/viscy_data/segmentation.py
  </files>
  <action>
Copy these 3 modules from main branch using `git show main:viscy/data/X.py` and update imports:

**select.py** (~40 lines):
- Copy verbatim from `git show main:viscy/data/select.py`
- No internal viscy imports to update (only uses iohub)
- Keep all 3 public names: SelectWell class, _filter_wells function, _filter_fovs function

**distributed.py** (~50 lines):
- Copy verbatim from `git show main:viscy/data/distributed.py`
- No internal viscy imports to update (only uses torch)
- Keep public class: ShardedDistributedSampler

**segmentation.py** (~104 lines):
- Copy from `git show main:viscy/data/segmentation.py`
- Change: `from viscy.data.typing import SegmentationSample` → `from viscy_data._typing import SegmentationSample`
- Keep public classes: SegmentationDataset, SegmentationDataModule

All files must use absolute imports (no relative imports). No other changes to logic or docstrings.
  </action>
  <verify>
Run `python -c "from viscy_data.select import SelectWell, _filter_wells, _filter_fovs; print('select OK')"` and
`python -c "from viscy_data.distributed import ShardedDistributedSampler; print('distributed OK')"` and
`python -c "from viscy_data.segmentation import SegmentationDataset, SegmentationDataModule; print('segmentation OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/select.py packages/viscy-data/src/viscy_data/distributed.py packages/viscy-data/src/viscy_data/segmentation.py`.
Grep for `viscy.data` in all 3 files — must find zero matches.
  </verify>
  <done>
All 3 modules importable. No viscy.data references. Ruff passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate hcs.py (core DataModule with utility import rewiring)</name>
  <files>packages/viscy-data/src/viscy_data/hcs.py</files>
  <action>
Copy from `git show main:viscy/data/hcs.py` (663 lines) and apply these changes:

**Import rewiring:**
1. Remove the line: `from viscy.data.typing import ChannelMap, DictTransform, HCSStackIndex, NormMeta, Sample`
   Replace with: `from viscy_data._typing import ChannelMap, DictTransform, HCSStackIndex, NormMeta, Sample`

2. REMOVE the following function definitions that are now in _utils.py (they were extracted in Phase 6):
   - `_ensure_channel_list()` (approx lines 33-44)
   - `_search_int_in_str()` (approx lines 47-54)
   - `_collate_samples()` (approx lines 57-75)
   - `_read_norm_meta()` (approx lines 78-94)

3. ADD import at top: `from viscy_data._utils import _collate_samples, _ensure_channel_list, _read_norm_meta, _search_int_in_str`

**No other changes.** Keep all 3 classes (SlidingWindowDataset, MaskTestDataset, HCSDataModule), all methods, all docstrings. Do NOT change any logic.

The remaining code references these functions internally (e.g., HCSDataModule.__init__ calls _ensure_channel_list, setup calls _read_norm_meta, collate_fn uses _collate_samples). These calls do NOT need updating since the function names are unchanged.
  </action>
  <verify>
Run `python -c "from viscy_data.hcs import HCSDataModule, SlidingWindowDataset, MaskTestDataset; print('hcs OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/hcs.py`.
Grep for `viscy.data` and `viscy.transforms` in hcs.py — must find zero matches.
Grep for `def _ensure_channel_list\|def _search_int_in_str\|def _collate_samples\|def _read_norm_meta` in hcs.py — must find zero matches (functions removed, imported from _utils).
  </verify>
  <done>
hcs.py importable with 3 public classes. Utility functions imported from _utils, not defined locally. No viscy.data references. Ruff passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate gpu_aug.py (ABC DataModule with dependency on select, distributed, hcs patterns)</name>
  <files>packages/viscy-data/src/viscy_data/gpu_aug.py</files>
  <action>
Copy from `git show main:viscy/data/gpu_aug.py` and apply these import changes:

1. `from viscy.data.distributed import ShardedDistributedSampler` → `from viscy_data.distributed import ShardedDistributedSampler`
2. `from viscy.data.hcs import _ensure_channel_list, _read_norm_meta` → `from viscy_data._utils import _ensure_channel_list, _read_norm_meta`
3. `from viscy.data.select import SelectWell` → `from viscy_data.select import SelectWell`
4. `from viscy.data.typing import DictTransform, NormMeta` → `from viscy_data._typing import DictTransform, NormMeta`

**No other changes.** Keep all 3 classes (GPUTransformDataModule, CachedOmeZarrDataset, CachedOmeZarrDataModule), all methods, all docstrings. The abc import, TYPE_CHECKING guard, and DictProxy type annotation remain unchanged.
  </action>
  <verify>
Run `python -c "from viscy_data.gpu_aug import GPUTransformDataModule, CachedOmeZarrDataset, CachedOmeZarrDataModule; print('gpu_aug OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/gpu_aug.py`.
Grep for `viscy.data\|viscy.transforms` in gpu_aug.py — must find zero matches.
  </verify>
  <done>
gpu_aug.py importable with 3 public classes. All internal imports use viscy_data. prefix. Ruff passes.
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete:
1. `python -c "from viscy_data.select import SelectWell; from viscy_data.distributed import ShardedDistributedSampler; from viscy_data.segmentation import SegmentationDataModule; from viscy_data.hcs import HCSDataModule; from viscy_data.gpu_aug import GPUTransformDataModule; print('All core modules OK')"` succeeds
2. `grep -r 'viscy\.data\.\|viscy\.transforms' packages/viscy-data/src/viscy_data/select.py packages/viscy-data/src/viscy_data/distributed.py packages/viscy-data/src/viscy_data/segmentation.py packages/viscy-data/src/viscy_data/hcs.py packages/viscy-data/src/viscy_data/gpu_aug.py` returns no results
3. `uvx ruff check packages/viscy-data/src/viscy_data/` passes
</verification>

<success_criteria>
5 core modules exist in packages/viscy-data/src/viscy_data/ with correct imports, importable without error, and passing ruff. No viscy.data or viscy.transforms references anywhere.
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-migration/07-01-SUMMARY.md`
</output>
