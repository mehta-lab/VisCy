---
phase: 07-code-migration
plan: 04
type: execute
wave: 3
depends_on: ["07-02", "07-03"]
files_modified:
  - packages/viscy-data/src/viscy_data/__init__.py
autonomous: true

must_haves:
  truths:
    - "from viscy_data import HCSDataModule works (and all other DataModules/Datasets)"
    - "import viscy_data succeeds without any optional extras installed"
    - "All 15+ public classes are available at package top level"
    - "All type definitions remain available at package top level"
    - "__all__ lists every public export"
    - "Importing viscy_data when tensorstore/tensordict/pycocotools are NOT installed does NOT raise ImportError"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/__init__.py"
      provides: "Complete public API re-exports for all DataModules, Datasets, and types"
      contains: "HCSDataModule"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/__init__.py"
      to: "all 13 data modules"
      via: "eager imports of all modules (lazy guards are inside each module)"
      pattern: "from viscy_data\\."
---

<objective>
Update __init__.py with complete flat top-level exports for all DataModules, Datasets, types, and enums, then verify the full package works.

Purpose: DATA-MIG-02 requires flat top-level exports so users can do `from viscy_data import HCSDataModule`. This is the final integration step that ties all 13 migrated modules into a single importable package.
Output: Updated __init__.py with all public exports and verification that `import viscy_data` works without optional extras.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-migration/07-01-SUMMARY.md
@.planning/phases/07-code-migration/07-02-SUMMARY.md
@.planning/phases/07-code-migration/07-03-SUMMARY.md
@packages/viscy-data/src/viscy_data/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update __init__.py with complete public exports from all 13 modules</name>
  <files>packages/viscy-data/src/viscy_data/__init__.py</files>
  <action>
Replace the current __init__.py (which only exports types) with complete exports from all modules.

**Import strategy:** Eagerly import all modules. Each module handles its own optional deps with lazy import guards internally, so `import viscy_data` will always succeed even without optional extras installed. Only actual instantiation of classes that need optional deps will raise ImportError.

The complete __init__.py should have:

```python
"""VisCy Data - Data loading and Lightning DataModules for virtual staining microscopy.

This package provides PyTorch Lightning DataModules and Datasets for loading
and preprocessing microscopy data in virtual staining workflows.

Public API:
    All DataModules, Datasets, and type definitions are exported at the package level.
    Example: ``from viscy_data import HCSDataModule, Sample, NormMeta``

Optional Extras:
    Some modules require optional dependencies:
    - ``pip install 'viscy-data[triplet]'`` for TripletDataModule (tensorstore, pandas)
    - ``pip install 'viscy-data[livecell]'`` for LiveCellDataModule (pycocotools, tifffile, torchvision)
    - ``pip install 'viscy-data[mmap]'`` for MmappedDataModule (tensordict)
    - ``pip install 'viscy-data[all]'`` for all optional dependencies

Version:
    Use ``importlib.metadata.version('viscy-data')`` to get version.
"""

# Type definitions (from _typing.py)
from viscy_data._typing import (
    INDEX_COLUMNS,
    LABEL_CELL_CYCLE_STATE,
    LABEL_CELL_DIVISION_STATE,
    LABEL_CELL_REMODELING_STATE,
    LABEL_INFECTION_STATE,
    AnnotationColumns,
    ChannelMap,
    ChannelNormStats,
    DictTransform,
    HCSStackIndex,
    LevelNormStats,
    NormMeta,
    OneOrSeq,
    Sample,
    SegmentationSample,
    TrackingIndex,
    TripletSample,
)

# Utility modules (from select.py, distributed.py)
from viscy_data.select import SelectWell
from viscy_data.distributed import ShardedDistributedSampler

# Core DataModules (from hcs.py)
from viscy_data.hcs import HCSDataModule, MaskTestDataset, SlidingWindowDataset

# GPU augmentation DataModules (from gpu_aug.py)
from viscy_data.gpu_aug import (
    CachedOmeZarrDataModule,
    CachedOmeZarrDataset,
    GPUTransformDataModule,
)

# Triplet learning (from triplet.py — requires [triplet] extra at runtime)
from viscy_data.triplet import TripletDataModule, TripletDataset

# Cell classification (from cell_classification.py — requires pandas at runtime)
from viscy_data.cell_classification import (
    ClassificationDataModule,
    ClassificationDataset,
)

# Cell division triplet (from cell_division_triplet.py)
from viscy_data.cell_division_triplet import (
    CellDivisionTripletDataModule,
    CellDivisionTripletDataset,
)

# Memory-mapped cache (from mmap_cache.py — requires [mmap] extra at runtime)
from viscy_data.mmap_cache import MmappedDataModule, MmappedDataset

# LiveCell benchmark (from livecell.py — requires [livecell] extra at runtime)
from viscy_data.livecell import LiveCellDataModule, LiveCellDataset, LiveCellTestDataset

# CTMC v1 (from ctmc_v1.py)
from viscy_data.ctmc_v1 import CTMCv1DataModule

# Segmentation (from segmentation.py)
from viscy_data.segmentation import SegmentationDataModule, SegmentationDataset

# Combined/Concat DataModules (from combined.py)
from viscy_data.combined import (
    BatchedConcatDataModule,
    BatchedConcatDataset,
    CachedConcatDataModule,
    CombinedDataModule,
    CombineMode,
    ConcatDataModule,
)

__all__ = [
    # Types
    "AnnotationColumns",
    "ChannelMap",
    "ChannelNormStats",
    "DictTransform",
    "HCSStackIndex",
    "INDEX_COLUMNS",
    "LABEL_CELL_CYCLE_STATE",
    "LABEL_CELL_DIVISION_STATE",
    "LABEL_CELL_REMODELING_STATE",
    "LABEL_INFECTION_STATE",
    "LevelNormStats",
    "NormMeta",
    "OneOrSeq",
    "Sample",
    "SegmentationSample",
    "TrackingIndex",
    "TripletSample",
    # Utilities
    "SelectWell",
    "ShardedDistributedSampler",
    # Core
    "HCSDataModule",
    "MaskTestDataset",
    "SlidingWindowDataset",
    # GPU augmentation
    "CachedOmeZarrDataModule",
    "CachedOmeZarrDataset",
    "GPUTransformDataModule",
    # Triplet
    "TripletDataModule",
    "TripletDataset",
    # Cell classification
    "ClassificationDataModule",
    "ClassificationDataset",
    # Cell division
    "CellDivisionTripletDataModule",
    "CellDivisionTripletDataset",
    # Memory-mapped cache
    "MmappedDataModule",
    "MmappedDataset",
    # LiveCell
    "LiveCellDataModule",
    "LiveCellDataset",
    "LiveCellTestDataset",
    # CTMC
    "CTMCv1DataModule",
    # Segmentation
    "SegmentationDataModule",
    "SegmentationDataset",
    # Combined
    "BatchedConcatDataModule",
    "BatchedConcatDataset",
    "CachedConcatDataModule",
    "CombinedDataModule",
    "CombineMode",
    "ConcatDataModule",
]
```

**Note:** All imports are eager (not lazy) because each module already has its own internal lazy import guards. The top-level `import viscy_data` will succeed even without optional extras. Only creating an instance of a class that needs an optional dep (e.g., `TripletDataset(...)`) will raise ImportError.

Run `uvx ruff check` and `uvx ruff format` after writing the file. Fix any import ordering issues ruff flags (ruff will likely reorder the imports alphabetically — that is fine).
  </action>
  <verify>
Run `python -c "import viscy_data; print(f'Exports: {len(viscy_data.__all__)}'); print('OK')"` — should show 40+ exports.
Run `python -c "from viscy_data import HCSDataModule, TripletDataModule, LiveCellDataModule, CombinedDataModule, GPUTransformDataModule; print('Top-level imports OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/__init__.py`.
  </verify>
  <done>
__init__.py exports all 40+ public names. import viscy_data succeeds. All DataModules/Datasets accessible at top level.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full package integrity — all imports, no stale references, optional dep isolation</name>
  <files></files>
  <action>
Run comprehensive verification (no file changes, verification only):

**1. Import completeness:** Verify every public class is importable from top level:
```python
python -c "
from viscy_data import (
    # Types
    Sample, NormMeta, ChannelMap, HCSStackIndex, DictTransform,
    TripletSample, SegmentationSample, TrackingIndex,
    AnnotationColumns, ChannelNormStats, LevelNormStats, OneOrSeq,
    INDEX_COLUMNS, LABEL_INFECTION_STATE, LABEL_CELL_DIVISION_STATE,
    LABEL_CELL_CYCLE_STATE, LABEL_CELL_REMODELING_STATE,
    # Utilities
    SelectWell, ShardedDistributedSampler,
    # Core
    HCSDataModule, SlidingWindowDataset, MaskTestDataset,
    GPUTransformDataModule, CachedOmeZarrDataset, CachedOmeZarrDataModule,
    # Specialized
    TripletDataset, TripletDataModule,
    ClassificationDataset, ClassificationDataModule,
    CellDivisionTripletDataset, CellDivisionTripletDataModule,
    MmappedDataset, MmappedDataModule,
    LiveCellDataset, LiveCellTestDataset, LiveCellDataModule,
    CTMCv1DataModule,
    SegmentationDataset, SegmentationDataModule,
    # Combined
    CombinedDataModule, CombineMode,
    ConcatDataModule, BatchedConcatDataModule, CachedConcatDataModule,
    BatchedConcatDataset,
)
print(f'All {len(dir())-1} imports successful')
"
```

**2. No stale references:** Run grep across ALL .py files in the package:
```bash
grep -r 'viscy\.data\.\|viscy\.transforms\|from viscy\.' packages/viscy-data/src/viscy_data/
```
Must return zero matches.

**3. No relative imports:**
```bash
grep -r 'from \.\|import \.' packages/viscy-data/src/viscy_data/ --include='*.py'
```
Must return zero matches (except `from __future__ import annotations` which is fine — check for `from \.` pattern specifically).

**4. Ruff passes on entire package:**
```bash
uvx ruff check packages/viscy-data/src/viscy_data/
```

**5. Internal imports are absolute:**
```bash
grep -r 'from viscy_data\.' packages/viscy-data/src/viscy_data/ --include='*.py'
```
Should show all internal cross-module imports using `viscy_data.` prefix.

If any check fails, fix the issue in the affected file(s) and re-run verification.
  </action>
  <verify>
All 5 checks above pass. Zero stale viscy.data references. Zero relative imports. All imports use viscy_data. prefix. Ruff clean.
  </verify>
  <done>
Full package verified: all 40+ exports work, no stale references, no relative imports, ruff passes. Phase 7 success criteria met.
  </done>
</task>

</tasks>

<verification>
Phase 7 Success Criteria verification:
1. `from viscy_data import HCSDataModule` (and all other DataModules/Datasets) works — verified by Task 2 import completeness check
2. `import viscy_data` succeeds without any optional extras installed — verified by eager import with internal lazy guards
3. `TripletDataModule` does not import or depend on viscy-transforms — verified by grep in Plan 02
4. All internal imports use absolute `viscy_data.` prefix — verified by Task 2 grep check
5. Importing a module that requires an uninstalled optional extra produces clear error message — lazy import guards in Plans 02 and 03
</verification>

<success_criteria>
__init__.py exports 40+ public names. import viscy_data works without optional extras. All 13 modules migrated with correct imports. No stale viscy.data or viscy.transforms references anywhere. Ruff passes on entire package.
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-migration/07-04-SUMMARY.md`
</output>
