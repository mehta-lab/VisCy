---
phase: 07-code-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/viscy-data/src/viscy_data/triplet.py
  - packages/viscy-data/src/viscy_data/cell_classification.py
  - packages/viscy-data/src/viscy_data/cell_division_triplet.py
autonomous: true

must_haves:
  truths:
    - "from viscy_data.triplet import TripletDataset, TripletDataModule succeeds"
    - "from viscy_data.cell_classification import ClassificationDataset, ClassificationDataModule succeeds"
    - "from viscy_data.cell_division_triplet import CellDivisionTripletDataset, CellDivisionTripletDataModule succeeds"
    - "triplet.py does NOT import from viscy.transforms or viscy_transforms — BatchedCenterSpatialCropd is fully removed"
    - "triplet.py uses MONAI CenterSpatialCropd instead of BatchedCenterSpatialCropd for _final_crop"
    - "tensorstore and pandas are lazily imported in triplet.py with clear error messages"
    - "pandas is lazily imported in cell_classification.py with clear error message"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/triplet.py"
      provides: "TripletDataset, TripletDataModule"
      contains: "CenterSpatialCropd"
    - path: "packages/viscy-data/src/viscy_data/cell_classification.py"
      provides: "ClassificationDataset, ClassificationDataModule"
    - path: "packages/viscy-data/src/viscy_data/cell_division_triplet.py"
      provides: "CellDivisionTripletDataset, CellDivisionTripletDataModule"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/triplet.py"
      to: "packages/viscy-data/src/viscy_data/hcs.py"
      via: "TripletDataModule inherits HCSDataModule"
      pattern: "from viscy_data.hcs import HCSDataModule"
    - from: "packages/viscy-data/src/viscy_data/triplet.py"
      to: "packages/viscy-data/src/viscy_data/_utils.py"
      via: "import _transform_channel_wise, _read_norm_meta"
      pattern: "from viscy_data._utils import"
    - from: "packages/viscy-data/src/viscy_data/cell_division_triplet.py"
      to: "packages/viscy-data/src/viscy_data/hcs.py"
      via: "CellDivisionTripletDataModule inherits HCSDataModule"
      pattern: "from viscy_data.hcs import HCSDataModule"
---

<objective>
Migrate triplet.py (with BatchedCenterSpatialCropd removal), cell_classification.py, and cell_division_triplet.py into the viscy-data package.

Purpose: These are the specialized modules for contrastive learning and classification pipelines. triplet.py requires the critical DATA-PKG-03 change (removing viscy-transforms dependency). cell_classification.py and cell_division_triplet.py are straightforward import updates.
Output: 3 new Python modules with lazy optional dependency imports and no viscy-transforms dependency.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-migration/07-01-SUMMARY.md
@packages/viscy-data/src/viscy_data/_typing.py
@packages/viscy-data/src/viscy_data/_utils.py
@packages/viscy-data/src/viscy_data/hcs.py
@packages/viscy-data/src/viscy_data/select.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate triplet.py with BatchedCenterSpatialCropd removal and lazy imports</name>
  <files>packages/viscy-data/src/viscy_data/triplet.py</files>
  <action>
Copy from `git show main:viscy/data/triplet.py` (619 lines) and apply these changes:

**1. Import rewiring:**
- `from viscy.data.hcs import HCSDataModule, _read_norm_meta` → `from viscy_data.hcs import HCSDataModule` (and `from viscy_data._utils import _read_norm_meta`)
- `from viscy.data.select import _filter_fovs, _filter_wells` → `from viscy_data.select import _filter_fovs, _filter_wells`
- `from viscy.data.typing import DictTransform, NormMeta` → `from viscy_data._typing import DictTransform, NormMeta`
- REMOVE: `from viscy.transforms import BatchedCenterSpatialCropd` entirely

**2. Remove extracted functions** that are now in _utils.py:
- Remove `INDEX_COLUMNS` constant definition (already in _typing.py)
- Remove `_scatter_channels()` function definition
- Remove `_gather_channels()` function definition
- Remove `_transform_channel_wise()` function definition
- ADD import: `from viscy_data._utils import _read_norm_meta, _transform_channel_wise`
  (Note: _scatter_channels and _gather_channels are NOT directly called in triplet.py class methods — they are called via _transform_channel_wise. Verify this by searching the file.)

**3. Lazy imports for tensorstore and pandas:**
Replace top-level imports:
```python
import pandas as pd
import tensorstore as ts
```
With lazy import guards at module level:
```python
try:
    import pandas as pd
except ImportError:
    pd = None

try:
    import tensorstore as ts
except ImportError:
    ts = None
```

Then in `TripletDataset.__init__` (the first method that uses these), add checks:
```python
if pd is None:
    raise ImportError(
        "pandas is required for TripletDataset. "
        "Install with: pip install 'viscy-data[triplet]'"
    )
if ts is None:
    raise ImportError(
        "tensorstore is required for TripletDataset. "
        "Install with: pip install 'viscy-data[triplet]'"
    )
```

**4. Replace BatchedCenterSpatialCropd with MONAI CenterSpatialCropd (DATA-PKG-03):**

In `TripletDataModule._final_crop()` method, change:
```python
def _final_crop(self) -> BatchedCenterSpatialCropd:
    """Setup final cropping: center crop to the target size."""
    return BatchedCenterSpatialCropd(
        keys=self.source_channel,
        roi_size=(
            self.z_window_size,
            self.yx_patch_size[0],
            self.yx_patch_size[1],
        ),
    )
```
To:
```python
def _final_crop(self) -> CenterSpatialCropd:
    """Setup final cropping: center crop to the target size."""
    return CenterSpatialCropd(
        keys=self.source_channel,
        roi_size=(
            self.z_window_size,
            self.yx_patch_size[0],
            self.yx_patch_size[1],
        ),
    )
```

`CenterSpatialCropd` is already imported via `from monai.transforms import ..., CenterSpatialCropd, ...` — verify it's in the existing monai imports, and add it if missing.

**Why this works:** The `_final_crop` transform is applied inside `_transform_channel_wise` → `_scatter_channels` → which creates per-channel tensors of shape `(B, 1, Z, Y, X)`. MONAI's `CenterSpatialCropd` applies the crop per dict entry. Since center crop computes slices from spatial dimensions and applies them uniformly, the batch dimension (treated as an extra leading dimension) is preserved correctly.

**5. No other changes.** Keep all class definitions, method signatures, docstrings, and logic unchanged.
  </action>
  <verify>
Run `python -c "from viscy_data.triplet import TripletDataset, TripletDataModule; print('triplet OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/triplet.py`.
Grep for `viscy\.data\.\|viscy\.transforms\|viscy_transforms\|BatchedCenterSpatialCropd` in triplet.py — must find zero matches.
Grep for `CenterSpatialCropd` in triplet.py — must find matches (the replacement).
Grep for `pd is None\|ts is None` in triplet.py — must find matches (lazy import guards).
  </verify>
  <done>
triplet.py importable with TripletDataset and TripletDataModule. BatchedCenterSpatialCropd fully removed and replaced with CenterSpatialCropd. tensorstore and pandas lazily imported. No viscy.data or viscy.transforms references. Ruff passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate cell_classification.py and cell_division_triplet.py</name>
  <files>
    packages/viscy-data/src/viscy_data/cell_classification.py
    packages/viscy-data/src/viscy_data/cell_division_triplet.py
  </files>
  <action>
**cell_classification.py** (~199 lines):
Copy from `git show main:viscy/data/cell_classification.py` and apply:

1. `from viscy.data.hcs import _read_norm_meta` → `from viscy_data._utils import _read_norm_meta`
2. `from viscy.data.triplet import INDEX_COLUMNS` → `from viscy_data._typing import INDEX_COLUMNS`
3. `from viscy.data.typing import AnnotationColumns` → `from viscy_data._typing import AnnotationColumns`

4. Lazy import for pandas:
Replace `import pandas as pd` with:
```python
try:
    import pandas as pd
except ImportError:
    pd = None
```
Add check in `ClassificationDataset.__init__`:
```python
if pd is None:
    raise ImportError(
        "pandas is required for ClassificationDataset. "
        "Install with: pip install 'viscy-data[triplet]'"
    )
```
(Note: pandas is in the [triplet] extra group per pyproject.toml)

No other changes.

**cell_division_triplet.py** (~449 lines):
Copy from `git show main:viscy/data/cell_division_triplet.py` and apply:

1. `from viscy.data.hcs import HCSDataModule` → `from viscy_data.hcs import HCSDataModule`
2. `from viscy.data.triplet import _transform_channel_wise` → `from viscy_data._utils import _transform_channel_wise`
   (Note: _transform_channel_wise was extracted to _utils.py in Phase 6)
3. `from viscy.data.typing import DictTransform, TripletSample` → `from viscy_data._typing import DictTransform, TripletSample`

No optional dependencies in cell_division_triplet.py (it uses numpy, torch, monai — all required deps). No lazy imports needed.

No other changes to either file. Keep all class definitions, methods, docstrings unchanged.
  </action>
  <verify>
Run `python -c "from viscy_data.cell_classification import ClassificationDataset, ClassificationDataModule; print('cell_classification OK')"`.
Run `python -c "from viscy_data.cell_division_triplet import CellDivisionTripletDataset, CellDivisionTripletDataModule; print('cell_division_triplet OK')"`.
Run `uvx ruff check packages/viscy-data/src/viscy_data/cell_classification.py packages/viscy-data/src/viscy_data/cell_division_triplet.py`.
Grep for `viscy\.data\.\|viscy\.transforms` in both files — must find zero matches.
  </verify>
  <done>
cell_classification.py and cell_division_triplet.py importable. pandas lazily imported in cell_classification.py. All imports use viscy_data. prefix. Ruff passes.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All 3 modules importable: `python -c "from viscy_data.triplet import TripletDataModule; from viscy_data.cell_classification import ClassificationDataModule; from viscy_data.cell_division_triplet import CellDivisionTripletDataModule; print('All OK')"`
2. No viscy.data or viscy.transforms references: `grep -r 'viscy\.data\.\|viscy\.transforms' packages/viscy-data/src/viscy_data/triplet.py packages/viscy-data/src/viscy_data/cell_classification.py packages/viscy-data/src/viscy_data/cell_division_triplet.py` returns nothing
3. BatchedCenterSpatialCropd is gone: `grep -r 'BatchedCenterSpatialCropd' packages/viscy-data/src/viscy_data/` returns nothing
4. `uvx ruff check packages/viscy-data/src/viscy_data/` passes
</verification>

<success_criteria>
3 specialized modules exist with correct imports, lazy optional dep loading, and no viscy-transforms dependency. TripletDataModule uses CenterSpatialCropd from MONAI instead of BatchedCenterSpatialCropd. Ruff passes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-migration/07-02-SUMMARY.md`
</output>
