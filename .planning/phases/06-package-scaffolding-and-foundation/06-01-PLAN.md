---
phase: 06-package-scaffolding-and-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-data/pyproject.toml
  - packages/viscy-data/src/viscy_data/__init__.py
  - packages/viscy-data/src/viscy_data/_typing.py
  - packages/viscy-data/src/viscy_data/py.typed
  - packages/viscy-data/tests/__init__.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "`uv pip install -e packages/viscy-data` succeeds from workspace root"
    - "`from viscy_data import Sample, NormMeta` imports without error"
    - "Optional dependency groups `[triplet]`, `[livecell]`, `[mmap]`, `[all]` are declared and installable"
    - "`py.typed` marker exists for type checking support"
  artifacts:
    - path: "packages/viscy-data/pyproject.toml"
      provides: "Build configuration with hatchling, uv-dynamic-versioning, dependencies, optional extras"
      contains: "viscy-data"
    - path: "packages/viscy-data/src/viscy_data/__init__.py"
      provides: "Package entry with re-exports of public types"
      exports: ["Sample", "NormMeta", "ChannelMap", "HCSStackIndex", "DictTransform"]
    - path: "packages/viscy-data/src/viscy_data/_typing.py"
      provides: "All type definitions from viscy/data/typing.py plus DictTransform alias and INDEX_COLUMNS"
      contains: "class Sample"
    - path: "packages/viscy-data/src/viscy_data/py.typed"
      provides: "PEP 561 type checking marker"
    - path: "packages/viscy-data/tests/__init__.py"
      provides: "Test directory initialization"
    - path: "pyproject.toml"
      provides: "Root workspace updated with viscy-data source"
      contains: "viscy-data"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/__init__.py"
      to: "packages/viscy-data/src/viscy_data/_typing.py"
      via: "re-export imports"
      pattern: "from viscy_data._typing import"
    - from: "pyproject.toml"
      to: "packages/viscy-data"
      via: "uv workspace source"
      pattern: "viscy-data.*workspace.*true"
---

<objective>
Create the viscy-data package skeleton with pyproject.toml, type definitions, and workspace integration.

Purpose: Establish the installable package foundation so that `from viscy_data import Sample, NormMeta` works. This is the base that all subsequent data module migration builds upon.
Output: Installable viscy-data package with all type definitions and optional dependency groups declared.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-package-structure/02-01-SUMMARY.md

Source files to copy from main branch (use `git show main:path`):
- `viscy/data/typing.py` — all type definitions (verbatim copy + additions)
- `viscy/data/triplet.py` — INDEX_COLUMNS constant (lines 24-33)

Reference for package structure:
- `packages/viscy-transforms/pyproject.toml` — template for build config
- `packages/viscy-transforms/src/viscy_transforms/__init__.py` — template for init
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create package directory structure with pyproject.toml</name>
  <files>
    packages/viscy-data/pyproject.toml
    packages/viscy-data/src/viscy_data/py.typed
    packages/viscy-data/tests/__init__.py
  </files>
  <action>
Create the directory tree:
```
packages/viscy-data/
  src/viscy_data/
    py.typed       (empty file, PEP 561 marker)
  tests/
    __init__.py    (empty file)
  pyproject.toml
```

Create `pyproject.toml` following the viscy-transforms template (`packages/viscy-transforms/pyproject.toml`) but with viscy-data specifics. Use this exact content:

```toml
[build-system]
build-backend = "hatchling.build"
requires = ["hatchling", "uv-dynamic-versioning"]

[project]
name = "viscy-data"
description = "Data loading and Lightning DataModules for virtual staining microscopy"
readme = "README.md"
keywords = [
  "data loading",
  "deep learning",
  "lightning",
  "microscopy",
  "virtual staining",
]
license = "BSD-3-Clause"
authors = [{ name = "Biohub", email = "compmicro@czbiohub.org" }]
requires-python = ">=3.11"
classifiers = [
  "Development Status :: 4 - Beta",
  "Intended Audience :: Science/Research",
  "License :: OSI Approved :: BSD License",
  "Operating System :: OS Independent",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Programming Language :: Python :: 3.14",
  "Topic :: Scientific/Engineering :: Artificial Intelligence",
  "Topic :: Scientific/Engineering :: Image Processing",
]
dynamic = ["version"]
dependencies = [
  "iohub>=0.3a2",
  "imageio",
  "lightning>=2.3",
  "monai>=1.5.2",
  "numpy>=2.4.1",
  "torch>=2.10",
  "zarr",
]

[project.optional-dependencies]
triplet = ["pandas", "tensorstore"]
livecell = ["pycocotools", "tifffile", "torchvision"]
mmap = ["tensordict"]
all = ["viscy-data[triplet,livecell,mmap]"]

[project.urls]
Homepage = "https://github.com/mehta-lab/VisCy"
Issues = "https://github.com/mehta-lab/VisCy/issues"
Repository = "https://github.com/mehta-lab/VisCy"

[dependency-groups]
dev = [{ include-group = "test" }]
test = ["pandas", "pytest>=9.0.2", "pytest-cov>=7"]

[tool.hatch.version]
source = "uv-dynamic-versioning"

[tool.hatch.build.targets.wheel]
packages = ["src/viscy_data"]

[tool.uv-dynamic-versioning]
vcs = "git"
style = "pep440"
pattern-prefix = "viscy-data-"
fallback-version = "0.0.0"
```

Key details per research spec:
- `dependencies` list includes iohub, imageio, lightning, monai, numpy, torch, zarr (base deps)
- `[project.optional-dependencies]` has triplet, livecell, mmap, all groups
- `[dependency-groups]` has test group with pandas (needed for triplet tests) and pytest
- `pattern-prefix = "viscy-data-"` for independent versioning
- `packages = ["src/viscy_data"]` for src layout
  </action>
  <verify>
Run:
```bash
ls -la packages/viscy-data/src/viscy_data/py.typed
ls -la packages/viscy-data/tests/__init__.py
cat packages/viscy-data/pyproject.toml
```
Confirm all files exist and pyproject.toml has correct content.
  </verify>
  <done>
Directory structure exists. pyproject.toml has hatchling build, uv-dynamic-versioning, all dependencies, and all four optional-dependency groups (triplet, livecell, mmap, all).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create _typing.py with all type definitions and __init__.py with re-exports</name>
  <files>
    packages/viscy-data/src/viscy_data/_typing.py
    packages/viscy-data/src/viscy_data/__init__.py
  </files>
  <action>
Create `_typing.py` by reading source from main branch:
```bash
git show main:viscy/data/typing.py
```

Copy the ENTIRE content of `viscy/data/typing.py` verbatim into `_typing.py`. Then add these two items that the research spec requires:

1. Add the `DictTransform` alias (already present in typing.py, confirm it's there)
2. Add `INDEX_COLUMNS` from `viscy/data/triplet.py` (lines 24-33):
```python
INDEX_COLUMNS = [
    "fov_name",
    "track_id",
    "t",
    "id",
    "parent_track_id",
    "parent_id",
    "z",
    "y",
    "x",
]
```

Add `INDEX_COLUMNS` at the end of the file, after the label dictionaries. Add a comment: `# Extracted from viscy/data/triplet.py for shared access`.

Add an `__all__` list at the top of `_typing.py` (after imports) that exports all public names:
```python
__all__ = [
    "AnnotationColumns",
    "ChannelMap",
    "ChannelNormStats",
    "DictTransform",
    "HCSStackIndex",
    "INDEX_COLUMNS",
    "LABEL_CELL_CYCLE_STATE",
    "LABEL_CELL_DIVISION_STATE",
    "LABEL_CELL_REMODELING_STATE",
    "LABEL_INFECTION_STATE",
    "LevelNormStats",
    "NormMeta",
    "OneOrSeq",
    "Sample",
    "SegmentationSample",
    "TrackingIndex",
    "TripletSample",
]
```

Create `__init__.py` with:
```python
"""VisCy Data - Data loading and Lightning DataModules for virtual staining microscopy.

This package provides PyTorch Lightning DataModules and Datasets for loading
and preprocessing microscopy data in virtual staining workflows.

Public API:
    Type definitions are exported at the package level.
    Example: `from viscy_data import Sample, NormMeta`

Version:
    Use `importlib.metadata.version('viscy-data')` to get version.
"""

from viscy_data._typing import (
    AnnotationColumns,
    ChannelMap,
    ChannelNormStats,
    DictTransform,
    HCSStackIndex,
    INDEX_COLUMNS,
    LABEL_CELL_CYCLE_STATE,
    LABEL_CELL_DIVISION_STATE,
    LABEL_CELL_REMODELING_STATE,
    LABEL_INFECTION_STATE,
    LevelNormStats,
    NormMeta,
    OneOrSeq,
    Sample,
    SegmentationSample,
    TrackingIndex,
    TripletSample,
)

__all__ = [
    "AnnotationColumns",
    "ChannelMap",
    "ChannelNormStats",
    "DictTransform",
    "HCSStackIndex",
    "INDEX_COLUMNS",
    "LABEL_CELL_CYCLE_STATE",
    "LABEL_CELL_DIVISION_STATE",
    "LABEL_CELL_REMODELING_STATE",
    "LABEL_INFECTION_STATE",
    "LevelNormStats",
    "NormMeta",
    "OneOrSeq",
    "Sample",
    "SegmentationSample",
    "TrackingIndex",
    "TripletSample",
]
```

Note: The `typing_extensions` import for `NotRequired` in the source file should be kept as-is. Python >=3.11 has `NotRequired` in `typing` but the existing code uses `typing_extensions` -- keep it for compatibility with the original code. (The executor may update this if they see fit, since we require >=3.11.)
  </action>
  <verify>
Run:
```bash
# Verify _typing.py has all expected names
python -c "from viscy_data._typing import Sample, NormMeta, DictTransform, INDEX_COLUMNS, ChannelMap, HCSStackIndex; print('_typing imports OK')"

# Verify __init__.py re-exports work
python -c "from viscy_data import Sample, NormMeta, DictTransform, INDEX_COLUMNS; print('Package imports OK')"
```
  </verify>
  <done>
`_typing.py` contains all type definitions from `viscy/data/typing.py` plus `INDEX_COLUMNS` from triplet.py. `__init__.py` re-exports all public types. `from viscy_data import Sample, NormMeta` works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update root pyproject.toml and verify editable install</name>
  <files>
    pyproject.toml
  </files>
  <action>
Update the root `pyproject.toml` to include viscy-data as a workspace dependency:

1. Add `"viscy-data"` to the `dependencies` list (alongside existing `"viscy-transforms"`):
```toml
dependencies = ["viscy-transforms", "viscy-data"]
```

2. Add viscy-data to `[tool.uv.sources]`:
```toml
[tool.uv.sources]
viscy-transforms = { workspace = true }
viscy-data = { workspace = true }
```

Then run:
```bash
uv sync
uv pip install -e packages/viscy-data
```

Verify the full import chain works:
```bash
uv run python -c "from viscy_data import Sample, NormMeta, ChannelMap, HCSStackIndex, DictTransform, INDEX_COLUMNS; print('All imports OK')"
uv run python -c "from viscy_data import LABEL_INFECTION_STATE, TripletSample, SegmentationSample; print('Label imports OK')"
uv run python -c "import importlib.metadata; print(f'Version: {importlib.metadata.version(\"viscy-data\")}')"
```
  </action>
  <verify>
Run:
```bash
uv pip install -e packages/viscy-data
uv run python -c "from viscy_data import Sample, NormMeta; print('SUCCESS')"
uv run python -c "from viscy_data._typing import INDEX_COLUMNS; print(f'INDEX_COLUMNS has {len(INDEX_COLUMNS)} entries')"
```
All commands must succeed without error.
  </verify>
  <done>
Root pyproject.toml has viscy-data as workspace dependency. `uv pip install -e packages/viscy-data` succeeds. `from viscy_data import Sample, NormMeta` works. Optional dependency groups are declared and parseable.
  </done>
</task>

</tasks>

<verification>
1. `uv pip install -e packages/viscy-data` succeeds
2. `from viscy_data import Sample, NormMeta` works
3. `from viscy_data import DictTransform, INDEX_COLUMNS, ChannelMap` works
4. `py.typed` marker exists at `packages/viscy-data/src/viscy_data/py.typed`
5. pyproject.toml declares `[triplet]`, `[livecell]`, `[mmap]`, `[all]` optional groups
6. Root pyproject.toml references viscy-data as workspace member
</verification>

<success_criteria>
- Package skeleton exists at `packages/viscy-data/src/viscy_data/`
- All type definitions importable via `from viscy_data import X`
- Optional dependency groups declared in pyproject.toml
- Root workspace recognizes viscy-data
- Editable install succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-package-scaffolding-and-foundation/06-01-SUMMARY.md`
</output>
