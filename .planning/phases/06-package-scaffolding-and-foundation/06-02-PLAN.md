---
phase: 06-package-scaffolding-and-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/viscy-data/src/viscy_data/_utils.py
  - packages/viscy-data/src/viscy_data/__init__.py
autonomous: true

must_haves:
  truths:
    - "`_utils.py` contains `_ensure_channel_list`, `_read_norm_meta`, `_collate_samples`, `_search_int_in_str` extracted from hcs.py"
    - "`_utils.py` contains `_scatter_channels`, `_gather_channels`, `_transform_channel_wise` extracted from triplet.py"
    - "All utility functions importable as `from viscy_data._utils import X`"
    - "Utility functions have correct type annotations referencing `viscy_data._typing` types"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/_utils.py"
      provides: "Shared utility functions extracted from hcs.py and triplet.py"
      exports: ["_ensure_channel_list", "_read_norm_meta", "_collate_samples", "_search_int_in_str", "_scatter_channels", "_gather_channels", "_transform_channel_wise"]
  key_links:
    - from: "packages/viscy-data/src/viscy_data/_utils.py"
      to: "packages/viscy-data/src/viscy_data/_typing.py"
      via: "type imports"
      pattern: "from viscy_data._typing import"
---

<objective>
Extract shared utility functions from hcs.py and triplet.py into `_utils.py` within the viscy-data package.

Purpose: Prevent hcs.py from serving as both a module and a utility library. Centralizing shared helpers (`_ensure_channel_list`, `_read_norm_meta`, `_collate_samples`, `_scatter_channels`, etc.) enables all data modules to import from a single location during Phase 7 migration.
Output: `_utils.py` with 7 extracted utility functions, all importable and correctly typed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-package-scaffolding-and-foundation/06-01-SUMMARY.md

Source files to extract from (use `git show main:path`):
- `viscy/data/hcs.py` — _ensure_channel_list (line 32), _search_int_in_str (line 50), _collate_samples (line 60), _read_norm_meta (line 80)
- `viscy/data/triplet.py` — _scatter_channels (line 37), _gather_channels (line 49), _transform_channel_wise (line 56)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create _utils.py with utility functions extracted from hcs.py and triplet.py</name>
  <files>
    packages/viscy-data/src/viscy_data/_utils.py
  </files>
  <action>
Create `_utils.py` with all 7 shared utility functions. Read sources from main branch:
```bash
git show main:viscy/data/hcs.py
git show main:viscy/data/triplet.py
```

The file should have these sections in order:

1. **Module docstring** explaining this is shared utilities extracted from hcs.py and triplet.py
2. **Imports** — update all type imports to use `viscy_data._typing` instead of `viscy.data.typing`:
   ```python
   import re
   from typing import Sequence

   import torch
   from iohub.ngff import Position
   from monai.data.utils import collate_meta_tensor
   from torch import Tensor

   from viscy_data._typing import DictTransform, NormMeta, Sample
   ```
3. **`__all__`** listing all 7 functions
4. **From hcs.py** (copy verbatim, only change imports):
   - `_ensure_channel_list(str_or_seq)` — ensures channel arg is list of strings
   - `_search_int_in_str(pattern, file_name)` — regex search for int patterns in filenames
   - `_collate_samples(batch)` — collates sequence of Sample dicts into batch
   - `_read_norm_meta(fov)` — reads normalization metadata from FOV position
5. **From triplet.py** (copy verbatim, only change imports):
   - `_scatter_channels(channel_names, patch, norm_meta)` — splits tensor into per-channel dict
   - `_gather_channels(patch_channels)` — recombines per-channel dict into tensor
   - `_transform_channel_wise(transform, channel_names, patch, norm_meta)` — applies transform per channel

Important:
- Keep ALL existing docstrings and type annotations exactly as in source
- Only change import paths (e.g., `from viscy.data.typing import ...` becomes `from viscy_data._typing import ...`)
- Remove `from viscy.transforms import BatchedCenterSpatialCropd` — not needed in utils
- The `_collate_samples` function uses `collate_meta_tensor` from monai — keep that import
- The `_read_norm_meta` function uses `Position` from iohub and `Tensor` from torch — keep those imports
- The `_scatter_channels` function uses `collate_meta_tensor` — already imported above
  </action>
  <verify>
Run:
```bash
uv run python -c "
from viscy_data._utils import (
    _ensure_channel_list,
    _search_int_in_str,
    _collate_samples,
    _read_norm_meta,
    _scatter_channels,
    _gather_channels,
    _transform_channel_wise,
)
print('All 7 utils imported OK')

# Quick functional test
assert _ensure_channel_list('Phase') == ['Phase']
assert _ensure_channel_list(['Phase', 'Nuclei']) == ['Phase', 'Nuclei']
print('_ensure_channel_list works')

assert _search_int_in_str(r'\d+', 'img_003.tif') == '003'
print('_search_int_in_str works')
"
```
  </verify>
  <done>
`_utils.py` contains all 7 utility functions with correct imports referencing `viscy_data._typing`. Functions are importable and basic functional tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify complete package with types and utilities</name>
  <files>
    packages/viscy-data/src/viscy_data/__init__.py
  </files>
  <action>
Run a comprehensive verification of the complete Phase 6 package:

1. Verify the full import chain:
```bash
uv run python -c "
# Types from __init__.py
from viscy_data import Sample, NormMeta, ChannelMap, HCSStackIndex, DictTransform, INDEX_COLUMNS
print(f'Types OK: Sample={Sample}, INDEX_COLUMNS has {len(INDEX_COLUMNS)} entries')

# Utils from _utils.py
from viscy_data._utils import _ensure_channel_list, _read_norm_meta, _collate_samples
from viscy_data._utils import _scatter_channels, _gather_channels, _transform_channel_wise
from viscy_data._utils import _search_int_in_str
print('Utils OK: all 7 functions imported')

# py.typed marker
import pathlib, viscy_data
pkg_dir = pathlib.Path(viscy_data.__file__).parent
assert (pkg_dir / 'py.typed').exists(), 'py.typed missing'
print('py.typed marker present')

# Version
import importlib.metadata
ver = importlib.metadata.version('viscy-data')
print(f'Version: {ver}')

print('\\nAll Phase 6 verification passed!')
"
```

2. Verify optional dependency groups are parseable:
```bash
uv pip install -e "packages/viscy-data" --dry-run 2>&1 | head -5
```

3. If `__init__.py` needs any updates (e.g., adding a note about `_utils` being available), make minimal changes. Do NOT re-export underscore-prefixed utility functions from `__init__.py` — they are internal API accessed via `from viscy_data._utils import X`.

4. Run pre-commit/linting if available:
```bash
uvx ruff check packages/viscy-data/src/viscy_data/ --fix
uvx ruff format packages/viscy-data/src/viscy_data/
```
  </action>
  <verify>
Run:
```bash
uv run python -c "from viscy_data import Sample, NormMeta; from viscy_data._utils import _ensure_channel_list, _read_norm_meta, _collate_samples; print('PASS')"
```
Must print "PASS" without errors.
  </verify>
  <done>
Complete viscy-data package verified: types importable from package level, utilities importable from `_utils`, `py.typed` present, linting passes. Phase 6 success criteria fully met.
  </done>
</task>

</tasks>

<verification>
1. `from viscy_data._utils import _ensure_channel_list, _read_norm_meta, _collate_samples, _search_int_in_str` works
2. `from viscy_data._utils import _scatter_channels, _gather_channels, _transform_channel_wise` works
3. `_ensure_channel_list('Phase')` returns `['Phase']`
4. `_search_int_in_str(r'\d+', 'img_003.tif')` returns `'003'`
5. All utility functions have correct type annotations using `viscy_data._typing` types
6. Package passes ruff linting
</verification>

<success_criteria>
- `_utils.py` exists with all 7 extracted utility functions
- All functions importable via `from viscy_data._utils import X`
- Functions use `viscy_data._typing` for type imports (not `viscy.data.typing`)
- Basic functional tests pass for `_ensure_channel_list` and `_search_int_in_str`
- Combined with Plan 01, all Phase 6 success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/06-package-scaffolding-and-foundation/06-02-SUMMARY.md`
</output>
