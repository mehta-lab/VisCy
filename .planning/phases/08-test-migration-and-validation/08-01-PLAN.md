---
phase: 08-test-migration-and-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-data/tests/conftest.py
  - packages/viscy-data/tests/test_hcs.py
  - packages/viscy-data/tests/test_triplet.py
  - packages/viscy-data/tests/test_select.py
autonomous: true

must_haves:
  truths:
    - "`uv run --package viscy-data pytest packages/viscy-data/tests/test_hcs.py` passes all HCS tests"
    - "`uv run --package viscy-data pytest packages/viscy-data/tests/test_triplet.py` passes all triplet tests"
    - "`uv run --package viscy-data pytest packages/viscy-data/tests/test_select.py` passes all select tests"
    - "All test imports use `from viscy_data import X` (no `from viscy.data` references)"
  artifacts:
    - path: "packages/viscy-data/tests/conftest.py"
      provides: "HCS OME-Zarr fixtures (preprocessed_hcs_dataset, small_hcs_dataset, tracks_hcs_dataset, tracks_with_gaps_dataset)"
      contains: "_build_hcs"
    - path: "packages/viscy-data/tests/test_hcs.py"
      provides: "HCSDataModule fit/predict tests"
      contains: "from viscy_data import HCSDataModule"
    - path: "packages/viscy-data/tests/test_triplet.py"
      provides: "TripletDataModule/TripletDataset tests"
      contains: "from viscy_data import TripletDataModule"
    - path: "packages/viscy-data/tests/test_select.py"
      provides: "SelectWell filter tests"
      contains: "from viscy_data import SelectWell"
  key_links:
    - from: "packages/viscy-data/tests/test_hcs.py"
      to: "packages/viscy-data/src/viscy_data/hcs.py"
      via: "from viscy_data import HCSDataModule"
      pattern: "from viscy_data import HCSDataModule"
    - from: "packages/viscy-data/tests/test_triplet.py"
      to: "packages/viscy-data/src/viscy_data/triplet.py"
      via: "from viscy_data import TripletDataModule, TripletDataset"
      pattern: "from viscy_data import TripletDataModule"
    - from: "packages/viscy-data/tests/test_select.py"
      to: "packages/viscy-data/src/viscy_data/select.py"
      via: "from viscy_data import SelectWell"
      pattern: "from viscy_data import SelectWell"
---

<objective>
Migrate all three existing data test files (test_hcs.py, test_triplet.py, test_select.py) and their shared conftest.py fixtures into the viscy-data package test directory with updated import paths.

Purpose: Satisfies DATA-TST-01 -- all existing data tests pass under the new package structure.
Output: Four test files in `packages/viscy-data/tests/` that pass with `uv run --package viscy-data pytest`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Source files (read from main branch with `git show main:...`):
- `git show main:tests/conftest.py` -- HCS fixture builder and session-scoped fixtures
- `git show main:tests/data/test_hcs.py` -- HCSDataModule tests
- `git show main:tests/data/test_triplet.py` -- TripletDataModule/TripletDataset tests
- `git show main:tests/data/test_select.py` -- SelectWell tests

Target package:
- @packages/viscy-data/src/viscy_data/__init__.py (public API with 45 exports)
- @packages/viscy-data/pyproject.toml (test dependency group has pandas, pytest, pytest-cov)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conftest.py with HCS OME-Zarr fixtures</name>
  <files>packages/viscy-data/tests/conftest.py</files>
  <action>
Read `git show main:tests/conftest.py` to get the source conftest.

Create `packages/viscy-data/tests/conftest.py` based on the main branch conftest with these changes:

1. **Keep all imports as-is** -- the conftest uses `iohub`, `numpy`, `pandas`, and `pytest` directly (no viscy imports needed).

2. **Copy the following fixtures verbatim** (no import changes needed):
   - `channel_names` module-level list: `["Phase", "Retardance", "GFP", "DAPI"]`
   - `_build_hcs()` helper function (builds HCS OME-Zarr stores)
   - `preprocessed_hcs_dataset` (session-scoped) -- 2x4x4 HCS, 12x256x256, float32 with norm metadata
   - `small_hcs_dataset` (function-scoped, parametrized [False, True] for sharding)
   - `small_hcs_labels` (function-scoped) -- nuclei + membrane labels
   - `labels_hcs_dataset` (function-scoped) -- DAPI + GFP, 2x16x16
   - `tracks_hcs_dataset` (function-scoped) -- HCS + tracks.csv per FOV
   - `tracks_with_gaps_dataset` (function-scoped) -- HCS + tracks with temporal gaps

3. **No import path changes** are needed in conftest.py since it only uses third-party libraries (iohub, numpy, pandas, pytest), not viscy imports.

4. Verify the file has `from __future__ import annotations` at the top.
  </action>
  <verify>
Run: `python -c "import ast; ast.parse(open('packages/viscy-data/tests/conftest.py').read()); print('syntax OK')"`
Verify: No `viscy` or `viscy.data` imports exist in the file.
  </verify>
  <done>conftest.py exists at packages/viscy-data/tests/conftest.py with all 6 fixtures and _build_hcs helper, no viscy imports.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_hcs.py, test_triplet.py, and test_select.py with updated imports</name>
  <files>
packages/viscy-data/tests/test_hcs.py
packages/viscy-data/tests/test_triplet.py
packages/viscy-data/tests/test_select.py
  </files>
  <action>
Read source files from main branch:
- `git show main:tests/data/test_hcs.py`
- `git show main:tests/data/test_triplet.py`
- `git show main:tests/data/test_select.py`

For each file, create the target in `packages/viscy-data/tests/` with these import changes:

**test_hcs.py:**
- `from viscy.data.hcs import HCSDataModule` -> `from viscy_data import HCSDataModule`
- All other imports (iohub, monai, pytest) remain unchanged.

**test_triplet.py:**
- `from viscy.data.triplet import TripletDataModule, TripletDataset` -> `from viscy_data import TripletDataModule, TripletDataset`
- All other imports (pandas, iohub, pytest) remain unchanged.

**test_select.py:**
- `from viscy.data.select import SelectWell` -> `from viscy_data import SelectWell`
- `from iohub.ngff import open_ome_zarr` -- keep as-is (third-party import).
- All other imports (pytest) remain unchanged.

**Important:** Copy all test function bodies EXACTLY -- do not modify test logic, assertions, parametrize decorators, or fixture references. The only changes are the import lines at the top of each file.
  </action>
  <verify>
Run all three test files:
```
uv run --package viscy-data pytest packages/viscy-data/tests/test_hcs.py packages/viscy-data/tests/test_triplet.py packages/viscy-data/tests/test_select.py -v
```
All tests must pass. Verify no `from viscy.data` or `from viscy.` imports remain:
```
grep -r "from viscy\." packages/viscy-data/tests/
```
Should return empty.
  </verify>
  <done>All three test files exist in packages/viscy-data/tests/ with updated imports. `uv run --package viscy-data pytest` passes all tests with zero failures. No `from viscy.` imports remain.</done>
</task>

</tasks>

<verification>
Full test suite verification:
```bash
uv run --package viscy-data pytest packages/viscy-data/tests/test_hcs.py packages/viscy-data/tests/test_triplet.py packages/viscy-data/tests/test_select.py -v --tb=short
```

Import path audit:
```bash
grep -rn "from viscy\." packages/viscy-data/tests/
# Must return empty -- no old import paths allowed
```

Fixture availability check:
```bash
uv run --package viscy-data pytest packages/viscy-data/tests/ --collect-only -q
# Should show all test items collected
```
</verification>

<success_criteria>
1. `uv run --package viscy-data pytest packages/viscy-data/tests/test_hcs.py` -- all pass
2. `uv run --package viscy-data pytest packages/viscy-data/tests/test_triplet.py` -- all pass
3. `uv run --package viscy-data pytest packages/viscy-data/tests/test_select.py` -- all pass
4. Zero `from viscy.` imports in packages/viscy-data/tests/
5. DATA-TST-01 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-test-migration-and-validation/08-01-SUMMARY.md`
</output>
