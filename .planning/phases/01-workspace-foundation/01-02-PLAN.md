---
phase: 01-workspace-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .pre-commit-config.yaml
autonomous: true

must_haves:
  truths:
    - "`uvx prek install` completes without errors"
    - "`uvx prek run --all-files` passes (ruff-check, ruff-format, ty)"
    - "Pre-commit hooks trigger on staged Python files"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration for ruff and ty"
      contains: "ruff-pre-commit"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "pyproject.toml [tool.ruff]"
      via: "ruff hooks read config from pyproject.toml"
      pattern: "ruff-check"
    - from: ".pre-commit-config.yaml"
      to: "pyproject.toml [tool.ty]"
      via: "ty hook reads config from pyproject.toml"
      pattern: "uvx ty check"
---

<objective>
Configure pre-commit hooks with ruff and ty for local development quality gates.

Purpose: Establish automated code quality checks that run on staged files before commit, ensuring consistent formatting (ruff-format), linting (ruff-check), and type checking (ty) across the workspace.

Output: Working `.pre-commit-config.yaml` that can be installed with `uvx prek install` and passes on current (empty) codebase.
</objective>

<execution_context>
@/Users/sricharan.varra/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sricharan.varra/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-workspace-foundation/01-CONTEXT.md
@.planning/phases/01-workspace-foundation/01-RESEARCH.md
@.planning/phases/01-workspace-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-commit configuration</name>
  <files>.pre-commit-config.yaml</files>
  <action>
Create `.pre-commit-config.yaml` with configuration compatible with both `prek` and `pre-commit`:

**Structure:**
```yaml
# Pre-commit hooks for VisCy workspace
# Compatible with both prek (recommended) and pre-commit
# Install: uvx prek install
# Run all: uvx prek run --all-files

repos:
  # Ruff linting and formatting (Astral-maintained)
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.14
    hooks:
      - id: ruff-check
        args: [--fix]
      - id: ruff-format

  # ty type checking (local hook - no official pre-commit repo yet)
  - repo: local
    hooks:
      - id: ty
        name: ty type checker
        entry: uvx ty check
        language: system
        types: [python]
        pass_filenames: false
```

**Important notes:**
- Use ruff-pre-commit v0.14.14 (matches version in pyproject.toml)
- ruff-check runs first with --fix to auto-correct fixable issues
- ruff-format runs second to ensure formatting
- ty uses local hook with `uvx ty check` (no official pre-commit repo yet per RESEARCH.md)
- `pass_filenames: false` for ty because it scans the entire project
- Configuration for ruff and ty read from root pyproject.toml
  </action>
  <verify>
```bash
# Verify YAML syntax
uv --no-project run python -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml'))" && echo "Valid YAML"

# Verify ruff-pre-commit repo accessible
curl -sI https://github.com/astral-sh/ruff-pre-commit | head -1
```
  </verify>
  <done>.pre-commit-config.yaml exists with ruff-check, ruff-format, and ty hooks configured</done>
</task>

<task type="auto">
  <name>Task 2: Install and verify hooks</name>
  <files>None (git hooks installed)</files>
  <action>
Install pre-commit hooks using prek:

```bash
uvx prek install
```

This installs the git hooks in `.git/hooks/pre-commit`.

Verify hooks work by running them manually:

```bash
uvx prek run --all-files
```

Expected output: All hooks pass (ruff-check, ruff-format, ty) since there are no Python files to check yet.

If ty hook fails due to no Python files:
- This is acceptable for now
- Hooks will work once Python files are added in Phase 2

Troubleshooting:
- If prek install fails, ensure git is initialized
- If ruff-check fails, verify pyproject.toml [tool.ruff] section exists
- If ty fails with "no files", this is expected (empty workspace)
  </action>
  <verify>
```bash
# Verify hooks installed
test -f .git/hooks/pre-commit && echo "pre-commit hook installed" || echo "hook not found"

# Run hooks (may show "no files" for ty, which is OK)
uvx prek run --all-files 2>&1 | tail -20
```
  </verify>
  <done>Pre-commit hooks installed via prek, ruff hooks pass, ty hook configured (may skip with no Python files)</done>
</task>

<task type="auto">
  <name>Task 3: Commit pre-commit configuration</name>
  <files>None (commit only)</files>
  <action>
Commit the pre-commit configuration:

```bash
git add .pre-commit-config.yaml
git commit -m "feat(01-02): configure pre-commit hooks with ruff and ty

- Add ruff-check hook with --fix for auto-corrections
- Add ruff-format hook for consistent formatting
- Add ty type checker as local hook (no official pre-commit repo yet)
- Compatible with both prek and pre-commit runners

Requirements: WORK-04

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

Run the hooks one more time to confirm they pass after commit:

```bash
uvx prek run --all-files
```
  </action>
  <verify>
```bash
# Verify commit
git log --oneline -1

# Verify pre-commit config tracked
git ls-files | grep pre-commit

# Final hook verification
uvx prek run --all-files 2>&1
```
  </verify>
  <done>Pre-commit configuration committed, hooks pass on clean workspace</done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
echo "=== Pre-commit Configuration ==="
cat .pre-commit-config.yaml

echo -e "\n=== Verify Hooks Installed ==="
test -f .git/hooks/pre-commit && echo "✓ Git hook installed" || echo "✗ Git hook missing"

echo -e "\n=== Run All Hooks ==="
uvx prek run --all-files

echo -e "\n=== Verify Git Tracking ==="
git status

echo -e "\n=== Phase 1 Complete Verification ==="
echo "Checking all ROADMAP success criteria:"
echo "1. Clean slate (LICENSE, CITATION.cff, .gitignore, new structure):"
ls -la | grep -E "(LICENSE|CITATION|gitignore|pyproject|packages|scripts)"

echo -e "\n2. uv sync works:"
uv sync --dry-run 2>&1 | tail -3

echo -e "\n3. prek passes:"
uvx prek run --all-files 2>&1 | tail -5

echo -e "\n4. Python 3.11+ enforced:"
uv --no-project run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['requires-python'])"

echo -e "\n5. packages/ is workspace member:"
uv --no-project run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['tool']['uv']['workspace'])"
```
</verification>

<success_criteria>
1. `.pre-commit-config.yaml` exists with ruff and ty hooks
2. `uvx prek install` completes without errors
3. `uvx prek run --all-files` passes (or shows "no files to check" for ty)
4. Git hook installed at `.git/hooks/pre-commit`
5. Configuration committed to git
6. All Phase 1 ROADMAP success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/01-workspace-foundation/01-02-SUMMARY.md`
</output>
