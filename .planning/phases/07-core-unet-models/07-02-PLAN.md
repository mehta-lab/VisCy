---
phase: 07-core-unet-models
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/viscy-models/src/viscy_models/unet/fcmae.py
  - packages/viscy-models/src/viscy_models/unet/__init__.py
  - packages/viscy-models/tests/test_unet/test_fcmae.py
autonomous: true

must_haves:
  truths:
    - "from viscy_models.unet import FullyConvolutionalMAE succeeds without error"
    - "FCMAE forward pass produces correct output shape and returns (output, mask) tuple when pretraining=True"
    - "FCMAE forward pass returns output tensor only when pretraining=False"
    - "All 11 existing FCMAE tests pass with updated import paths"
    - "Mutable list defaults in FCMAE constructor are replaced with tuples"
  artifacts:
    - path: "packages/viscy-models/src/viscy_models/unet/fcmae.py"
      provides: "FullyConvolutionalMAE and all FCMAE-specific helper classes/functions"
      contains: "class FullyConvolutionalMAE"
    - path: "packages/viscy-models/tests/test_unet/test_fcmae.py"
      provides: "11 migrated FCMAE tests"
      min_lines: 100
    - path: "packages/viscy-models/src/viscy_models/unet/__init__.py"
      provides: "Public exports of both UNeXt2 and FullyConvolutionalMAE"
      contains: "FullyConvolutionalMAE"
  key_links:
    - from: "packages/viscy-models/src/viscy_models/unet/fcmae.py"
      to: "viscy_models.components.blocks"
      via: "from viscy_models.components.blocks import UNeXt2Decoder"
      pattern: "from viscy_models.components.blocks import UNeXt2Decoder"
    - from: "packages/viscy-models/src/viscy_models/unet/fcmae.py"
      to: "viscy_models.components.heads"
      via: "from viscy_models.components.heads import PixelToVoxelHead, PixelToVoxelShuffleHead"
      pattern: "from viscy_models.components.heads import PixelToVoxelHead, PixelToVoxelShuffleHead"
    - from: "packages/viscy-models/src/viscy_models/unet/__init__.py"
      to: "viscy_models.unet.fcmae"
      via: "from viscy_models.unet.fcmae import FullyConvolutionalMAE"
      pattern: "from viscy_models.unet.fcmae import FullyConvolutionalMAE"
---

<objective>
Migrate FullyConvolutionalMAE model to viscy-models, fix mutable defaults, migrate 11 existing tests, and finalize unet/__init__.py exports.

Purpose: FCMAE is the second core UNet architecture. It has existing test coverage that must be preserved. The migration also completes the unet subpackage public API for Phase 7.
Output: Working FCMAE import from viscy_models.unet with all 11 tests passing.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-unet-models/07-RESEARCH.md
@.planning/phases/07-core-unet-models/07-01-SUMMARY.md
@packages/viscy-models/src/viscy_models/components/__init__.py
@packages/viscy-models/src/viscy_models/unet/__init__.py
@packages/viscy-models/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate FCMAE to unet/fcmae.py with mutable default fixes</name>
  <files>
    packages/viscy-models/src/viscy_models/unet/fcmae.py
    packages/viscy-models/src/viscy_models/unet/__init__.py
  </files>
  <action>
Create `packages/viscy-models/src/viscy_models/unet/fcmae.py` by copying the FCMAE source from main branch (`viscy/unet/networks/fcmae.py`).

This file contains 10 FCMAE-specific items (5 functions + 5 classes) that ALL stay in fcmae.py. Copy ALL of them:
- Functions: `_init_weights`, `generate_mask`, `upsample_mask`, `masked_patchify`, `masked_unpatchify`
- Classes: `MaskedConvNeXtV2Block`, `MaskedConvNeXtV2Stage`, `MaskedAdaptiveProjection`, `MaskedMultiscaleEncoder`, `FullyConvolutionalMAE`

Import changes (the ONLY code changes from original):

1. Replace the old import:
   ```python
   from viscy.unet.networks.unext2 import PixelToVoxelHead, UNeXt2Decoder
   ```
   With two new imports:
   ```python
   from viscy_models.components.blocks import UNeXt2Decoder
   from viscy_models.components.heads import PixelToVoxelHead, PixelToVoxelShuffleHead
   ```

2. REMOVE the `PixelToVoxelShuffleHead` class definition from fcmae.py entirely. It was duplicated in the original but was extracted to `components/heads.py` in Phase 6. Import it instead (already included in the import line above).

3. Fix two mutable defaults in `FullyConvolutionalMAE.__init__`:
   - `encoder_blocks: Sequence[int] = [3, 3, 9, 3]` becomes `encoder_blocks: Sequence[int] = (3, 3, 9, 3)`
   - `dims: Sequence[int] = [96, 192, 384, 768]` becomes `dims: Sequence[int] = (96, 192, 384, 768)`
   This is safe because internal code uses `list(dims)` or iterates over them, and `Sequence[int]` accepts both list and tuple.

All other code stays EXACTLY as-is. Do NOT rename any attributes. Critical attribute names:
- `self.encoder` (NOT encoder_stages -- FCMAE uses `encoder`, UNeXt2 uses `encoder_stages`)
- `self.decoder`, `self.head`
- `self.out_stack_depth`, `self.num_blocks`, `self.pretraining`

Keep the module docstring from the original (the ConvNeXt V2 description).

All other imports from timm stay exactly as-is:
```python
from timm.models.convnext import (
    Downsample,
    DropPath,
    GlobalResponseNormMlp,
    LayerNorm2d,
    create_conv2d,
    trunc_normal_,
)
```

Then update `packages/viscy-models/src/viscy_models/unet/__init__.py` to export BOTH models:
```python
"""UNet family architectures."""

from viscy_models.unet.fcmae import FullyConvolutionalMAE
from viscy_models.unet.unext2 import UNeXt2

__all__ = ["UNeXt2", "FullyConvolutionalMAE"]
```

Run `uv run --package viscy-models python -c "from viscy_models.unet import FullyConvolutionalMAE; print('OK')"` to verify.
  </action>
  <verify>
`uv run --package viscy-models python -c "from viscy_models.unet import FullyConvolutionalMAE, UNeXt2; print(FullyConvolutionalMAE.__name__, UNeXt2.__name__)"` prints "FullyConvolutionalMAE UNeXt2".
`uv run --package viscy-models python -c "from viscy_models.unet.fcmae import FullyConvolutionalMAE; import inspect; sig = inspect.signature(FullyConvolutionalMAE); print(sig.parameters['encoder_blocks'].default, sig.parameters['dims'].default)"` prints tuples (not lists).
  </verify>
  <done>FullyConvolutionalMAE is importable from viscy_models.unet. Mutable defaults fixed to tuples. PixelToVoxelShuffleHead imported from components (not redefined). unet/__init__.py exports both UNeXt2 and FullyConvolutionalMAE.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate 11 FCMAE tests with updated imports</name>
  <files>packages/viscy-models/tests/test_unet/test_fcmae.py</files>
  <action>
Create `packages/viscy-models/tests/test_unet/test_fcmae.py` by copying the existing tests from main branch (`tests/unet/test_fcmae.py`) with import path updates.

Import changes:
- Replace `from viscy.unet.networks.fcmae import (...)` with `from viscy_models.unet.fcmae import (...)`
- For `PixelToVoxelShuffleHead`: import from `viscy_models.components.heads` since it is no longer defined in fcmae.py. Change:
  ```python
  from viscy_models.unet.fcmae import (
      FullyConvolutionalMAE,
      MaskedAdaptiveProjection,
      MaskedConvNeXtV2Block,
      MaskedConvNeXtV2Stage,
      MaskedMultiscaleEncoder,
      generate_mask,
      masked_patchify,
      masked_unpatchify,
      upsample_mask,
  )
  from viscy_models.components.heads import PixelToVoxelShuffleHead
  ```

ALL 11 test functions stay EXACTLY as-is (no changes to test logic, assertions, or parameters):
1. `test_generate_mask`
2. `test_masked_patchify`
3. `test_unmasked_patchify_roundtrip`
4. `test_masked_patchify_roundtrip`
5. `test_masked_convnextv2_block`
6. `test_masked_convnextv2_stage`
7. `test_adaptive_projection`
8. `test_masked_multiscale_encoder`
9. `test_pixel_to_voxel_shuffle_head`
10. `test_fcmae`
11. `test_fcmae_head_conv`

Do NOT add the `device` fixture to these tests -- the original tests all use CPU tensors without a device fixture, and that is intentional for FCMAE tests (they are fast enough on CPU).
  </action>
  <verify>
`uv run --package viscy-models pytest packages/viscy-models/tests/test_unet/test_fcmae.py -v` shows all 11 tests passing.
`uv run --package viscy-models pytest packages/viscy-models/tests/ -v` shows ALL tests passing (20 from Phase 6 + 6 from Plan 01 + 11 from this plan = 37 total).
  </verify>
  <done>All 11 FCMAE tests pass with updated import paths. No test logic changes. PixelToVoxelShuffleHead imported from components.heads canonical location.</done>
</task>

</tasks>

<verification>
1. `uv run --package viscy-models python -c "from viscy_models.unet import UNeXt2, FullyConvolutionalMAE; print('both imports OK')"` succeeds
2. `uv run --package viscy-models pytest packages/viscy-models/tests/test_unet/test_fcmae.py -v` -- all 11 tests pass
3. `uv run --package viscy-models pytest packages/viscy-models/tests/ -v` -- all ~37 tests pass (no regression)
4. Verify mutable defaults fixed: `python -c "from viscy_models.unet.fcmae import FullyConvolutionalMAE; import inspect; sig = inspect.signature(FullyConvolutionalMAE); assert isinstance(sig.parameters['dims'].default, tuple)"`
</verification>

<success_criteria>
- FullyConvolutionalMAE is importable from `viscy_models.unet`
- All 11 existing FCMAE tests pass with zero test logic changes
- `encoder_blocks` and `dims` defaults are tuples (not lists)
- `PixelToVoxelShuffleHead` is imported from `components.heads`, not redefined
- `unet/__init__.py` exports both `UNeXt2` and `FullyConvolutionalMAE`
- All ~37 tests pass across the full test suite
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-unet-models/07-02-SUMMARY.md`
</output>
