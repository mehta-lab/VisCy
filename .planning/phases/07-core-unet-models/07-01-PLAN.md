---
phase: 07-core-unet-models
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-models/src/viscy_models/unet/unext2.py
  - packages/viscy-models/src/viscy_models/unet/__init__.py
  - packages/viscy-models/tests/test_unet/test_unext2.py
autonomous: true

must_haves:
  truths:
    - "from viscy_models.unet import UNeXt2 succeeds without error"
    - "UNeXt2 forward pass produces correct output shape (B, out_ch, out_depth, H, W)"
    - "UNeXt2 tests cover multiple configurations: default backbone, small backbone, multichannel, different depths"
    - "UNeXt2 constructor rejects invalid stem kernel vs stack depth combinations"
  artifacts:
    - path: "packages/viscy-models/src/viscy_models/unet/unext2.py"
      provides: "UNeXt2 nn.Module class"
      contains: "class UNeXt2"
    - path: "packages/viscy-models/tests/test_unet/test_unext2.py"
      provides: "Forward-pass tests for UNeXt2"
      min_lines: 50
  key_links:
    - from: "packages/viscy-models/src/viscy_models/unet/unext2.py"
      to: "viscy_models.components.stems"
      via: "from viscy_models.components.stems import UNeXt2Stem"
      pattern: "from viscy_models.components.stems import UNeXt2Stem"
    - from: "packages/viscy-models/src/viscy_models/unet/unext2.py"
      to: "viscy_models.components.heads"
      via: "from viscy_models.components.heads import PixelToVoxelHead"
      pattern: "from viscy_models.components.heads import PixelToVoxelHead"
    - from: "packages/viscy-models/src/viscy_models/unet/unext2.py"
      to: "viscy_models.components.blocks"
      via: "from viscy_models.components.blocks import UNeXt2Decoder"
      pattern: "from viscy_models.components.blocks import UNeXt2Decoder"
    - from: "packages/viscy-models/src/viscy_models/unet/__init__.py"
      to: "viscy_models.unet.unext2"
      via: "from viscy_models.unet.unext2 import UNeXt2"
      pattern: "from viscy_models.unet.unext2 import UNeXt2"
---

<objective>
Migrate UNeXt2 model class to viscy-models and create new forward-pass tests covering multiple configurations.

Purpose: UNeXt2 is the primary architecture in viscy. It currently has zero tests. This plan migrates the ~60-line wrapper class and creates comprehensive forward-pass tests.
Output: Working UNeXt2 import from viscy_models.unet with 5+ forward-pass tests.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-core-unet-models/07-RESEARCH.md
@packages/viscy-models/src/viscy_models/components/__init__.py
@packages/viscy-models/src/viscy_models/unet/__init__.py
@packages/viscy-models/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate UNeXt2 to unet/unext2.py</name>
  <files>
    packages/viscy-models/src/viscy_models/unet/unext2.py
    packages/viscy-models/src/viscy_models/unet/__init__.py
  </files>
  <action>
Create `packages/viscy-models/src/viscy_models/unet/unext2.py` containing the UNeXt2 class.

The source is on main branch at `viscy/unet/networks/unext2.py`. Copy ONLY the UNeXt2 class (the last class in that file, starting at `class UNeXt2(nn.Module):`). All other items in that file (icnr_init, _get_convnext_stage, UNeXt2Stem, etc.) were already extracted to components/ in Phase 6 and must NOT be duplicated.

Import changes (the ONLY changes from original):
- `from viscy_models.components.blocks import UNeXt2Decoder` (was inline in same file)
- `from viscy_models.components.heads import PixelToVoxelHead` (was inline in same file)
- `from viscy_models.components.stems import UNeXt2Stem` (was inline in same file)
- Keep `import timm` and `from torch import Tensor, nn`
- Keep `from typing import Literal`

Critical preservation rules (state dict compatibility):
- `self.encoder_stages` attribute name must NOT change (not self.encoder)
- `self.stem`, `self.decoder`, `self.head` attribute names preserved exactly
- `self.out_stack_depth` stored as public attribute
- `num_blocks` property returns 6 (hardcoded)
- `decoder_channels = num_channels` is an alias (NOT a copy). The subsequent `.reverse()` mutates the original list. Do NOT "fix" this to `list(num_channels)` -- preserve the exact original behavior.
- The strides array is `[2] * (len(num_channels) - 1) + [stem_kernel_size[-1]]`

The class is ~60 lines total. Add a module docstring: `"""UNeXt2 architecture composing timm encoder with custom stem, decoder, and head."""`

Then update `packages/viscy-models/src/viscy_models/unet/__init__.py` to export UNeXt2:
```python
"""UNet family architectures."""

from viscy_models.unet.unext2 import UNeXt2

__all__ = ["UNeXt2"]
```

Run `uv run --package viscy-models python -c "from viscy_models.unet import UNeXt2; print('OK')"` to verify the import works.
  </action>
  <verify>
`uv run --package viscy-models python -c "from viscy_models.unet import UNeXt2; print(UNeXt2.__name__)"` prints "UNeXt2".
`uv run --package viscy-models python -c "from viscy_models.unet.unext2 import UNeXt2; m = UNeXt2(backbone='convnextv2_atto'); print(m.num_blocks)"` prints "6".
  </verify>
  <done>UNeXt2 class is importable from viscy_models.unet and viscy_models.unet.unext2. All attribute names match original for state dict compatibility.</done>
</task>

<task type="auto">
  <name>Task 2: Create UNeXt2 forward-pass tests</name>
  <files>packages/viscy-models/tests/test_unet/test_unext2.py</files>
  <action>
Create `packages/viscy-models/tests/test_unet/test_unext2.py` with forward-pass tests covering UNET-06 requirements (multiple configurations: 2D/3D, varying channel counts).

Use the shared `device` fixture from `conftest.py`. Use `torch.no_grad()` for all forward passes to reduce memory. Use `convnextv2_atto` (3.7M params, channels [40, 80, 160, 320]) for most tests to keep them fast. Include one test with the default `convnextv2_tiny` backbone for validation.

Tests to write:

1. `test_unext2_default_forward(device)` -- Default config: convnextv2_tiny, 1ch in, 1ch out, depth=5, spatial=128x128. Assert output shape `(1, 1, 5, 128, 128)`.

2. `test_unext2_small_backbone(device)` -- convnextv2_atto backbone, 1ch in, 1ch out, depth=5, spatial=128x128. Assert output shape `(1, 1, 5, 128, 128)`.

3. `test_unext2_multichannel(device)` -- convnextv2_atto, 3ch in, 2ch out, depth=5, spatial=64x64. Assert output shape `(1, 2, 5, 64, 64)`.

4. `test_unext2_different_stack_depths(device)` -- convnextv2_atto, in_stack_depth=5, out_stack_depth=3, spatial=64x64. Assert output shape `(1, 1, 3, 64, 64)`.

5. `test_unext2_deconv_decoder(device)` -- convnextv2_atto, decoder_mode="deconv", spatial=64x64. Assert output shape `(1, 1, 5, 64, 64)`.

6. `test_unext2_stem_validation()` -- No device needed. Assert `pytest.raises(ValueError, match="not divisible")` when calling `UNeXt2(in_stack_depth=7, stem_kernel_size=(5, 4, 4))`.

Import from `viscy_models.unet import UNeXt2` (not from unext2.py directly) to verify the public API path.

Each test function should:
- Construct the model with `.to(device)`
- Create input tensor with `torch.randn(..., device=device)`
- Run forward pass inside `with torch.no_grad():`
- Assert output shape matches expected

Do NOT use parametrize -- keep each test as a separate function for clarity and easy failure diagnosis.
  </action>
  <verify>
`uv run --package viscy-models pytest packages/viscy-models/tests/test_unet/test_unext2.py -v` shows all 6 tests passing.
  </verify>
  <done>6 UNeXt2 forward-pass tests pass covering: default backbone, small backbone, multichannel I/O, different stack depths, deconv decoder mode, and stem validation error.</done>
</task>

</tasks>

<verification>
1. `uv run --package viscy-models python -c "from viscy_models.unet import UNeXt2; print('import OK')"` succeeds
2. `uv run --package viscy-models pytest packages/viscy-models/tests/test_unet/test_unext2.py -v` -- all 6 tests pass
3. `uv run --package viscy-models pytest packages/viscy-models/tests/ -v` -- all existing tests (20 from Phase 6) still pass alongside new tests
</verification>

<success_criteria>
- UNeXt2 is importable from `viscy_models.unet`
- 6 forward-pass tests cover multiple configurations (2D/3D stack depths, channel counts, backbone sizes, decoder modes)
- All 20+ existing tests continue to pass (no regression)
- State dict attribute names match original (`encoder_stages`, `stem`, `decoder`, `head`)
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-unet-models/07-01-SUMMARY.md`
</output>
