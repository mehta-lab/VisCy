---
phase: 22-batch-sampling
plan: 02
type: tdd
wave: 2
depends_on: ["22-01"]
files_modified:
  - packages/viscy-data/src/viscy_data/sampler.py
  - packages/viscy-data/tests/test_sampler.py
  - packages/viscy-data/src/viscy_data/__init__.py
autonomous: true

must_haves:
  truths:
    - "With temporal_enrichment=True, batches concentrate cells around a focal HPI with a configurable window, while still including a global fraction from all timepoints"
    - "FlexibleBatchSampler supports DDP via set_epoch() for deterministic shuffling and rank-aware iteration"
    - "Two ranks with same seed+epoch produce disjoint batch assignments that collectively cover all generated batches"
    - "FlexibleBatchSampler is importable from viscy_data (top-level package)"
  artifacts:
    - path: "packages/viscy-data/src/viscy_data/sampler.py"
      provides: "FlexibleBatchSampler with temporal enrichment and DDP support"
      exports: ["FlexibleBatchSampler"]
      min_lines: 220
    - path: "packages/viscy-data/tests/test_sampler.py"
      provides: "Complete test suite covering all 5 SAMP requirements"
      min_lines: 350
    - path: "packages/viscy-data/src/viscy_data/__init__.py"
      provides: "FlexibleBatchSampler in package-level exports and __all__"
      contains: "FlexibleBatchSampler"
  key_links:
    - from: "packages/viscy-data/src/viscy_data/__init__.py"
      to: "packages/viscy-data/src/viscy_data/sampler.py"
      via: "from viscy_data.sampler import FlexibleBatchSampler"
      pattern: "from viscy_data\\.sampler import FlexibleBatchSampler"
    - from: "packages/viscy-data/src/viscy_data/sampler.py"
      to: "valid_anchors DataFrame"
      via: "hours_post_infection column for temporal enrichment"
      pattern: "hours_post_infection"
---

<objective>
TDD implementation of temporal enrichment (SAMP-03) and DDP support (SAMP-04) for FlexibleBatchSampler, plus package-level exports.

Purpose: Complete the FlexibleBatchSampler with the remaining two sampling axes. Temporal enrichment concentrates batches around focal timepoints for hard-negative mining. DDP support ensures deterministic, rank-aware batch distribution for multi-GPU training. Package wiring makes the sampler importable as `from viscy_data import FlexibleBatchSampler`.

Output: Complete FlexibleBatchSampler satisfying all 5 SAMP requirements, full test suite, and package exports.
</objective>

<execution_context>
@/Users/eduardo.hirata/.claude/get-shit-done/workflows/execute-plan.md
@/Users/eduardo.hirata/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-batch-sampling/22-RESEARCH.md
@.planning/phases/22-batch-sampling/22-01-SUMMARY.md
@packages/viscy-data/src/viscy_data/sampler.py
@packages/viscy-data/tests/test_sampler.py
@packages/viscy-data/src/viscy_data/__init__.py
@packages/viscy-data/src/viscy_data/distributed.py
</context>

<feature>
  <name>FlexibleBatchSampler temporal enrichment + DDP + package wiring</name>
  <files>packages/viscy-data/src/viscy_data/sampler.py, packages/viscy-data/tests/test_sampler.py, packages/viscy-data/src/viscy_data/__init__.py</files>
  <behavior>
    Temporal enrichment (SAMP-03):
    - temporal_enrichment=True, temporal_window_hours=2.0, temporal_global_fraction=0.3 ->
      each batch: ~70% of indices have hours_post_infection within +/-2.0 of a randomly chosen focal HPI,
      ~30% drawn from all timepoints
    - The focal HPI is chosen per batch from unique HPIs in the selected experiment (or all experiments if not experiment_aware)
    - temporal_enrichment=False -> no temporal filtering, all indices equally likely
    - temporal_global_fraction=0.0 -> entire batch from focal window only
    - temporal_global_fraction=1.0 -> effectively no enrichment (all global)

    DDP support (SAMP-04):
    - num_replicas=2, rank=0, seed=42: yields batches [0, 2, 4, ...]
    - num_replicas=2, rank=1, seed=42: yields batches [1, 3, 5, ...]
    - rank 0 and rank 1 together cover all generated batches (disjoint interleaving)
    - set_epoch(0) and set_epoch(1) produce different batch sequences
    - set_epoch(0) twice on same instance produces identical sequence (deterministic)
    - __len__ returns math.ceil(total_batches / num_replicas)

    Package wiring:
    - from viscy_data import FlexibleBatchSampler works
    - FlexibleBatchSampler in viscy_data.__all__
  </behavior>
  <implementation>
    Extend sampler.py from Plan 01:

    1. Add _enrich_temporal(pool, rng, chosen_exp) method:
       - Get hours_post_infection values for indices in pool from self.valid_anchors
       - If chosen_exp is not None, restrict unique HPIs to that experiment's indices
       - Pick focal_hpi = rng.choice(unique_hpi_values)
       - Split pool into focal_pool (|hpi - focal| <= temporal_window_hours) and global_pool
       - n_global = int(len(pool_to_sample) * temporal_global_fraction)  -- but pool_to_sample is the desired count (n_primary or batch_size)
       - Actually: this method returns a reweighted pool. Better approach:
         n_focal = n_target - n_global where n_target is the count of indices needed
         focal_samples = rng.choice(focal_pool, size=min(n_focal, len(focal_pool)), replace=len(focal_pool) < n_focal)
         global_samples = rng.choice(global_pool, size=min(n_global, len(global_pool)), replace=len(global_pool) < n_global)
         return np.concatenate([focal_samples, global_samples])
       - Integrate into _build_one_batch between condition balancing and final sample

    2. Update _build_one_batch cascade:
       After step 6 (condition balance or random pool selection produces primary indices),
       if temporal_enrichment is True, apply _enrich_temporal to further filter/resample.

       Revised cascade order:
       a. Pick experiment (if experiment_aware)
       b. Determine n_primary and n_leak
       c. Build primary pool (experiment-restricted indices)
       d. If condition_balanced: balance within primary pool -> produces n_primary indices
          If not condition_balanced: random sample n_primary from primary pool
       e. If temporal_enrichment: apply temporal enrichment to the selected primary pool
          This replaces the flat random sample with focal+global composition
       f. If leaky: sample n_leak from other experiments
       g. Concatenate and return

       Key design: temporal_enrichment operates WITHIN the experiment/condition-filtered pool.
       It does not override experiment or condition constraints.

    3. Pre-compute temporal data at __init__:
       - self._hpi_values: np.ndarray = valid_anchors["hours_post_infection"].to_numpy()
       - Only if temporal_enrichment=True (avoid requiring the column when not needed)

    4. DDP is already embedded from Plan 01 (__iter__ generates all batches with same seed,
       then slices by rank). Verify with explicit multi-rank tests.

    5. Package wiring in __init__.py:
       - Add: from viscy_data.sampler import FlexibleBatchSampler
       - Add "FlexibleBatchSampler" to __all__ list (in the "# Utilities" section near ShardedDistributedSampler)

    Important:
    - The "hours_post_infection" column is required ONLY when temporal_enrichment=True.
      Add a validation check in __init__: if temporal_enrichment and "hours_post_infection" not in valid_anchors.columns, raise ValueError.
    - The "experiment" column is required ONLY when experiment_aware=True. Same pattern.
    - The "condition" column is required ONLY when condition_balanced=True. Same pattern.
  </implementation>
</feature>

<verification>
cd /Users/eduardo.hirata/Documents/repos/VisCy && uv run pytest packages/viscy-data/tests/test_sampler.py -v
All tests pass. No ruff lint errors: uv run ruff check packages/viscy-data/src/viscy_data/sampler.py packages/viscy-data/src/viscy_data/__init__.py

Verify package-level import:
uv run python -c "from viscy_data import FlexibleBatchSampler; print(FlexibleBatchSampler)"

Verify full viscy-data test suite still passes:
uv run pytest packages/viscy-data/tests/ -v
</verification>

<success_criteria>
- temporal_enrichment=True produces batches with ~70% focal window + ~30% global (verified statistically over many batches)
- DDP: 2 ranks with same seed produce disjoint batch interleaving covering all batches
- set_epoch changes produce different sequences; same epoch reproduces identical sequence
- FlexibleBatchSampler importable from viscy_data top-level
- All existing viscy-data tests still pass (no regressions)
- All sampler tests pass, no lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-batch-sampling/22-02-SUMMARY.md`
</output>
