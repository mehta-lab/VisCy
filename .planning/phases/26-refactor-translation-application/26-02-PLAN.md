---
phase: 26-refactor-translation-application
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - applications/translation/src/viscy_translation/engine.py
  - applications/translation/src/viscy_translation/evaluation.py
  - applications/translation/src/viscy_translation/__init__.py
  - applications/translation/tests/conftest.py
  - applications/translation/tests/test_engine.py
autonomous: true
requirements: []

must_haves:
  truths:
    - "VSUNet is importable from viscy_translation"
    - "FcmaeUNet is importable from viscy_translation"
    - "AugmentedPredictionVSUNet is importable from viscy_translation"
    - "VSUNet forward pass produces correct output shape with synthetic data"
    - "All imports use new package paths (viscy_data, viscy_models, viscy_utils, viscy_translation)"
    - "No references to old viscy.translation.* or viscy.data.* or viscy.unet.* import paths"
  artifacts:
    - path: "applications/translation/src/viscy_translation/engine.py"
      provides: "VSUNet, FcmaeUNet, AugmentedPredictionVSUNet, MaskedMSELoss LightningModules"
      exports: ["VSUNet", "FcmaeUNet", "AugmentedPredictionVSUNet", "MaskedMSELoss"]
    - path: "applications/translation/src/viscy_translation/evaluation.py"
      provides: "SegmentationMetrics2D test runner"
      exports: ["SegmentationMetrics2D"]
    - path: "applications/translation/src/viscy_translation/__init__.py"
      provides: "Top-level re-exports"
      exports: ["VSUNet", "FcmaeUNet", "AugmentedPredictionVSUNet"]
    - path: "applications/translation/tests/test_engine.py"
      provides: "Import tests, forward pass smoke tests, state dict key regression test"
  key_links:
    - from: "applications/translation/src/viscy_translation/engine.py"
      to: "viscy_models"
      via: "model architecture imports"
      pattern: "from viscy_models import"
    - from: "applications/translation/src/viscy_translation/engine.py"
      to: "viscy_utils.losses"
      via: "MixedLoss import for default loss"
      pattern: "from viscy_utils.losses import MixedLoss"
    - from: "applications/translation/src/viscy_translation/engine.py"
      to: "viscy_utils.log_images"
      via: "image logging utilities"
      pattern: "from viscy_utils.log_images import"
    - from: "applications/translation/src/viscy_translation/engine.py"
      to: "viscy_utils.evaluation.metrics"
      via: "evaluation metrics"
      pattern: "from viscy_utils.evaluation.metrics import"
    - from: "applications/translation/src/viscy_translation/__init__.py"
      to: "engine.py"
      via: "top-level re-exports"
      pattern: "from viscy_translation.engine import"
---

<objective>
Migrate the translation engine code (VSUNet, FcmaeUNet, AugmentedPredictionVSUNet, SegmentationMetrics2D) into the translation application with updated imports, and add smoke tests including a state dict key regression test.

Purpose: Completes the translation application so users can `from viscy_translation import VSUNet` and train virtual staining models using the modular architecture.
Output: Fully functional translation application with engine, evaluation module, and test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-refactor-translation-application/26-CONTEXT.md
@.planning/phases/26-refactor-translation-application/26-01-SUMMARY.md

@applications/dynaclr/src/dynaclr/__init__.py
@applications/dynaclr/tests/test_engine.py
@applications/dynaclr/tests/conftest.py

<interfaces>
<!-- Source code to migrate. Get from main branch: -->
<!-- git show main:viscy/translation/engine.py -->
<!-- git show main:viscy/translation/evaluation.py -->
<!-- git show main:viscy/translation/evaluation_metrics.py -->

From viscy_models (available exports, verify with: python -c "import viscy_models; print(dir(viscy_models))"):
```python
from viscy_models import UNeXt2, FullyConvolutionalMAE, Unet2d, Unet25d
```

From viscy_data (needed types):
```python
from viscy_data import CombinedDataModule, GPUTransformDataModule
from viscy_data._typing import Sample  # or from viscy_data.typing import Sample
```
Verify which import path works for `Sample`. Check `viscy_data.__init__.py` exports.
Also check if `SegmentationSample` is exported from viscy_data.

From viscy_utils (shared utilities, from Plan 01):
```python
from viscy_utils.log_images import detach_sample, render_images
from viscy_utils.losses import MixedLoss
from viscy_utils.evaluation.metrics import mean_average_precision, ms_ssim_25d
```

From viscy_utils.callbacks (from Plan 01):
```python
from viscy_utils.callbacks import HCSPredictionWriter
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate engine.py and evaluation.py with updated imports</name>
  <files>
    applications/translation/src/viscy_translation/engine.py
    applications/translation/src/viscy_translation/evaluation.py
    applications/translation/src/viscy_translation/__init__.py
  </files>
  <action>
**Step 1: Verify available imports from shared packages.**

Before writing any code, run these checks to confirm import paths:
```bash
python -c "from viscy_models import UNeXt2, FullyConvolutionalMAE, Unet2d, Unet25d; print('models OK')"
python -c "from viscy_data import CombinedDataModule, GPUTransformDataModule; print('data modules OK')"
python -c "from viscy_utils.log_images import detach_sample, render_images; print('log_images OK')"
python -c "from viscy_utils.losses import MixedLoss; print('MixedLoss OK')"
python -c "from viscy_utils.evaluation.metrics import mean_average_precision, ms_ssim_25d; print('metrics OK')"
```

If `Sample` or `SegmentationSample` is not directly importable from `viscy_data`, check:
```bash
python -c "from viscy_data._typing import Sample; print('Sample OK')"
python -c "from viscy_data._typing import SegmentationSample; print('SegmentationSample OK')"
```

**Step 2: Create engine.py.**

Get the source: `git show main:viscy/translation/engine.py`

Copy the entire file to `applications/translation/src/viscy_translation/engine.py` and update ALL import paths:

Old imports --> New imports:
- `from viscy.data.combined import CombinedDataModule` --> `from viscy_data import CombinedDataModule`
  (or `from viscy_data.combined import CombinedDataModule` if not top-level)
- `from viscy.data.gpu_aug import GPUTransformDataModule` --> `from viscy_data import GPUTransformDataModule`
  (or `from viscy_data.gpu_aug import GPUTransformDataModule` if not top-level)
- `from viscy.data.typing import Sample` --> find correct path from viscy_data
- `from viscy.translation.evaluation_metrics import mean_average_precision, ms_ssim_25d` --> `from viscy_utils.evaluation.metrics import mean_average_precision, ms_ssim_25d`
- `from viscy.unet.networks.fcmae import FullyConvolutionalMAE` --> `from viscy_models import FullyConvolutionalMAE`
- `from viscy.unet.networks.Unet2D import Unet2d` --> `from viscy_models import Unet2d`
- `from viscy.unet.networks.Unet25D import Unet25d` --> `from viscy_models import Unet25d`
- `from viscy.unet.networks.unext2 import UNeXt2` --> `from viscy_models import UNeXt2`
- `from viscy.utils.log_images import detach_sample, render_images` --> `from viscy_utils.log_images import detach_sample, render_images`

Keep `MixedLoss` and `MaskedMSELoss` in the engine.py file as well (they are used directly by the engine). However, ALSO import MixedLoss from viscy_utils to verify compatibility:
- Actually, per the CONTEXT decisions: "MixedLoss -> packages/viscy-utils/src/viscy_utils/losses/ (reusable reconstruction loss)". So engine.py should import it from there:
  `from viscy_utils.losses import MixedLoss`
- Remove the MixedLoss class definition from engine.py entirely.
- Keep `MaskedMSELoss` in engine.py since it's only used by FcmaeUNet (app-specific).

The `_UNET_ARCHITECTURE` dispatch dict stays in engine.py (app-level, per CONTEXT).

**Do NOT refactor the VSUNet class.** Move code as-is with only import path changes.

**Step 3: Create evaluation.py.**

Get the source: `git show main:viscy/translation/evaluation.py`

Copy to `applications/translation/src/viscy_translation/evaluation.py` and update imports:
- `from viscy.data.typing import SegmentationSample` --> find correct path from viscy_data
- `from viscy.translation.evaluation_metrics import mean_average_precision` --> `from viscy_utils.evaluation.metrics import mean_average_precision`

**Step 4: Update __init__.py with top-level re-exports.**

```python
"""Virtual staining translation application using UNet architectures."""

from viscy_translation.engine import (
    AugmentedPredictionVSUNet,
    FcmaeUNet,
    MaskedMSELoss,
    VSUNet,
)
from viscy_translation.evaluation import SegmentationMetrics2D

__all__ = [
    "AugmentedPredictionVSUNet",
    "FcmaeUNet",
    "MaskedMSELoss",
    "SegmentationMetrics2D",
    "VSUNet",
]
```
  </action>
  <verify>
    <automated>cd /hpc/mydata/alex.kalinin/VisCy && python -c "from viscy_translation import VSUNet, FcmaeUNet, AugmentedPredictionVSUNet, MaskedMSELoss, SegmentationMetrics2D; print('All imports OK')"</automated>
  </verify>
  <done>engine.py and evaluation.py migrated with all imports pointing to new package paths. VSUNet, FcmaeUNet, AugmentedPredictionVSUNet, MaskedMSELoss, SegmentationMetrics2D all importable from viscy_translation.</done>
</task>

<task type="auto">
  <name>Task 2: Create test suite with import tests, smoke tests, and state dict regression</name>
  <files>
    applications/translation/tests/conftest.py
    applications/translation/tests/test_engine.py
  </files>
  <action>
**Step 1: Create conftest.py.**

Follow the dynaclr test conftest pattern. Define synthetic data constants and any shared fixtures:

```python
"""Test fixtures for translation application tests."""

import torch
import pytest

# Synthetic data dimensions
SYNTH_B = 2       # batch size
SYNTH_C = 1       # input channels (phase)
SYNTH_OUT_C = 1   # output channels (fluorescence)
SYNTH_D = 5       # depth (z-stack)
SYNTH_H = 64      # height
SYNTH_W = 64      # width


@pytest.fixture
def synthetic_batch():
    """Create a synthetic batch dict matching the Sample type."""
    return {
        "source": torch.randn(SYNTH_B, SYNTH_C, SYNTH_D, SYNTH_H, SYNTH_W),
        "target": torch.randn(SYNTH_B, SYNTH_OUT_C, SYNTH_D, SYNTH_H, SYNTH_W),
        "index": (
            ["row/col/pos/0" for _ in range(SYNTH_B)],
            [torch.tensor(0) for _ in range(SYNTH_B)],
            [torch.tensor(0) for _ in range(SYNTH_B)],
        ),
    }
```

**Step 2: Create test_engine.py.**

**IMPORTANT:** Module-level constants from `conftest.py` (e.g., `SYNTH_B`, `SYNTH_C`) are NOT pytest fixtures â€” they require explicit `from conftest import ...` statements. This works because Plan 01 adds `[tool.pytest.ini_options] pythonpath = ["tests"]` to the translation pyproject.toml, which puts the `tests/` directory on the Python path (same pattern as dynaclr). Follow the dynaclr `test_engine.py` pattern which uses `from conftest import SYNTH_C, SYNTH_D, SYNTH_H, SYNTH_W, SimpleEncoder` at the top of the file.

The test file should have these module-level imports at the top (following the dynaclr test_engine.py pattern):
```python
"""Smoke tests for translation engine modules."""

import subprocess
from pathlib import Path

import torch
from conftest import SYNTH_B, SYNTH_C, SYNTH_D, SYNTH_H, SYNTH_W

from viscy_translation.engine import VSUNet, FcmaeUNet
```

Write the following tests:

1. **test_imports** -- verify all top-level imports work:
   ```python
   def test_imports():
       from viscy_translation import VSUNet, FcmaeUNet, AugmentedPredictionVSUNet
       from viscy_translation import MaskedMSELoss, SegmentationMetrics2D
       from viscy_utils.losses import MixedLoss
       from viscy_utils.callbacks import HCSPredictionWriter
   ```

2. **test_vsunet_init** -- verify VSUNet instantiates with UNeXt2 architecture:
   ```python
   def test_vsunet_init():
       model = VSUNet(architecture="UNeXt2", model_config={"in_channels": 1, "out_channels": 1, "in_stack_depth": 5})
       assert model.model is not None
       assert model.lr == 1e-3
   ```

3. **test_vsunet_forward** -- forward pass smoke test (uses module-level constants from conftest):
   ```python
   def test_vsunet_forward(synthetic_batch):
       model = VSUNet(architecture="UNeXt2", model_config={"in_channels": 1, "out_channels": 1, "in_stack_depth": 5})
       model.eval()
       with torch.no_grad():
           output = model(synthetic_batch["source"])
       assert output.shape[0] == SYNTH_B
       assert output.shape[1] == 1  # out_channels
   ```

4. **test_vsunet_state_dict_keys** -- state dict key regression test following the COMPAT pattern from viscy-models. This ensures checkpoint compatibility. Instantiate VSUNet with UNeXt2 architecture and verify that the state dict keys start with "model." (since VSUNet wraps the model as `self.model`). Store a snapshot of expected key prefixes:
   ```python
   def test_vsunet_state_dict_keys():
       model = VSUNet(architecture="UNeXt2", model_config={"in_channels": 1, "out_channels": 1, "in_stack_depth": 5})
       state_dict = model.state_dict()
       # All keys should start with "model." since VSUNet stores the architecture as self.model
       for key in state_dict:
           assert key.startswith("model."), f"Unexpected key prefix: {key}"
       # Verify some known keys exist (from UNeXt2 architecture)
       key_names = set(state_dict.keys())
       assert any("model." in k for k in key_names), "No model keys found"
       assert len(key_names) > 0, "Empty state dict"
   ```

5. **test_mixed_loss_from_viscy_utils** -- verify MixedLoss works as loss_function for VSUNet:
   ```python
   def test_mixed_loss_integration(synthetic_batch):
       from viscy_utils.losses import MixedLoss
       loss_fn = MixedLoss(l1_alpha=0.5, l2_alpha=0.0, ms_dssim_alpha=0.5)
       model = VSUNet(
           architecture="UNeXt2",
           model_config={"in_channels": 1, "out_channels": 1, "in_stack_depth": 5},
           loss_function=loss_fn,
       )
       assert model.loss_function is loss_fn
   ```

6. **test_fcmae_unet_init** -- verify FcmaeUNet instantiates:
   ```python
   def test_fcmae_unet_init():
       model = FcmaeUNet(model_config={"in_channels": 1, "out_channels": 1, "in_stack_depth": 5})
       assert model.fit_mask_ratio == 0.0
   ```

7. **test_no_old_imports** -- grep the entire application directory for old import paths. **IMPORTANT:** Use `Path(__file__).resolve().parents[1] / "src"` to build an absolute path to the src directory, since pytest does not guarantee `cwd` is the repo root (subprocess and Path are already imported at the module top-level):
   ```python
   def test_no_old_imports():
       src_dir = Path(__file__).resolve().parents[1] / "src"
       result = subprocess.run(
           ["grep", "-r", "from viscy\\.", str(src_dir)],
           capture_output=True, text=True
       )
       assert result.stdout == "", f"Old import paths found:\\n{result.stdout}"
   ```

Run tests with: `uv run --package viscy-translation pytest applications/translation/tests/ -v`
  </action>
  <verify>
    <automated>cd /hpc/mydata/alex.kalinin/VisCy && uv run --package viscy-translation pytest applications/translation/tests/ -v</automated>
  </verify>
  <done>Test suite passes: import tests, VSUNet/FcmaeUNet init and forward pass, state dict key regression, MixedLoss integration, no old import paths. All tests runnable via `uv run --package viscy-translation pytest`.</done>
</task>

</tasks>

<verification>
1. `python -c "from viscy_translation import VSUNet, FcmaeUNet, AugmentedPredictionVSUNet"` succeeds
2. `uv run --package viscy-translation pytest applications/translation/tests/ -v` -- all tests pass
3. `uvx ruff check applications/translation/` passes
4. `uvx ruff format --check applications/translation/` passes
5. `grep -r "from viscy\." applications/translation/src/` returns no matches (no old imports)
</verification>

<success_criteria>
- VSUNet, FcmaeUNet, AugmentedPredictionVSUNet importable from `viscy_translation` top-level
- MaskedMSELoss and SegmentationMetrics2D importable from `viscy_translation`
- All imports use new package paths (viscy_data, viscy_models, viscy_utils)
- Forward pass smoke test passes with synthetic data
- State dict key regression test ensures checkpoint compatibility
- No references to old `viscy.translation.*`, `viscy.data.*`, `viscy.unet.*`, `viscy.utils.*` import paths
- All code passes ruff check and ruff format
</success_criteria>

<output>
After completion, create `.planning/phases/26-refactor-translation-application/26-02-SUMMARY.md`
</output>
