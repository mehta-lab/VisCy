---
phase: 26-refactor-translation-application
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-utils/src/viscy_utils/callbacks/prediction_writer.py
  - packages/viscy-utils/src/viscy_utils/callbacks/__init__.py
  - packages/viscy-utils/src/viscy_utils/losses/__init__.py
  - packages/viscy-utils/src/viscy_utils/losses/mixed_loss.py
  - applications/translation/pyproject.toml
  - applications/translation/README.md
  - applications/translation/src/viscy_translation/__init__.py
  - applications/translation/src/viscy_translation/__main__.py
  - applications/translation/tests/__init__.py
  - applications/translation/examples/configs/fit.yml
  - applications/translation/examples/configs/predict.yml
  - pyproject.toml
autonomous: true
requirements: []

must_haves:
  truths:
    - "HCSPredictionWriter is importable from viscy_utils.callbacks"
    - "MixedLoss is importable from viscy_utils.losses"
    - "applications/translation/ directory exists with proper src layout"
    - "viscy-translation is registered in uv workspace sources"
    - "uv sync resolves without errors"
    - "applications/translation/README.md exists (required by hatchling build)"
    - "python -m viscy_translation --help invokes VisCyCLI"
    - "Example YAML configs exist at applications/translation/examples/configs/"
  artifacts:
    - path: "packages/viscy-utils/src/viscy_utils/callbacks/prediction_writer.py"
      provides: "HCSPredictionWriter callback for OME-Zarr prediction storage"
      exports: ["HCSPredictionWriter"]
    - path: "packages/viscy-utils/src/viscy_utils/losses/mixed_loss.py"
      provides: "MixedLoss reconstruction loss module"
      exports: ["MixedLoss"]
    - path: "applications/translation/pyproject.toml"
      provides: "Translation application package config"
      contains: "viscy-translation"
    - path: "applications/translation/README.md"
      provides: "Minimal README required by hatchling build (readme field in pyproject.toml)"
    - path: "applications/translation/src/viscy_translation/__init__.py"
      provides: "Translation package init (placeholder)"
    - path: "applications/translation/src/viscy_translation/__main__.py"
      provides: "Lightning CLI entry point for python -m viscy_translation"
    - path: "applications/translation/examples/configs/fit.yml"
      provides: "Example training config for LightningCLI"
    - path: "applications/translation/examples/configs/predict.yml"
      provides: "Example prediction config for LightningCLI"
  key_links:
    - from: "packages/viscy-utils/src/viscy_utils/callbacks/__init__.py"
      to: "prediction_writer.py"
      via: "re-export HCSPredictionWriter"
      pattern: "from viscy_utils.callbacks.prediction_writer import HCSPredictionWriter"
    - from: "pyproject.toml"
      to: "applications/translation"
      via: "uv workspace source registration"
      pattern: "viscy-translation.*workspace.*true"
    - from: "applications/translation/src/viscy_translation/__main__.py"
      to: "viscy_utils.cli"
      via: "LightningCLI entry point delegation"
      pattern: "from viscy_utils.cli import main"
---

<objective>
Extract reusable components (HCSPredictionWriter, MixedLoss) into viscy-utils shared packages, and create the translation application scaffold with proper workspace registration.

Purpose: Establishes the shared infrastructure and application skeleton that Plan 02 will populate with the migrated engine code.
Output: HCSPredictionWriter and MixedLoss importable from viscy-utils, empty translation app scaffold registered in workspace.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-refactor-translation-application/26-CONTEXT.md

@packages/viscy-utils/pyproject.toml
@packages/viscy-utils/src/viscy_utils/__init__.py
@packages/viscy-utils/src/viscy_utils/callbacks/__init__.py
@packages/viscy-utils/src/viscy_utils/evaluation/metrics.py
@applications/dynaclr/pyproject.toml
@pyproject.toml

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From viscy_utils.callbacks.__init__.py (current):
```python
from viscy_utils.callbacks.embedding_snapshot import EmbeddingSnapshotCallback
from viscy_utils.callbacks.embedding_writer import EmbeddingWriter

__all__ = ["EmbeddingSnapshotCallback", "EmbeddingWriter"]
```

From viscy_utils.__init__.py (current):
```python
from viscy_utils.log_images import detach_sample, render_images
from viscy_utils.mp_utils import get_val_stats, mp_wrapper
from viscy_utils.normalize import hist_clipping, unzscore, zscore

__all__ = [
    "detach_sample",
    "get_val_stats",
    "hist_clipping",
    "mp_wrapper",
    "render_images",
    "unzscore",
    "zscore",
]
```

From root pyproject.toml workspace config:
```toml
[tool.uv.workspace]
members = [ "packages/*", "applications/*" ]
exclude = [ "applications/dynacell" ]

[tool.uv.sources]
viscy-data = { workspace = true }
viscy-models = { workspace = true }
viscy-transforms = { workspace = true }
viscy-utils = { workspace = true }
dynaclr = { workspace = true }
airtable-utils = { workspace = true }
qc = { workspace = true }
```

From dynaclr pyproject.toml (pattern to follow):
```toml
[build-system]
build-backend = "hatchling.build"
requires = [ "hatchling", "uv-dynamic-versioning" ]

[project]
name = "dynaclr"
...
dependencies = [
  "click",
  "pytorch-metric-learning",
  "torchvision",
  "viscy-data",
  "viscy-models",
  "viscy-transforms",
  "viscy-utils",
]

[tool.hatch.build.targets.wheel]
packages = [ "src/dynaclr" ]

[tool.uv-dynamic-versioning]
vcs = "git"
style = "pep440"
pattern-prefix = "dynaclr-"
fallback-version = "0.0.0"
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract HCSPredictionWriter to viscy-utils callbacks</name>
  <files>
    packages/viscy-utils/src/viscy_utils/callbacks/prediction_writer.py
    packages/viscy-utils/src/viscy_utils/callbacks/__init__.py
  </files>
  <action>
Create `packages/viscy-utils/src/viscy_utils/callbacks/prediction_writer.py` by migrating the HCSPredictionWriter class and its helper functions from the old `viscy/translation/predict_writer.py`. The source is available via `git show main:viscy/translation/predict_writer.py`.

The file contains:
- Helper functions: `_pad_shape()`, `_resize_image()`, `_blend_in()`
- `HCSPredictionWriter(BasePredictionWriter)` class

Update imports to use the new package paths:
- `from viscy.data.hcs import HCSDataModule, Sample` --> `from viscy_data import HCSDataModule, Sample`
  (verify `HCSDataModule` and `Sample` are exported from viscy_data; if `Sample` is not directly exported, import from `viscy_data.typing` or `viscy_data._typing`)
- All other imports (iohub, lightning, numpy, torch) stay the same

Add numpy-style docstrings to the module and any functions missing them. Keep existing docstrings as-is if they're already numpy-style.

Update `packages/viscy-utils/src/viscy_utils/callbacks/__init__.py` to add the re-export:
```python
from viscy_utils.callbacks.embedding_snapshot import EmbeddingSnapshotCallback
from viscy_utils.callbacks.embedding_writer import EmbeddingWriter
from viscy_utils.callbacks.prediction_writer import HCSPredictionWriter

__all__ = ["EmbeddingSnapshotCallback", "EmbeddingWriter", "HCSPredictionWriter"]
```

**Important:** The HCSPredictionWriter imports `HCSDataModule` which is in viscy-data. viscy-utils already depends on heavy packages but does NOT currently depend on viscy-data. Check if `iohub` (used by HCSPredictionWriter for Plate, Position, etc.) is already a dependency of viscy-utils. It IS (`iohub>=0.3a2` is in viscy-utils deps). However, `HCSDataModule` and `Sample` come from viscy-data. Since HCSPredictionWriter only uses `HCSDataModule` for type annotation in `on_predict_start`, use `TYPE_CHECKING` guard:
```python
from __future__ import annotations
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from viscy_data import HCSDataModule
```
And access `dm: HCSDataModule` with string annotation or after the `__future__` import. The `Sample` type is used only in type hints too, so handle it the same way.
  </action>
  <verify>
    <automated>cd /hpc/mydata/alex.kalinin/VisCy && python -c "from viscy_utils.callbacks import HCSPredictionWriter; print('HCSPredictionWriter imported successfully')"</automated>
  </verify>
  <done>HCSPredictionWriter importable from viscy_utils.callbacks with all helper functions. No runtime dependency on viscy-data (TYPE_CHECKING only).</done>
</task>

<task type="auto">
  <name>Task 2: Extract MixedLoss to viscy-utils losses submodule</name>
  <files>
    packages/viscy-utils/src/viscy_utils/losses/__init__.py
    packages/viscy-utils/src/viscy_utils/losses/mixed_loss.py
  </files>
  <action>
Create the new `losses` submodule in viscy-utils:

1. Create `packages/viscy-utils/src/viscy_utils/losses/mixed_loss.py` containing the `MixedLoss` class extracted from `viscy/translation/engine.py` (get source via `git show main:viscy/translation/engine.py`).

The MixedLoss class:
```python
class MixedLoss(nn.Module):
    """Mixed reconstruction loss."""
```
It depends on:
- `torch`, `torch.nn`, `torch.nn.functional` (already deps of viscy-utils)
- `from viscy.translation.evaluation_metrics import ms_ssim_25d` --> change to `from viscy_utils.evaluation.metrics import ms_ssim_25d`

This is correct because `ms_ssim_25d` already exists in `packages/viscy-utils/src/viscy_utils/evaluation/metrics.py`.

Convert the docstring to numpy-style:
```python
class MixedLoss(nn.Module):
    """Mixed reconstruction loss.

    Adapted from Zhao et al, https://arxiv.org/pdf/1511.08861.pdf
    Reduces to simple distances if only one weight is non-zero.

    Parameters
    ----------
    l1_alpha : float, optional
        L1 loss weight, by default 0.5.
    l2_alpha : float, optional
        L2 loss weight, by default 0.0.
    ms_dssim_alpha : float, optional
        MS-DSSIM weight, by default 0.5.
    """
```

2. Create `packages/viscy-utils/src/viscy_utils/losses/__init__.py`:
```python
from viscy_utils.losses.mixed_loss import MixedLoss

__all__ = ["MixedLoss"]
```
  </action>
  <verify>
    <automated>cd /hpc/mydata/alex.kalinin/VisCy && python -c "from viscy_utils.losses import MixedLoss; import torch; loss = MixedLoss(); print(f'MixedLoss created: {loss}')"</automated>
  </verify>
  <done>MixedLoss importable from viscy_utils.losses, uses ms_ssim_25d from viscy_utils.evaluation.metrics internally.</done>
</task>

<task type="auto">
  <name>Task 3: Create translation application scaffold with workspace registration</name>
  <files>
    applications/translation/pyproject.toml
    applications/translation/README.md
    applications/translation/src/viscy_translation/__init__.py
    applications/translation/src/viscy_translation/__main__.py
    applications/translation/tests/__init__.py
    applications/translation/examples/configs/fit.yml
    applications/translation/examples/configs/predict.yml
    pyproject.toml
  </files>
  <action>
1. Create `applications/translation/pyproject.toml` following the dynaclr pattern exactly:

```toml
[build-system]
build-backend = "hatchling.build"
requires = [ "hatchling", "uv-dynamic-versioning" ]

[project]
name = "viscy-translation"
description = "Virtual staining translation application using UNet architectures"
readme = "README.md"
keywords = [
  "deep learning",
  "fluorescence prediction",
  "microscopy",
  "virtual staining",
]
license = "BSD-3-Clause"
authors = [ { name = "Biohub", email = "compmicro@czbiohub.org" } ]
requires-python = ">=3.11"
classifiers = [
  "Development Status :: 4 - Beta",
  "Intended Audience :: Science/Research",
  "License :: OSI Approved :: BSD License",
  "Operating System :: OS Independent",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Programming Language :: Python :: 3.14",
  "Topic :: Scientific/Engineering :: Artificial Intelligence",
  "Topic :: Scientific/Engineering :: Image Processing",
]
dynamic = [ "version" ]
dependencies = [
  "imageio",
  "monai",
  "torchmetrics",
  "torchvision",
  "viscy-data",
  "viscy-models",
  "viscy-transforms",
  "viscy-utils",
]

optional-dependencies.metrics = [
  "cellpose",
]
urls.Homepage = "https://github.com/mehta-lab/VisCy"
urls.Issues = "https://github.com/mehta-lab/VisCy/issues"
urls.Repository = "https://github.com/mehta-lab/VisCy"

[dependency-groups]
dev = [ { include-group = "test" } ]
test = [
  "pytest>=9.0.2",
  "pytest-cov>=7",
  "tensorboard",
]

[tool.hatch.version]
source = "uv-dynamic-versioning"

[tool.hatch.build.targets.wheel]
packages = [ "src/viscy_translation" ]

[tool.pytest.ini_options]
pythonpath = [ "tests" ]

[tool.uv-dynamic-versioning]
vcs = "git"
style = "pep440"
pattern-prefix = "viscy-translation-"
fallback-version = "0.0.0"
```

2. Create `applications/translation/README.md` — minimal README required by the `readme = "README.md"` field in pyproject.toml (hatchling build will fail without it):
```markdown
# viscy-translation

Virtual staining translation application using UNet architectures.

Part of the [VisCy](https://github.com/mehta-lab/VisCy) monorepo.
```

3. Create `applications/translation/src/viscy_translation/__init__.py` as a placeholder:
```python
"""Virtual staining translation application using UNet architectures."""
```

4. Create `applications/translation/src/viscy_translation/__main__.py` — Lightning CLI entry point so users can run `python -m viscy_translation fit --config fit.yml`. This delegates to the shared VisCyCLI from viscy-utils (same pattern dynaclr uses via the `viscy` console script):
```python
"""Lightning CLI entry point for the translation application.

Usage
-----
python -m viscy_translation fit --config fit.yml
python -m viscy_translation predict --config predict.yml
"""

from viscy_utils.cli import main

if __name__ == "__main__":
    main()
```

5. Create `applications/translation/tests/__init__.py` as empty file.

6. Create example YAML configs following the dynaclr examples/configs pattern.

   Create `applications/translation/examples/configs/fit.yml`:
```yaml
# Virtual staining training configuration
# Usage: python -m viscy_translation fit --config fit.yml
# See: https://lightning.ai/docs/pytorch/stable/cli/lightning_cli_advanced.html

seed_everything: 42
trainer:
  accelerator: gpu
  strategy: ddp
  devices: 4
  num_nodes: 1
  precision: 32-true
  logger:
    class_path: lightning.pytorch.loggers.TensorBoardLogger
    init_args:
      save_dir: #TODO point to the path to save the logs
      version: #TODO point to the version name
      log_graph: True
  callbacks:
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
      init_args:
        logging_interval: step
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        monitor: loss/val
        every_n_epochs: 1
        save_top_k: 4
        save_last: true
  fast_dev_run: false
  max_epochs: 100
  log_every_n_steps: 10
  enable_checkpointing: true
  inference_mode: true
  use_distributed_sampler: true
model:
  class_path: viscy_translation.engine.VSUNet
  init_args:
    architecture: UNeXt2
    model_config:
      in_channels: 1
      out_channels: 1
      in_stack_depth: 5
    lr: 0.001
data:
  class_path: viscy_data.hcs.HCSDataModule
  init_args:
    data_path: #TODO point to the path to the data
    source_channel: Phase3D
    target_channel: Fluorescence
    z_window_size: 5
    batch_size: 32
    num_workers: 8
    normalizations:
      - class_path: viscy_transforms.NormalizeSampled
        init_args:
          keys: [Phase3D]
          level: fov_statistics
          subtrahend: mean
          divisor: std
```

   Create `applications/translation/examples/configs/predict.yml`:
```yaml
# Virtual staining prediction configuration
# Usage: python -m viscy_translation predict --config predict.yml

seed_everything: 42
trainer:
  accelerator: gpu
  strategy: auto
  devices: auto
  num_nodes: 1
  precision: 32-true
  callbacks:
    - class_path: viscy_utils.callbacks.HCSPredictionWriter
      init_args:
        output_path: #TODO point to the path to save predictions
  inference_mode: true
model:
  class_path: viscy_translation.engine.VSUNet
  init_args:
    architecture: UNeXt2
    model_config:
      in_channels: 1
      out_channels: 1
      in_stack_depth: 5
data:
  class_path: viscy_data.hcs.HCSDataModule
  init_args:
    data_path: #TODO point to the path to the data
    source_channel: Phase3D
    target_channel: Fluorescence
    z_window_size: 5
    batch_size: 32
    num_workers: 8
    normalizations:
      - class_path: viscy_transforms.NormalizeSampled
        init_args:
          keys: [Phase3D]
          level: fov_statistics
          subtrahend: mean
          divisor: std
return_predictions: false
ckpt_path: #TODO point to the path to the checkpoint
```

7. Update root `pyproject.toml` to add workspace source:
   Add `viscy-translation = { workspace = true }` to `[tool.uv.sources]` section, after the `dynaclr` entry.

8. Run `uv sync` to verify the workspace resolves correctly. If it fails due to missing dependencies, troubleshoot.
  </action>
  <verify>
    <automated>cd /hpc/mydata/alex.kalinin/VisCy && python -c "import viscy_translation; print('viscy_translation package importable')" && python -m viscy_translation --help 2>&1 | head -3 && test -f applications/translation/README.md && test -f applications/translation/examples/configs/fit.yml && test -f applications/translation/examples/configs/predict.yml && uv sync --dry-run 2>&1 | tail -5</automated>
  </verify>
  <done>Translation application scaffold exists at applications/translation/ with src layout, README.md, __main__.py for LightningCLI entry point, example YAML configs, registered in uv workspace, and uv sync resolves cleanly.</done>
</task>

</tasks>

<verification>
1. `python -c "from viscy_utils.callbacks import HCSPredictionWriter"` succeeds
2. `python -c "from viscy_utils.losses import MixedLoss; import torch; loss = MixedLoss(); t = torch.randn(1,1,5,64,64); print(loss(t, t))"` succeeds and returns a scalar
3. `python -c "import viscy_translation"` succeeds
4. `python -m viscy_translation --help` prints CLI help text
5. `test -f applications/translation/README.md` succeeds
6. `test -f applications/translation/examples/configs/fit.yml && test -f applications/translation/examples/configs/predict.yml` succeeds
7. `uv sync` completes without errors
8. `uvx ruff check packages/viscy-utils/src/viscy_utils/callbacks/prediction_writer.py packages/viscy-utils/src/viscy_utils/losses/` passes
</verification>

<success_criteria>
- HCSPredictionWriter is importable from `viscy_utils.callbacks`
- MixedLoss is importable from `viscy_utils.losses` and uses `ms_ssim_25d` from `viscy_utils.evaluation.metrics`
- `applications/translation/` directory exists with `pyproject.toml`, `README.md`, `src/viscy_translation/`, `tests/`, `examples/configs/`
- `applications/translation/README.md` exists (required by `readme = "README.md"` in pyproject.toml for hatchling build)
- `applications/translation/src/viscy_translation/__main__.py` exists and delegates to `viscy_utils.cli.main`
- Example YAML configs exist at `applications/translation/examples/configs/fit.yml` and `predict.yml`
- viscy-translation is registered in root `pyproject.toml` workspace sources
- `uv sync` resolves without errors
- All new code passes `uvx ruff check` and `uvx ruff format --check`
</success_criteria>

<output>
After completion, create `.planning/phases/26-refactor-translation-application/26-01-SUMMARY.md`
</output>
