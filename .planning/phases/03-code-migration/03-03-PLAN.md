---
phase: 03-code-migration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - packages/viscy-transforms/tests/test_adjust_contrast.py
  - packages/viscy-transforms/tests/test_crop.py
  - packages/viscy-transforms/tests/test_flip.py
  - packages/viscy-transforms/tests/test_gaussian_smooth.py
  - packages/viscy-transforms/tests/test_noise.py
  - packages/viscy-transforms/tests/test_scale_intensity.py
  - packages/viscy-transforms/tests/test_transforms.py
  - packages/viscy-transforms/tests/test_zoom.py
  - packages/viscy-transforms/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "uv run --package viscy-transforms pytest passes all tests"
    - "All 8 test files migrated with updated imports"
    - "Tests import from viscy_transforms (not viscy.transforms)"
  artifacts:
    - path: "packages/viscy-transforms/tests/test_flip.py"
      provides: "Flip transform tests"
      contains: "from viscy_transforms import"
    - path: "packages/viscy-transforms/tests/test_transforms.py"
      provides: "Core transform tests"
      contains: "from viscy_transforms import"
    - path: "packages/viscy-transforms/tests/conftest.py"
      provides: "Shared pytest fixtures"
  key_links:
    - from: "tests/*.py"
      to: "viscy_transforms"
      via: "import"
      pattern: "from viscy_transforms import"
---

<objective>
Migrate all 8 test files from the original VisCy repository and run the full test suite.

Purpose: Complete the migration by bringing over tests and verifying all transforms work correctly.
This validates the code migration was successful.

Output: Passing test suite with all tests migrated to packages/viscy-transforms/tests/
</objective>

<execution_context>
@/Users/sricharan.varra/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sricharan.varra/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-migration/03-RESEARCH.md
@.planning/phases/03-code-migration/03-02-SUMMARY.md

Plan 03-02 migrated all source modules. This plan migrates tests and verifies everything works.

Per RESEARCH.md:
- 8 test files (excluding empty __init__.py)
- All tests use synthetic data (torch.rand, torch.zeros)
- No external fixtures needed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test files with updated imports</name>
  <files>
packages/viscy-transforms/tests/test_adjust_contrast.py
packages/viscy-transforms/tests/test_crop.py
packages/viscy-transforms/tests/test_flip.py
packages/viscy-transforms/tests/test_gaussian_smooth.py
packages/viscy-transforms/tests/test_noise.py
packages/viscy-transforms/tests/test_scale_intensity.py
packages/viscy-transforms/tests/test_transforms.py
packages/viscy-transforms/tests/test_zoom.py
  </files>
  <action>
Fetch and migrate all 8 test files from GitHub:

```bash
# Example for each file:
curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/tests/transforms/test_flip.py" | jq -r '.content' | base64 -d
```

For each test file:
1. Fetch content from GitHub API
2. Replace all import paths:
   - `from viscy.transforms import X` -> `from viscy_transforms import X`
   - `from viscy.transforms._module import X` -> `from viscy_transforms._module import X`
3. Write to packages/viscy-transforms/tests/

Test files to migrate:
1. test_adjust_contrast.py - Tests BatchedRandAdjustContrast(d)
2. test_crop.py - Tests BatchedCenterSpatialCrop(d), BatchedRandSpatialCrop(d)
3. test_flip.py - Tests BatchedRandFlip(d)
4. test_gaussian_smooth.py - Tests BatchedRandGaussianSmooth(d), filter3d_separable
5. test_noise.py - Tests BatchedRandGaussianNoise(d)
6. test_scale_intensity.py - Tests BatchedRandScaleIntensity(d)
7. test_transforms.py - Tests BatchedScaleIntensityRangePercentiles, Decollate
8. test_zoom.py - Tests BatchedZoom(d)

All tests use synthetic data patterns:
- torch.rand(), torch.randn() for random tensors
- torch.zeros(), torch.ones() for baseline tensors
- torch.arange() for deterministic sequences
  </action>
  <verify>
```bash
# All 8 test files exist
for f in test_adjust_contrast test_crop test_flip test_gaussian_smooth test_noise test_scale_intensity test_transforms test_zoom; do
  test -f "packages/viscy-transforms/tests/${f}.py" && echo "PASS: ${f}.py"
done

# No old viscy imports
! grep -r "from viscy\." packages/viscy-transforms/tests/*.py && echo "PASS: No old imports"

# Imports are correct
grep -l "from viscy_transforms import" packages/viscy-transforms/tests/*.py | wc -l
```
  </verify>
  <done>
- All 8 test files exist in packages/viscy-transforms/tests/
- No `from viscy.` imports remain
- All tests import from viscy_transforms
  </done>
</task>

<task type="auto">
  <name>Task 2: Create conftest.py and run test suite</name>
  <files>packages/viscy-transforms/tests/conftest.py</files>
  <action>
1. Check if original conftest.py exists in tests/transforms/:
   ```bash
   curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/tests/transforms/conftest.py" | jq -r '.content' 2>/dev/null
   ```

2. If it exists, migrate it with updated imports.
   If not, create a minimal conftest.py with common fixtures:
   ```python
   """Pytest configuration for viscy-transforms tests."""

   import pytest
   import torch


   @pytest.fixture
   def device():
       """Return available device (CUDA if available, else CPU)."""
       return torch.device("cuda" if torch.cuda.is_available() else "cpu")
   ```

3. Run the full test suite:
   ```bash
   uv run --package viscy-transforms pytest packages/viscy-transforms/tests/ -v
   ```

4. If any tests fail, investigate and fix:
   - Import errors: Check module paths
   - Missing fixtures: Add to conftest.py
   - Runtime errors: Check for missing dependencies

5. Ensure pytest-cov is available (from workspace dev dependencies)
  </action>
  <verify>
```bash
# conftest.py exists
test -f packages/viscy-transforms/tests/conftest.py && echo "PASS: conftest.py exists"

# Run tests and capture exit code
uv run --package viscy-transforms pytest packages/viscy-transforms/tests/ -v --tb=short
echo "Exit code: $?"
```
  </verify>
  <done>
- conftest.py exists with common fixtures
- `uv run --package viscy-transforms pytest` runs successfully
- All tests pass (or known issues documented)
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and cleanup</name>
  <files>packages/viscy-transforms/tests/__init__.py</files>
  <action>
1. Ensure tests/__init__.py exists (should from Phase 2, but verify)

2. Run complete verification suite:
   ```bash
   # Full import test
   uv run python -c "
   from viscy_transforms import __all__
   for name in __all__:
       getattr(__import__('viscy_transforms', fromlist=[name]), name)
   print(f'All {len(__all__)} exports verified')
   "

   # Test with coverage
   uv run --package viscy-transforms pytest packages/viscy-transforms/tests/ --cov=viscy_transforms --cov-report=term-missing
   ```

3. Run pre-commit on all test files:
   ```bash
   uvx prek --files packages/viscy-transforms/tests/*.py
   ```

4. Verify MIG-01 through MIG-05 requirements from REQUIREMENTS.md:
   - MIG-01: All transform modules migrated (16 modules)
   - MIG-02: All tests migrated (8 test files)
   - MIG-03: Import paths updated to viscy_transforms
   - MIG-04: Tests passing
   - MIG-05: No viscy/transforms/ directory exists (N/A - clean slate)
  </action>
  <verify>
```bash
# Count source modules (should be 17: 16 modules + _typing.py, excluding __init__.py and __pycache__)
ls packages/viscy-transforms/src/viscy_transforms/*.py | grep -v __init__ | wc -l

# Count test files (should be 9: 8 tests + conftest)
ls packages/viscy-transforms/tests/*.py | grep -v __init__ | wc -l

# Full test run
uv run --package viscy-transforms pytest packages/viscy-transforms/tests/ -q

# Verify no old viscy directory exists
! test -d viscy && echo "PASS: No viscy/ directory"
```
  </verify>
  <done>
- All 16 transform modules + _typing.py exist (17 source files)
- All 8 test files + conftest.py exist (9 test files)
- All tests pass
- Pre-commit passes
- MIG-01 through MIG-05 requirements satisfied
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
```bash
# 1. Complete test run with verbose output
uv run --package viscy-transforms pytest packages/viscy-transforms/tests/ -v

# 2. Verify all exports work
uv run python -c "
from viscy_transforms import *
import viscy_transforms
print(f'All {len(viscy_transforms.__all__)} transforms accessible')
"

# 3. No old imports anywhere in package
! grep -r "from viscy\." packages/viscy-transforms/ && echo "PASS: Migration complete"

# 4. Pre-commit on entire package
uvx prek --files packages/viscy-transforms/src/viscy_transforms/*.py packages/viscy-transforms/tests/*.py
```
</verification>

<success_criteria>
- 8 test files exist in packages/viscy-transforms/tests/
- conftest.py provides common fixtures
- `uv run --package viscy-transforms pytest` passes all tests
- No `from viscy.` imports in any file
- Pre-commit hooks pass on all files
- Phase 3 requirements (MIG-01 through MIG-05) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-migration/03-03-SUMMARY.md`
</output>
