---
phase: 03-code-migration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/viscy-transforms/src/viscy_transforms/_adjust_contrast.py
  - packages/viscy-transforms/src/viscy_transforms/_crop.py
  - packages/viscy-transforms/src/viscy_transforms/_decollate.py
  - packages/viscy-transforms/src/viscy_transforms/_flip.py
  - packages/viscy-transforms/src/viscy_transforms/_gaussian_smooth.py
  - packages/viscy-transforms/src/viscy_transforms/_noise.py
  - packages/viscy-transforms/src/viscy_transforms/_redef.py
  - packages/viscy-transforms/src/viscy_transforms/_scale_intensity.py
  - packages/viscy-transforms/src/viscy_transforms/_transforms.py
  - packages/viscy-transforms/src/viscy_transforms/_zoom.py
  - packages/viscy-transforms/src/viscy_transforms/batched_rand_3d_elasticd.py
  - packages/viscy-transforms/src/viscy_transforms/batched_rand_histogram_shiftd.py
  - packages/viscy-transforms/src/viscy_transforms/batched_rand_local_pixel_shufflingd.py
  - packages/viscy-transforms/src/viscy_transforms/batched_rand_sharpend.py
  - packages/viscy-transforms/src/viscy_transforms/batched_rand_zstack_shiftd.py
  - packages/viscy-transforms/src/viscy_transforms/__init__.py
autonomous: true

must_haves:
  truths:
    - "All 16 transform modules exist in packages/viscy-transforms/src/viscy_transforms/"
    - "from viscy_transforms import BatchedRandFlip works"
    - "from viscy_transforms import NormalizeSampled works"
    - "All 44 transforms listed in __all__"
  artifacts:
    - path: "packages/viscy-transforms/src/viscy_transforms/_transforms.py"
      provides: "Core mixed transforms including NormalizeSampled"
      contains: "from viscy_transforms._typing import"
    - path: "packages/viscy-transforms/src/viscy_transforms/__init__.py"
      provides: "Public API with all 44 exports"
      contains: "__all__ = ["
      min_lines: 80
  key_links:
    - from: "_transforms.py"
      to: "_typing.py"
      via: "type import"
      pattern: "from viscy_transforms._typing import"
    - from: "__init__.py"
      to: "all modules"
      via: "re-exports"
      pattern: "from viscy_transforms._"
---

<objective>
Migrate all 16 transform modules from the original VisCy repository to viscy-transforms.

Purpose: This is the core code migration - moving all transform source code from the monolith
to the independent package with updated import paths.

Output: Complete transform source code in packages/viscy-transforms/src/viscy_transforms/
with working imports at package level.
</objective>

<execution_context>
@/Users/sricharan.varra/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sricharan.varra/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-migration/03-RESEARCH.md
@.planning/phases/03-code-migration/03-01-SUMMARY.md

Plan 03-01 created _typing.py with extracted types. This plan migrates all transform modules.

Key transformation needed in each file:
- `from viscy.transforms.X import Y` -> `from viscy_transforms.X import Y`
- `from viscy.data.typing import Sample` -> `from viscy_transforms._typing import Sample`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate underscore-prefixed modules (_adjust_contrast through _zoom)</name>
  <files>
packages/viscy-transforms/src/viscy_transforms/_adjust_contrast.py
packages/viscy-transforms/src/viscy_transforms/_crop.py
packages/viscy-transforms/src/viscy_transforms/_decollate.py
packages/viscy-transforms/src/viscy_transforms/_flip.py
packages/viscy-transforms/src/viscy_transforms/_gaussian_smooth.py
packages/viscy-transforms/src/viscy_transforms/_noise.py
packages/viscy-transforms/src/viscy_transforms/_redef.py
packages/viscy-transforms/src/viscy_transforms/_scale_intensity.py
packages/viscy-transforms/src/viscy_transforms/_transforms.py
packages/viscy-transforms/src/viscy_transforms/_zoom.py
  </files>
  <action>
For each of these 10 modules, fetch from GitHub and write with updated imports:

```bash
# Pattern for each file (example for _flip.py):
curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/viscy/transforms/_flip.py" | jq -r '.content' | base64 -d > temp.py
```

After fetching each file:
1. Replace `from viscy.transforms` with `from viscy_transforms`
2. Replace `from viscy.data.typing import` with `from viscy_transforms._typing import`
3. Ensure each module has explicit `__all__`
4. Write to the package location

Files to migrate in order:
1. _adjust_contrast.py - BatchedRandAdjustContrast, BatchedRandAdjustContrastd
2. _crop.py - BatchedCenterSpatialCrop(d), BatchedRandSpatialCrop(d)
3. _decollate.py - Decollate
4. _flip.py - BatchedRandFlip, BatchedRandFlipd
5. _gaussian_smooth.py - BatchedRandGaussianSmooth(d), filter3d_separable
6. _noise.py - BatchedRandGaussianNoise(d), RandGaussianNoiseTensor(d)
7. _redef.py - 13 re-typed MONAI transforms
8. _scale_intensity.py - BatchedRandScaleIntensity(d)
9. _transforms.py - CRITICAL: uses _typing.py types (Sample, ChannelMap)
10. _zoom.py - BatchedZoom, BatchedZoomd

CRITICAL for _transforms.py:
- Change `from viscy.data.typing import ChannelMap, Sample`
- To `from viscy_transforms._typing import ChannelMap, Sample`
  </action>
  <verify>
```bash
# All 10 files exist
for f in _adjust_contrast _crop _decollate _flip _gaussian_smooth _noise _redef _scale_intensity _transforms _zoom; do
  test -f "packages/viscy-transforms/src/viscy_transforms/${f}.py" && echo "PASS: ${f}.py"
done

# No old viscy imports remain
! grep -r "from viscy\." packages/viscy-transforms/src/viscy_transforms/_*.py && echo "PASS: No old imports"

# _transforms.py uses local types
grep "from viscy_transforms._typing import" packages/viscy-transforms/src/viscy_transforms/_transforms.py && echo "PASS: _transforms uses local types"
```
  </verify>
  <done>
- All 10 underscore-prefixed modules exist
- No `from viscy.` imports remain
- _transforms.py imports from viscy_transforms._typing
- Each module has __all__ defined
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate standalone batched_rand_* modules</name>
  <files>
packages/viscy-transforms/src/viscy_transforms/batched_rand_3d_elasticd.py
packages/viscy-transforms/src/viscy_transforms/batched_rand_histogram_shiftd.py
packages/viscy-transforms/src/viscy_transforms/batched_rand_local_pixel_shufflingd.py
packages/viscy-transforms/src/viscy_transforms/batched_rand_sharpend.py
packages/viscy-transforms/src/viscy_transforms/batched_rand_zstack_shiftd.py
  </files>
  <action>
Fetch and migrate the 5 standalone batched_rand_* modules:

```bash
# Fetch each file from GitHub:
curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/viscy/transforms/batched_rand_3d_elasticd.py" | jq -r '.content' | base64 -d
# (repeat for each file)
```

These modules don't have internal viscy imports, but verify and update if needed:
1. batched_rand_3d_elasticd.py - BatchedRand3DElasticd
2. batched_rand_histogram_shiftd.py - BatchedRandHistogramShiftd
3. batched_rand_local_pixel_shufflingd.py - BatchedRandLocalPixelShufflingd
4. batched_rand_sharpend.py - BatchedRandSharpend
5. batched_rand_zstack_shiftd.py - BatchedRandZStackShiftd

For each:
- Add explicit `__all__` if missing
- Update any internal imports to viscy_transforms
  </action>
  <verify>
```bash
# All 5 files exist
for f in batched_rand_3d_elasticd batched_rand_histogram_shiftd batched_rand_local_pixel_shufflingd batched_rand_sharpend batched_rand_zstack_shiftd; do
  test -f "packages/viscy-transforms/src/viscy_transforms/${f}.py" && echo "PASS: ${f}.py"
done

# No old viscy imports
! grep -r "from viscy\." packages/viscy-transforms/src/viscy_transforms/batched_rand_*.py && echo "PASS: No old imports"
```
  </verify>
  <done>
- All 5 batched_rand_* modules exist
- No old imports remain
- Each module has __all__ defined
  </done>
</task>

<task type="auto">
  <name>Task 3: Update __init__.py with full public API</name>
  <files>packages/viscy-transforms/src/viscy_transforms/__init__.py</files>
  <action>
Update the package __init__.py to export all 44 transforms.

Based on RESEARCH.md, the full __init__.py should:

1. Import all transforms from their modules:
   - From _adjust_contrast: BatchedRandAdjustContrast, BatchedRandAdjustContrastd
   - From _crop: BatchedCenterSpatialCrop(d), BatchedRandSpatialCrop(d)
   - From _decollate: Decollate
   - From _flip: BatchedRandFlip, BatchedRandFlipd
   - From _gaussian_smooth: BatchedRandGaussianSmooth(d)
   - From _noise: BatchedRandGaussianNoise(d), RandGaussianNoiseTensor(d)
   - From _redef: 13 re-typed MONAI transforms
   - From _scale_intensity: BatchedRandScaleIntensity(d)
   - From _transforms: BatchedRandAffined, BatchedScaleIntensityRangePercentiles(d), NormalizeSampled, etc.
   - From _zoom: BatchedZoom, BatchedZoomd
   - From standalone modules: BatchedRand3DElasticd, etc.

2. Define comprehensive __all__ with all 44 public names (per RESEARCH.md)

3. Keep the existing docstring about package purpose

Use the exact __all__ list from RESEARCH.md section "Code Examples > Public API Export Pattern"
  </action>
  <verify>
```bash
# Count exports in __all__
grep -oP '__all__\s*=\s*\[' packages/viscy-transforms/src/viscy_transforms/__init__.py && \
  grep -c '"' packages/viscy-transforms/src/viscy_transforms/__init__.py | head -1

# Test key imports
uv run python -c "
from viscy_transforms import (
    BatchedRandFlip,
    BatchedRandFlipd,
    NormalizeSampled,
    StackChannelsd,
    BatchedRand3DElasticd,
    Decollate,
)
print('PASS: Key transforms importable')
"

# Test __all__ count
uv run python -c "
from viscy_transforms import __all__
print(f'__all__ has {len(__all__)} exports')
assert len(__all__) >= 40, f'Expected ~44 exports, got {len(__all__)}'
print('PASS: __all__ has sufficient exports')
"
```
  </verify>
  <done>
- __init__.py imports all transforms from their modules
- __all__ contains 44 public names
- `from viscy_transforms import X` works for all transforms
- Package import doesn't error
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
```bash
# 1. Count all module files (should be 16: 10 underscore + 5 batched_rand + __init__)
ls packages/viscy-transforms/src/viscy_transforms/*.py | wc -l

# 2. No old viscy imports anywhere
! grep -r "from viscy\." packages/viscy-transforms/src/viscy_transforms/*.py && echo "PASS: No old imports"

# 3. Full import test
uv run python -c "
import viscy_transforms
print(f'Package imports successfully')
print(f'Exports: {len(viscy_transforms.__all__)}')
"

# 4. Pre-commit on all files
uvx prek --files packages/viscy-transforms/src/viscy_transforms/*.py
```
</verification>

<success_criteria>
- 16 Python module files in src/viscy_transforms/ (excluding __pycache__)
- Zero occurrences of `from viscy.` in any source file
- `from viscy_transforms import X` works for all 44 transforms
- __all__ in __init__.py has 44 entries
- Pre-commit hooks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-migration/03-02-SUMMARY.md`
</output>
