---
phase: 03-code-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/viscy-transforms/src/viscy_transforms/_typing.py
autonomous: true

must_haves:
  truths:
    - "_typing.py exists with Sample and ChannelMap type definitions"
    - "Types can be imported: from viscy_transforms._typing import Sample, ChannelMap"
    - "Type definitions are compatible with _transforms.py usage patterns"
  artifacts:
    - path: "packages/viscy-transforms/src/viscy_transforms/_typing.py"
      provides: "Type definitions for transforms"
      contains: "class Sample"
      min_lines: 30
  key_links:
    - from: "viscy_transforms/_typing.py"
      to: "torch.Tensor"
      via: "type annotations"
      pattern: "from torch import Tensor"
---

<objective>
Extract type definitions from viscy.data.typing into a local _typing.py module.

Purpose: The _transforms.py module depends on Sample and ChannelMap types from viscy.data.typing.
Since viscy-data doesn't exist yet, we must provide these types locally to avoid import failures.

Output: A self-contained _typing.py file with all necessary type definitions.
</objective>

<execution_context>
@/Users/sricharan.varra/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sricharan.varra/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-migration/03-RESEARCH.md

Phase 2 established the package skeleton. The src/viscy_transforms/ directory exists with __init__.py and py.typed.

This plan creates the type foundation that _transforms.py will import from.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch viscy.data.typing from GitHub and create _typing.py</name>
  <files>packages/viscy-transforms/src/viscy_transforms/_typing.py</files>
  <action>
1. Fetch the original typing module from GitHub:
   ```bash
   curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/viscy/data/typing.py" | jq -r '.content' | base64 -d
   ```

2. Create _typing.py with extracted types. Based on RESEARCH.md, extract:
   - TypeVar T and OneOrSeq generic
   - HCSStackIndex NamedTuple
   - LevelNormStats TypedDict
   - ChannelNormStats TypedDict
   - NormMeta type alias
   - Sample TypedDict (the main type used by transforms)
   - ChannelMap TypedDict (used by StackChannelsd)

3. Add module docstring explaining this is extracted from viscy.data.typing.

4. Add explicit __all__ listing public types.

Do NOT include types not needed by transforms (like dataset-specific types).
Keep imports minimal: typing, torch.Tensor, typing_extensions.NotRequired.
  </action>
  <verify>
```bash
# File exists
test -f packages/viscy-transforms/src/viscy_transforms/_typing.py && echo "PASS: _typing.py exists"

# Can import types
uv run python -c "from viscy_transforms._typing import Sample, ChannelMap, OneOrSeq; print('PASS: Types importable')"

# Has __all__
grep -q "__all__" packages/viscy-transforms/src/viscy_transforms/_typing.py && echo "PASS: __all__ defined"
```
  </verify>
  <done>
- _typing.py exists at packages/viscy-transforms/src/viscy_transforms/_typing.py
- Sample type can be imported
- ChannelMap type can be imported
- OneOrSeq generic can be imported
- Module has explicit __all__
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify type compatibility with _transforms.py usage</name>
  <files>packages/viscy-transforms/src/viscy_transforms/_typing.py</files>
  <action>
1. Fetch _transforms.py from GitHub to inspect actual usage:
   ```bash
   curl -s "https://api.github.com/repos/mehta-lab/VisCy/contents/viscy/transforms/_transforms.py" | jq -r '.content' | base64 -d | head -100
   ```

2. Verify the _typing.py definitions match the usage patterns in _transforms.py:
   - Sample["source"] access pattern
   - ChannelMap["source"] access pattern
   - NormMeta type for normalization metadata
   - OneOrSeq[str] for channel names

3. If any adjustments needed, update _typing.py.

4. Run type checker on _typing.py:
   ```bash
   uv run uvx ty check packages/viscy-transforms/src/viscy_transforms/_typing.py
   ```
  </action>
  <verify>
```bash
# Type check passes
uv run uvx ty check packages/viscy-transforms/src/viscy_transforms/_typing.py

# Types are correctly defined
uv run python -c "
from viscy_transforms._typing import Sample, ChannelMap, NormMeta, OneOrSeq
from typing import get_type_hints
print('Sample fields:', Sample.__annotations__ if hasattr(Sample, '__annotations__') else 'TypedDict')
print('ChannelMap fields:', ChannelMap.__annotations__)
print('PASS: Types correctly defined')
"
```
  </verify>
  <done>
- _typing.py passes type checking
- Sample type has source, target, weight, labels, norm_meta fields
- ChannelMap type has source, target fields
- Types are compatible with _transforms.py usage
  </done>
</task>

</tasks>

<verification>
Overall plan verification:
```bash
# 1. File exists and has content
wc -l packages/viscy-transforms/src/viscy_transforms/_typing.py

# 2. All required types importable
uv run python -c "
from viscy_transforms._typing import (
    Sample, ChannelMap, NormMeta, OneOrSeq,
    HCSStackIndex, LevelNormStats, ChannelNormStats
)
print('All types imported successfully')
"

# 3. Pre-commit passes
uvx prek --files packages/viscy-transforms/src/viscy_transforms/_typing.py
```
</verification>

<success_criteria>
- _typing.py exists with ~40-60 lines of type definitions
- All 7 types (Sample, ChannelMap, NormMeta, OneOrSeq, HCSStackIndex, LevelNormStats, ChannelNormStats) importable
- Type checker passes
- Pre-commit hooks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-migration/03-01-SUMMARY.md`
</output>
